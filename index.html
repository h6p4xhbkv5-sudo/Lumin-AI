<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lumina AI — The Smartest Way to Learn</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=Space+Mono&family=Lexend:wght@300;400;600&family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
<script>
window.MathJax = {
  tex: { inlineMath: [['\\(','\\)'],['$','$']], displayMath: [['\\[','\\]'],['$$','$$']] },
  startup: { ready() { MathJax.startup.defaultReady(); } }
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<style>
/* ═══════════════════════════════════════
   CSS VARIABLES & RESET
═══════════════════════════════════════ */
:root {
  --gold: #C9A84C;
  --subj-math: #60A5FA;
  --subj-sci: #4ADE80;
  --subj-eng: #F472B6;
  --subj-hist: #FB923C;
  --subj-comp: #A78BFA;
  --subj-econ: #C9A84C;
  --subj-lang: #FBBF24;
  --subj-geo: #34D399;
  --gold-light: #E8C97A;
  --gold-dark: #9A7A2E;
  --black: #07080C;
  --bg1: #0A0C12;
  --bg2: #0F1118;
  --bg3: #151821;
  --bg4: #1C2030;
  --white: #F5F2EC;
  --muted: #8892A4;
  --border: rgba(201,168,76,0.15);
  --green: #4ADE80;
  --red: #FB7185;
  --blue: #60A5FA;
  --purple: #A78BFA;
  --orange: #FB923C;
  --pink: #F472B6;
  --radius: 12px;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
  --glow: 0 0 40px rgba(201,168,76,0.15);
  --font-body: 'DM Sans', sans-serif;
  --font-head: 'Playfair Display', serif;
  --font-mono: 'Space Mono', monospace;
}

/* ACCESSIBILITY MODES */
body.mode-dyslexia { font-family: 'Lexend', sans-serif !important; letter-spacing: 0.05em; line-height: 2; }
body.mode-dyslexia * { font-family: inherit !important; }
body.mode-adhd .content-block { border-left: 3px solid var(--gold); margin-bottom: 1.5rem; }
body.mode-adhd .step-badge { display: inline-flex !important; }
body.mode-dyscalculia .math-visual { display: block !important; }

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--font-body);
  background: var(--black);
  color: var(--white);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ═══════════════════════════════════════
   SCROLLBAR
═══════════════════════════════════════ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg1); }
::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 3px; }

/* ═══════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════ */
#nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
  background: rgba(7,8,12,0.92);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 2rem;
  height: 64px;
  display: flex; align-items: center; justify-content: space-between;
  transition: all .3s;
}
.nav-logo {
  font-family: var(--font-head);
  font-size: 1.5rem;
  font-weight: 900;
  color: var(--white);
  cursor: pointer;
}
.nav-logo span { color: var(--gold); }
.nav-links { display: flex; gap: .25rem; align-items: center; }
.nav-links a {
  color: var(--muted); font-size: .875rem; font-weight: 500;
  padding: .5rem .75rem; border-radius: 8px;
  cursor: pointer; text-decoration: none;
  transition: all .2s;
}
.nav-links a:hover, .nav-links a.active { color: var(--white); background: var(--bg4); }
.nav-right { display: flex; gap: .75rem; align-items: center; }

/* Accessibility toggles */
.a11y-bar {
  display: flex; gap: .5rem; align-items: center;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 20px; padding: .25rem .5rem;
}
.a11y-btn {
  padding: .35rem .65rem; border-radius: 12px; border: none;
  background: transparent; color: var(--muted);
  font-size: .75rem; font-weight: 600; cursor: pointer;
  transition: all .2s; white-space: nowrap;
}
.a11y-btn.on { background: var(--gold); color: var(--black); }

.btn {
  padding: .6rem 1.25rem; border-radius: 8px; font-size: .875rem;
  font-weight: 600; cursor: pointer; transition: all .2s; border: none;
}
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--white); }
.btn-outline:hover { border-color: var(--gold); color: var(--gold); }
.btn-gold { background: var(--gold); color: var(--black); }
.btn-gold:hover { background: var(--gold-light); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(201,168,76,0.3); }

/* XP Badge */
#xp-badge {
  display: none;
  align-items: center; gap: .4rem;
  background: var(--bg3); border: 1px solid var(--gold);
  border-radius: 20px; padding: .35rem .75rem;
  font-size: .8rem; font-weight: 700; color: var(--gold);
}

/* ═══════════════════════════════════════
   PAGES / ROUTING
═══════════════════════════════════════ */
.page { display: none; min-height: 100vh; padding-top: 64px; }
.page.active { display: block; }

/* ═══════════════════════════════════════
   HOME PAGE
═══════════════════════════════════════ */
#page-home {
  background: var(--black);
  overflow: hidden;
}

/* Animated background */
.hero-bg {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none; z-index: 0;
  overflow: hidden;
}
.orb {
  position: absolute; border-radius: 50%;
  filter: blur(80px); opacity: 0.12;
  animation: float 8s ease-in-out infinite;
}
.orb-1 { width: 600px; height: 600px; background: var(--gold); top: -200px; right: -100px; animation-delay: 0s; }
.orb-2 { width: 400px; height: 400px; background: var(--purple); bottom: 10%; left: -100px; animation-delay: 3s; }
.orb-3 { width: 300px; height: 300px; background: var(--blue); top: 40%; left: 40%; animation-delay: 5s; }

@keyframes float {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-30px) scale(1.05); }
}

.hero {
  position: relative; z-index: 1;
  min-height: calc(100vh - 64px);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center; padding: 4rem 2rem 2rem;
}
.hero-badge {
  display: inline-flex; align-items: center; gap: .5rem;
  background: rgba(201,168,76,0.1); border: 1px solid var(--gold);
  border-radius: 20px; padding: .4rem 1rem;
  font-size: .8rem; font-weight: 600; color: var(--gold);
  margin-bottom: 2rem;
  animation: fadeUp .6s ease both;
}
.hero h1 {
  font-family: var(--font-head);
  font-size: clamp(2.5rem, 6vw, 5rem);
  font-weight: 900; line-height: 1.1;
  margin-bottom: 1.5rem;
  animation: fadeUp .6s ease .1s both;
}
.hero h1 em { font-style: normal; color: var(--gold); }
.hero p {
  font-size: clamp(1rem, 2vw, 1.2rem);
  color: var(--muted); max-width: 600px;
  line-height: 1.7; margin-bottom: 2.5rem;
  animation: fadeUp .6s ease .2s both;
}
.hero-actions {
  display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;
  animation: fadeUp .6s ease .3s both;
}
.btn-hero-primary {
  padding: 1rem 2.5rem; border-radius: 10px;
  background: var(--gold); color: var(--black);
  font-size: 1rem; font-weight: 700; border: none;
  cursor: pointer; transition: all .3s;
  box-shadow: 0 0 30px rgba(201,168,76,0.3);
}
.btn-hero-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 40px rgba(201,168,76,0.5); }
.btn-hero-secondary {
  padding: 1rem 2.5rem; border-radius: 10px;
  background: transparent; color: var(--white);
  font-size: 1rem; font-weight: 600;
  border: 1px solid rgba(255,255,255,0.2);
  cursor: pointer; transition: all .3s;
}
.btn-hero-secondary:hover { border-color: var(--gold); color: var(--gold); }

/* Trust bar */
.trust-bar {
  display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;
  margin-top: 3rem; padding-top: 2rem;
  border-top: 1px solid var(--border);
  animation: fadeUp .6s ease .4s both;
}
.trust-item { display: flex; align-items: center; gap: .5rem; color: var(--muted); font-size: .85rem; }
.trust-item i { color: var(--gold); }

/* VIDEO SECTION */
.video-section {
  position: relative; z-index: 1;
  padding: 5rem 2rem;
  text-align: center;
}
.section-label {
  display: inline-block;
  background: rgba(201,168,76,0.1);
  border: 1px solid var(--border);
  border-radius: 20px; padding: .3rem .9rem;
  font-size: .75rem; font-weight: 700;
  color: var(--gold); letter-spacing: .1em;
  text-transform: uppercase; margin-bottom: 1rem;
}
.video-section h2 {
  font-family: var(--font-head); font-size: clamp(1.8rem, 4vw, 3rem);
  margin-bottom: 1rem;
}
.video-section p { color: var(--muted); max-width: 500px; margin: 0 auto 3rem; line-height: 1.7; }

/* Interactive video player */
.video-player {
  max-width: 900px; margin: 0 auto;
  border-radius: 20px; overflow: hidden;
  border: 1px solid var(--border);
  box-shadow: var(--shadow), var(--glow);
  background: var(--bg2);
  position: relative;
}
.video-main {
  background: var(--bg3);
  aspect-ratio: 16/9;
  position: relative;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  overflow: hidden;
}
.video-preview-content {
  text-align: center; padding: 2rem;
  position: relative; z-index: 2;
}
.video-play-btn {
  width: 80px; height: 80px;
  background: var(--gold); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; color: var(--black);
  margin: 0 auto 1.5rem;
  transition: all .3s;
  box-shadow: 0 0 40px rgba(201,168,76,0.4);
}
.video-main:hover .video-play-btn { transform: scale(1.1); box-shadow: 0 0 60px rgba(201,168,76,0.6); }
.video-preview-content h3 { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: .5rem; }
.video-preview-content p { color: var(--muted); font-size: .9rem; }

/* Video chapters */
.video-chapters {
  display: flex; gap: 0;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  overflow-x: auto;
}
.chapter-btn {
  flex: 1; min-width: 120px;
  padding: 1rem .75rem;
  background: transparent;
  border: none; border-right: 1px solid var(--border);
  color: var(--muted); font-size: .8rem;
  cursor: pointer; transition: all .2s;
  text-align: center;
}
.chapter-btn:hover, .chapter-btn.active { background: var(--bg3); color: var(--gold); }
.chapter-btn .chapter-icon { font-size: 1.2rem; margin-bottom: .25rem; display: block; }
.chapter-btn .chapter-time { font-size: .7rem; opacity: .6; }

/* Interactive question overlay */
.video-question {
  display: none;
  position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
  background: rgba(7,8,12,0.95); border: 2px solid var(--gold);
  border-radius: 16px; padding: 1.5rem 2rem;
  max-width: 600px; width: 90%;
  z-index: 10; text-align: center;
  animation: slideUp .3s ease;
}
.video-question.show { display: block; }
.video-question h4 { font-size: 1rem; margin-bottom: 1rem; color: var(--white); }
.vq-options { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-top: 1rem; }
.vq-opt {
  padding: .75rem 1rem; border-radius: 8px;
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--white); cursor: pointer;
  font-size: .875rem; transition: all .2s;
  text-align: left;
}
.vq-opt:hover { border-color: var(--gold); }
.vq-opt.correct { background: rgba(74,222,128,0.2); border-color: var(--green); color: var(--green); }
.vq-opt.wrong { background: rgba(251,113,133,0.2); border-color: var(--red); color: var(--red); }

/* FEATURES */
.features-section {
  position: relative; z-index: 1;
  padding: 5rem 2rem;
}
.features-section h2 {
  font-family: var(--font-head); font-size: clamp(1.8rem, 4vw, 3rem);
  text-align: center; margin-bottom: .75rem;
}
.features-section .sub { text-align: center; color: var(--muted); margin-bottom: 4rem; }

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem; max-width: 1200px; margin: 0 auto;
}
.feature-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 2rem;
  transition: all .3s; cursor: pointer;
  position: relative; overflow: hidden;
}
.feature-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--gold), transparent);
  opacity: 0; transition: opacity .3s;
}
.feature-card:hover { transform: translateY(-4px); border-color: rgba(201,168,76,0.3); box-shadow: var(--shadow); }
.feature-card:hover::before { opacity: 1; }
.feature-icon {
  width: 56px; height: 56px;
  border-radius: 14px; background: var(--bg4);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; margin-bottom: 1.25rem;
  border: 1px solid var(--border);
}
.feature-card h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: .5rem; }
.feature-card p { color: var(--muted); font-size: .875rem; line-height: 1.6; }
.feature-tag {
  display: inline-block; margin-top: 1rem;
  padding: .2rem .6rem; border-radius: 6px;
  font-size: .7rem; font-weight: 700;
  background: rgba(201,168,76,0.1); color: var(--gold);
  text-transform: uppercase; letter-spacing: .05em;
}

/* STATS */
.stats-section {
  position: relative; z-index: 1;
  padding: 4rem 2rem;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 2rem; max-width: 1000px; margin: 0 auto; text-align: center;
}
.stat-num {
  font-family: var(--font-head); font-size: 3rem; font-weight: 900;
  color: var(--gold); line-height: 1;
}
.stat-label { color: var(--muted); font-size: .875rem; margin-top: .5rem; }

/* SUBJECTS */
.subjects-section {
  position: relative; z-index: 1;
  padding: 5rem 2rem;
}
.subjects-section h2 {
  font-family: var(--font-head); font-size: clamp(1.8rem, 4vw, 3rem);
  text-align: center; margin-bottom: 3rem;
}
.subjects-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem; max-width: 1000px; margin: 0 auto 3rem;
}
.subject-pill {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 12px; padding: 1.25rem 1rem;
  text-align: center; cursor: pointer; transition: all .2s;
}
.subject-pill:hover { border-color: var(--gold); transform: translateY(-2px); }
.subject-pill .s-icon { font-size: 1.8rem; margin-bottom: .5rem; }
.subject-pill .s-name { font-size: .85rem; font-weight: 600; }
.subject-pill .s-level { font-size: .7rem; color: var(--gold); }

/* PRICING */
.pricing-section {
  position: relative; z-index: 1;
  padding: 5rem 2rem;
  background: var(--bg2);
}
.pricing-section h2 {
  font-family: var(--font-head); font-size: clamp(1.8rem, 4vw, 3rem);
  text-align: center; margin-bottom: 1rem;
}
.pricing-sub { text-align: center; color: var(--muted); margin-bottom: 3rem; }
.pricing-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem; max-width: 800px; margin: 0 auto;
}
.price-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 20px; padding: 2.5rem;
  position: relative; overflow: hidden;
}
.price-card.featured {
  border-color: var(--gold);
  box-shadow: var(--glow);
}
.price-card.featured::before {
  content: 'MOST POPULAR';
  position: absolute; top: 1.25rem; right: -2rem;
  background: var(--gold); color: var(--black);
  font-size: .65rem; font-weight: 800; letter-spacing: .1em;
  padding: .3rem 3rem;
  transform: rotate(35deg);
}
.price-name { font-size: .85rem; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: .1em; }
.price-amount {
  font-family: var(--font-head); font-size: 3rem; font-weight: 900;
  margin: .75rem 0 .25rem;
}
.price-amount span { font-size: 1rem; font-weight: 400; color: var(--muted); }
.price-desc { color: var(--muted); font-size: .875rem; margin-bottom: 1.5rem; }
.price-features { list-style: none; margin-bottom: 2rem; }
.price-features li {
  display: flex; align-items: center; gap: .75rem;
  padding: .6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size: .875rem; color: var(--muted);
}
.price-features li i { color: var(--gold); width: 16px; text-align: center; flex-shrink: 0; }

/* CTA */
.cta-section {
  position: relative; z-index: 1;
  padding: 6rem 2rem; text-align: center;
  background: radial-gradient(ellipse at center, rgba(201,168,76,0.08) 0%, transparent 70%);
}
.cta-section h2 {
  font-family: var(--font-head); font-size: clamp(2rem, 5vw, 4rem);
  margin-bottom: 1rem;
}
.cta-section p { color: var(--muted); max-width: 500px; margin: 0 auto 2rem; }

/* ═══════════════════════════════════════
   AUTH PAGES
═══════════════════════════════════════ */
#page-auth {
  display: none; align-items: center; justify-content: center;
  min-height: 100vh; padding: 2rem;
  background: radial-gradient(ellipse at 50% 0%, rgba(201,168,76,0.08) 0%, transparent 60%);
}
#page-auth.active { display: flex; }
.auth-box {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 24px; padding: 3rem;
  width: 100%; max-width: 480px;
  box-shadow: var(--shadow);
}
.auth-logo {
  font-family: var(--font-head); font-size: 2rem; font-weight: 900;
  text-align: center; margin-bottom: .5rem;
}
.auth-logo span { color: var(--gold); }
.auth-sub { text-align: center; color: var(--muted); font-size: .875rem; margin-bottom: 2.5rem; }
.auth-tabs {
  display: flex; background: var(--bg3); border-radius: 10px;
  padding: .25rem; margin-bottom: 2rem;
}
.auth-tab {
  flex: 1; padding: .6rem; border-radius: 8px;
  border: none; background: transparent;
  color: var(--muted); font-size: .875rem; font-weight: 600;
  cursor: pointer; transition: all .2s;
}
.auth-tab.active { background: var(--gold); color: var(--black); }
.form-group { margin-bottom: 1.25rem; }
.form-group label { display: block; font-size: .8rem; font-weight: 600; color: var(--muted); margin-bottom: .5rem; text-transform: uppercase; letter-spacing: .05em; }
.form-group input, .form-group select {
  width: 100%; padding: .875rem 1rem;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; color: var(--white);
  font-size: .925rem; font-family: var(--font-body);
  transition: border .2s;
}
.form-group input:focus, .form-group select:focus {
  outline: none; border-color: var(--gold);
}
.form-group select option { background: var(--bg3); }
.auth-step { display: none; }
.auth-step.active { display: block; }
.step-indicator {
  display: flex; gap: .5rem; justify-content: center; margin-bottom: 2rem;
}
.step-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--bg4); transition: all .3s;
}
.step-dot.active { background: var(--gold); width: 24px; border-radius: 4px; }
.difficulty-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
.diff-card {
  padding: 1rem; border-radius: 10px;
  background: var(--bg3); border: 2px solid var(--border);
  cursor: pointer; transition: all .2s; text-align: center;
}
.diff-card:hover { border-color: rgba(201,168,76,0.4); }
.diff-card.selected { border-color: var(--gold); background: rgba(201,168,76,0.08); }
.diff-card .diff-icon { font-size: 1.5rem; margin-bottom: .4rem; }
.diff-card .diff-name { font-size: .8rem; font-weight: 700; }
.diff-card .diff-desc { font-size: .7rem; color: var(--muted); margin-top: .2rem; }
.plan-options { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: 1.5rem; }
.plan-opt {
  padding: 1.25rem 1rem; border-radius: 12px;
  background: var(--bg3); border: 2px solid var(--border);
  cursor: pointer; transition: all .2s; text-align: center;
}
.plan-opt.selected { border-color: var(--gold); }
.plan-opt .plan-name { font-weight: 700; margin-bottom: .25rem; }
.plan-opt .plan-price { font-size: 1.2rem; color: var(--gold); font-weight: 800; }
.plan-opt .plan-tag { font-size: .7rem; color: var(--muted); }
.gdpr-check { display: flex; gap: .75rem; align-items: flex-start; margin-bottom: 1.5rem; }
.gdpr-check input { width: auto; margin-top: .2rem; accent-color: var(--gold); }
.gdpr-check label { font-size: .8rem; color: var(--muted); line-height: 1.5; cursor: pointer; }
.gdpr-check a { color: var(--gold); text-decoration: none; }
.btn-full { width: 100%; padding: 1rem; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; border: none; background: var(--gold); color: var(--black); transition: all .2s; margin-top: .5rem; }
.btn-full:hover { background: var(--gold-light); }
.btn-back { background: transparent; border: 1px solid var(--border); color: var(--muted); width: 100%; padding: .75rem; border-radius: 10px; cursor: pointer; font-size: .875rem; margin-top: .75rem; transition: all .2s; }
.btn-back:hover { border-color: var(--muted); color: var(--white); }
.login-form { display: none; }
.login-form.active { display: block; }

/* ═══════════════════════════════════════
   DASHBOARD LAYOUT
═══════════════════════════════════════ */
#page-dashboard {
  display: none;
  flex-direction: row;
}
#page-dashboard.active { display: flex; }

.sidebar {
  width: 260px; min-height: calc(100vh - 64px);
  background: var(--bg2); border-right: 1px solid var(--border);
  padding: 1.5rem 1rem; position: sticky; top: 64px;
  flex-shrink: 0; overflow-y: auto;
}
.sidebar-user {
  display: flex; align-items: center; gap: .75rem;
  padding: .75rem; background: var(--bg3);
  border-radius: 12px; margin-bottom: 1.5rem;
  border: 1px solid var(--border);
}
.avatar {
  width: 42px; height: 42px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; font-weight: 700; color: var(--black);
  flex-shrink: 0;
}
.sidebar-user-info .user-name { font-weight: 700; font-size: .9rem; }
.sidebar-user-info .user-plan { font-size: .75rem; color: var(--gold); }
.sidebar-xp {
  margin-bottom: 1.5rem;
  padding: .75rem; background: var(--bg3);
  border-radius: 10px; border: 1px solid var(--border);
}
.xp-header { display: flex; justify-content: space-between; font-size: .75rem; margin-bottom: .4rem; }
.xp-level { font-weight: 700; color: var(--gold); }
.xp-bar { height: 6px; background: var(--bg4); border-radius: 3px; overflow: hidden; }
.xp-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light)); border-radius: 3px; transition: width .5s ease; }
.sidebar-nav { display: flex; flex-direction: column; gap: .25rem; }
.sidebar-item {
  display: flex; align-items: center; gap: .75rem;
  padding: .75rem 1rem; border-radius: 10px;
  color: var(--muted); font-size: .875rem; font-weight: 500;
  cursor: pointer; transition: all .2s;
  text-decoration: none;
}
.sidebar-item:hover { background: var(--bg3); color: var(--white); }
.sidebar-item.active { background: rgba(201,168,76,0.1); color: var(--gold); border: 1px solid rgba(201,168,76,0.2); }
.sidebar-item i { width: 18px; text-align: center; }
.sidebar-badge {
  margin-left: auto; background: var(--gold);
  color: var(--black); border-radius: 10px;
  font-size: .65rem; font-weight: 800;
  padding: .15rem .45rem;
}
.sidebar-section-label {
  font-size: .65rem; font-weight: 700; color: var(--muted);
  text-transform: uppercase; letter-spacing: .1em;
  padding: 1rem 1rem .5rem;
}

.main-content {
  flex: 1; padding: 2rem;
  overflow-y: auto; min-height: calc(100vh - 64px);
}
.page-title {
  font-family: var(--font-head); font-size: 2rem; font-weight: 700;
  margin-bottom: .25rem;
}
.page-subtitle { color: var(--muted); font-size: .9rem; margin-bottom: 2rem; }

/* Subpages within dashboard */
.subpage { display: none; }
.subpage.active { display: block; }

/* Stat cards */
.stats-row {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem; margin-bottom: 2rem;
}
.stat-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 1.5rem;
  transition: all .2s;
}
.stat-card:hover { border-color: rgba(201,168,76,0.2); }
.stat-card-label { font-size: .75rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .05em; margin-bottom: .5rem; }
.stat-card-value { font-family: var(--font-head); font-size: 2rem; font-weight: 700; }
.stat-card-change { font-size: .75rem; color: var(--green); margin-top: .25rem; }

/* Dashboard grid */
.dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
@media(max-width:900px){ .dash-grid { grid-template-columns: 1fr; } .sidebar { display: none; } }

.card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden;
}
.card-header {
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.card-title { font-weight: 700; font-size: .95rem; }
.card-body { padding: 1.5rem; }

/* Chat widget */
.chat-messages {
  height: 320px; overflow-y: auto;
  display: flex; flex-direction: column; gap: .75rem;
  padding: 1rem 1.5rem;
}
.msg {
  max-width: 80%;
  padding: .75rem 1rem;
  border-radius: 12px; font-size: .875rem; line-height: 1.6;
  animation: msgIn .3s ease;
}
.msg.bot { background: var(--bg3); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
.msg.user { background: var(--gold); color: var(--black); align-self: flex-end; border-bottom-right-radius: 4px; font-weight: 500; }
.msg.typing span { display: inline-block; width: 6px; height: 6px; background: var(--muted); border-radius: 50%; animation: bounce .8s infinite; margin: 0 1px; }
.msg.typing span:nth-child(2) { animation-delay: .15s; }
.msg.typing span:nth-child(3) { animation-delay: .3s; }

.chat-input-row {
  display: flex; gap: .75rem; padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
}
.chat-input {
  flex: 1; padding: .75rem 1rem;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; color: var(--white);
  font-size: .875rem; font-family: var(--font-body);
  resize: none; height: 44px; line-height: 1.4;
}
.chat-input:focus { outline: none; border-color: var(--gold); }
.chat-send {
  padding: .75rem 1.25rem;
  background: var(--gold); color: var(--black);
  border: none; border-radius: 10px;
  font-weight: 700; font-size: .875rem;
  cursor: pointer; transition: all .2s;
}
.chat-send:hover { background: var(--gold-light); }

/* Progress bars */
.progress-item { margin-bottom: 1rem; }
.progress-header { display: flex; justify-content: space-between; font-size: .85rem; margin-bottom: .4rem; }
.progress-bar { height: 8px; background: var(--bg4); border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; transition: width .8s ease; }

/* Activity feed */
.activity-item {
  display: flex; align-items: center; gap: .75rem;
  padding: .75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.activity-icon {
  width: 36px; height: 36px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: .9rem; flex-shrink: 0;
}
.activity-text { font-size: .85rem; }
.activity-time { font-size: .75rem; color: var(--muted); margin-left: auto; flex-shrink: 0; }

/* ═══════════════════════════════════════
   AI TUTOR PAGE
═══════════════════════════════════════ */
.tutor-layout {
  display: grid; grid-template-columns: 220px 1fr;
  gap: 0; height: calc(100vh - 64px);
}
.tutor-subjects {
  background: var(--bg3); border-right: 1px solid var(--border);
  padding: 1.5rem 1rem; overflow-y: auto;
}
.tutor-subjects h4 { font-size: .75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .1em; margin-bottom: 1rem; }
.subj-btn {
  display: flex; align-items: center; gap: .6rem;
  width: 100%; padding: .7rem .9rem;
  border-radius: 8px; border: 1px solid transparent;
  background: transparent; color: var(--muted);
  font-size: .85rem; cursor: pointer; transition: all .2s;
  text-align: left; margin-bottom: .25rem;
}
.subj-btn:hover { background: var(--bg4); color: var(--white); }
.subj-btn.active { background: rgba(201,168,76,0.1); color: var(--gold); border-color: rgba(201,168,76,0.2); }

.tutor-chat {
  display: flex; flex-direction: column;
  height: 100%;
}
.tutor-header {
  padding: 1.25rem 2rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: var(--bg2);
}
.tutor-header h3 { font-size: 1.1rem; font-weight: 700; }
.tutor-header p { font-size: .8rem; color: var(--muted); }
.quick-actions { display: flex; gap: .5rem; flex-wrap: wrap; padding: 1rem 2rem; border-bottom: 1px solid var(--border); background: var(--bg2); }
.quick-btn {
  padding: .4rem .9rem; border-radius: 20px;
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--muted); font-size: .8rem;
  cursor: pointer; transition: all .2s;
}
.quick-btn:hover { border-color: var(--gold); color: var(--gold); }
.tutor-messages {
  flex: 1; overflow-y: auto;
  padding: 1.5rem 2rem; display: flex; flex-direction: column; gap: 1rem;
}
.tutor-input-area {
  padding: 1.5rem 2rem;
  border-top: 1px solid var(--border);
  background: var(--bg2);
}
.tutor-input-row {
  display: flex; gap: .75rem; align-items: flex-end;
}
.tutor-input {
  flex: 1; padding: .875rem 1rem;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; color: var(--white);
  font-family: var(--font-body); font-size: .925rem;
  resize: none; min-height: 52px; max-height: 150px;
  transition: border .2s; line-height: 1.5;
}
.tutor-input:focus { outline: none; border-color: var(--gold); }
.tutor-send {
  padding: .875rem 1.5rem;
  background: var(--gold); color: var(--black);
  border: none; border-radius: 12px;
  font-weight: 700; cursor: pointer; transition: all .2s;
  font-size: .9rem;
}
.tutor-send:hover { background: var(--gold-light); transform: scale(1.02); }
.tts-btn {
  padding: .875rem; background: var(--bg3);
  border: 1px solid var(--border); border-radius: 12px;
  color: var(--muted); cursor: pointer; transition: all .2s;
}
.tts-btn:hover { border-color: var(--gold); color: var(--gold); }
.tts-btn.active { background: rgba(74,222,128,0.1); border-color: var(--green); color: var(--green); }

/* ADHD step formatting */
.step-badge {
  display: none;
  background: var(--gold); color: var(--black);
  border-radius: 4px; font-size: .7rem; font-weight: 800;
  padding: .1rem .4rem; margin-right: .4rem;
}
.adhd-break {
  display: none;
  background: rgba(74,222,128,0.1); border: 1px solid var(--green);
  border-radius: 10px; padding: .75rem 1rem;
  color: var(--green); font-size: .85rem; text-align: center;
  margin: .5rem 0;
}
body.mode-adhd .adhd-break { display: block; }

/* Dyscalculia calculator */
#calc-overlay {
  display: none;
  position: fixed; bottom: 80px; right: 20px;
  background: var(--bg2); border: 1px solid var(--gold);
  border-radius: 20px; padding: 1.5rem;
  z-index: 999; width: 300px;
  box-shadow: var(--shadow), var(--glow);
}
#calc-overlay.show { display: block; }
.calc-title { font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; }
.calc-visual {
  background: var(--bg3); border-radius: 10px; padding: 1rem;
  font-size: 1.2rem; text-align: center; min-height: 60px;
  margin-bottom: 1rem; border: 1px solid var(--border);
  font-family: var(--font-mono);
}
.calc-btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: .4rem; }
.calc-key {
  padding: .75rem; border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg3); color: var(--white);
  font-size: .9rem; font-weight: 600; cursor: pointer;
  transition: all .2s; font-family: var(--font-mono);
}
.calc-key:hover { background: var(--bg4); border-color: var(--gold); }
.calc-key.op { color: var(--gold); }
.calc-key.eq { background: var(--gold); color: var(--black); border-color: var(--gold); }
.calc-key.eq:hover { background: var(--gold-light); }
.calc-number-line {
  margin-top: 1rem; overflow-x: auto;
  padding: .5rem 0;
}
.number-line {
  display: flex; align-items: center;
  gap: 0; white-space: nowrap;
}
.nl-num {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  border: 2px solid var(--border); font-size: .75rem;
  flex-shrink: 0; transition: all .3s;
  font-family: var(--font-mono);
}
.nl-num.highlight { background: var(--gold); color: var(--black); border-color: var(--gold); transform: scale(1.2); }
.nl-line { width: 20px; height: 2px; background: var(--border); flex-shrink: 0; }

/* ═══════════════════════════════════════
   QUESTIONS PAGE
═══════════════════════════════════════ */
.questions-layout { max-width: 800px; margin: 0 auto; }
.form-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 2rem;
  margin-bottom: 2rem;
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.gen-output {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 2rem;
  display: none;
}
.gen-output.show { display: block; }
.question-block {
  padding: 1.5rem; background: var(--bg3);
  border-radius: 10px; margin-bottom: 1.25rem;
  border: 1px solid var(--border);
}
.question-num {
  font-size: .75rem; font-weight: 700; color: var(--gold);
  text-transform: uppercase; margin-bottom: .5rem;
}
.question-text { font-size: .95rem; line-height: 1.7; margin-bottom: 1rem; }
.marks-badge {
  display: inline-block; background: rgba(201,168,76,0.1);
  color: var(--gold); border-radius: 6px;
  font-size: .75rem; font-weight: 700; padding: .2rem .6rem;
}
.answer-space {
  min-height: 80px; background: var(--bg4);
  border: 1px dashed var(--border); border-radius: 8px;
  padding: 1rem; margin-top: .75rem; color: var(--muted);
  font-size: .85rem;
}

/* ═══════════════════════════════════════
   PROGRESS PAGE
═══════════════════════════════════════ */
.heatmap {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 4px; margin-top: 1rem;
}
.heat-cell {
  aspect-ratio: 1; border-radius: 4px;
  background: var(--bg4); transition: all .2s; cursor: pointer;
  position: relative;
}
.heat-cell.l1 { background: rgba(201,168,76,0.2); }
.heat-cell.l2 { background: rgba(201,168,76,0.4); }
.heat-cell.l3 { background: rgba(201,168,76,0.7); }
.heat-cell.l4 { background: var(--gold); }
.heat-cell:hover::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%);
  background: var(--bg3); border: 1px solid var(--border);
  padding: .25rem .5rem; border-radius: 6px;
  font-size: .7rem; white-space: nowrap; z-index: 10;
}
.achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; }
.ach-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 1rem; text-align: center;
  transition: all .2s;
}
.ach-card.earned { border-color: rgba(201,168,76,0.4); }
.ach-card.locked { opacity: .4; }
.ach-icon { font-size: 2rem; margin-bottom: .5rem; }
.ach-name { font-size: .75rem; font-weight: 700; }
.ach-desc { font-size: .65rem; color: var(--muted); margin-top: .2rem; }

/* ═══════════════════════════════════════
   STRENGTHS PAGE
═══════════════════════════════════════ */
.strengths-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.strength-item, .weakness-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: .875rem 1rem; background: var(--bg3);
  border-radius: 8px; margin-bottom: .5rem; border: 1px solid var(--border);
}
.strength-item { border-left: 3px solid var(--green); }
.weakness-item { border-left: 3px solid var(--red); }
.sw-topic { font-size: .875rem; font-weight: 600; }
.sw-pct { font-size: .875rem; font-weight: 800; }
.sw-pct.good { color: var(--green); }
.sw-pct.bad { color: var(--red); }

/* ═══════════════════════════════════════
   ASSIGNMENTS PAGE
═══════════════════════════════════════ */
.assign-tabs { display: flex; gap: .5rem; margin-bottom: 2rem; }
.assign-tab {
  padding: .6rem 1.25rem; border-radius: 8px;
  border: 1px solid var(--border); background: transparent;
  color: var(--muted); font-weight: 600; cursor: pointer; transition: all .2s;
}
.assign-tab.active { background: var(--gold); color: var(--black); border-color: var(--gold); }
.assign-view { display: none; }
.assign-view.active { display: block; }
.assign-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;
  transition: all .2s;
}
.assign-card:hover { border-color: rgba(201,168,76,0.3); }
.assign-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .75rem; }
.assign-title { font-weight: 700; }
.assign-meta { font-size: .8rem; color: var(--muted); margin-bottom: 1rem; }
.status-badge {
  padding: .25rem .75rem; border-radius: 20px;
  font-size: .75rem; font-weight: 700;
}
.status-new { background: rgba(96,165,250,0.15); color: var(--blue); }
.status-due { background: rgba(251,146,60,0.15); color: var(--orange); }
.status-done { background: rgba(74,222,128,0.15); color: var(--green); }

/* ═══════════════════════════════════════
   SETTINGS PAGE
═══════════════════════════════════════ */
.settings-section { margin-bottom: 2.5rem; }
.settings-section h3 { font-size: 1rem; font-weight: 700; margin-bottom: 1.25rem; padding-bottom: .75rem; border-bottom: 1px solid var(--border); }
.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.setting-info h4 { font-size: .9rem; font-weight: 600; }
.setting-info p { font-size: .8rem; color: var(--muted); margin-top: .2rem; }
.toggle {
  width: 48px; height: 26px; background: var(--bg4);
  border-radius: 13px; cursor: pointer; position: relative;
  transition: background .3s; border: 1px solid var(--border);
}
.toggle.on { background: var(--gold); border-color: var(--gold); }
.toggle::after {
  content: ''; position: absolute;
  width: 20px; height: 20px; background: white;
  border-radius: 50%; top: 2px; left: 2px;
  transition: transform .3s;
}
.toggle.on::after { transform: translateX(22px); }
.a11y-full-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 1.25rem;
  margin-bottom: 1rem;
}
.a11y-full-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
.a11y-full-header h4 { font-weight: 700; display: flex; align-items: center; gap: .5rem; }
.a11y-desc { font-size: .8rem; color: var(--muted); line-height: 1.5; }

/* ═══════════════════════════════════════
   TOAST
═══════════════════════════════════════ */
#toast {
  position: fixed; bottom: 2rem; right: 2rem;
  background: var(--bg3); border: 1px solid var(--gold);
  border-radius: 12px; padding: 1rem 1.5rem;
  color: var(--white); font-size: .875rem; font-weight: 500;
  z-index: 9999; opacity: 0; transform: translateY(10px);
  transition: all .3s; pointer-events: none; max-width: 300px;
}
#toast.show { opacity: 1; transform: translateY(0); }

/* XP Popup */
#xp-popup {
  position: fixed; top: 80px; right: 2rem;
  background: var(--gold); color: var(--black);
  border-radius: 12px; padding: .75rem 1.25rem;
  font-weight: 800; font-size: .9rem;
  z-index: 9998; opacity: 0; transform: translateY(-10px);
  transition: all .3s; pointer-events: none;
}
#xp-popup.show { opacity: 1; transform: translateY(0); }

/* ═══════════════════════════════════════
   PRIVACY PAGE
═══════════════════════════════════════ */
#page-privacy { padding-top: 64px; }
.privacy-body { max-width: 800px; margin: 0 auto; padding: 4rem 2rem; }
.privacy-body h1 { font-family: var(--font-head); font-size: 2.5rem; margin-bottom: 2rem; }
.privacy-body h2 { font-family: var(--font-head); font-size: 1.4rem; margin: 2rem 0 .75rem; color: var(--gold); }
.privacy-body p, .privacy-body li { color: var(--muted); line-height: 1.8; margin-bottom: .75rem; }

/* Cookie banner */
#cookie-banner {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg2); border-top: 1px solid var(--border);
  padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
  gap: 1rem; z-index: 999; flex-wrap: wrap;
}
.cookie-text { font-size: .85rem; color: var(--muted); flex: 1; min-width: 200px; }
.cookie-text a { color: var(--gold); text-decoration: none; }
.cookie-btns { display: flex; gap: .75rem; }

/* ═══════════════════════════════════════
   ANIMATIONS
═══════════════════════════════════════ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
@keyframes bounce { 0%,80%,100% { transform: scale(1); } 40% { transform: scale(1.4); } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

.loading {
  background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px; color: transparent;
}

/* Subject colors */
.subj-math { color: #60A5FA; }
.subj-sci { color: #4ADE80; }
.subj-eng { color: #F472B6; }
.subj-hist { color: #FB923C; }
.subj-geo { color: #34D399; }
.subj-comp { color: #A78BFA; }
.subj-lang { color: #FBBF24; }
.subj-econ { color: #C9A84C; }

.fw700 { font-weight: 700; }
.text-gold { color: var(--gold); }
.text-muted { color: var(--muted); }
.mt1 { margin-top: 1rem; }
.mb1 { margin-bottom: 1rem; }
.flex { display: flex; }
.gap { gap: .75rem; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }

/* ═══════════════════════════════════════
   SUBJECT COLOUR THEMES
═══════════════════════════════════════ */
.theme-math { --subject-color: #60A5FA; }
.theme-sci  { --subject-color: #4ADE80; }
.theme-eng  { --subject-color: #F472B6; }
.theme-hist { --subject-color: #FB923C; }
.theme-comp { --subject-color: #A78BFA; }
.theme-econ { --subject-color: #C9A84C; }
.theme-lang { --subject-color: #FBBF24; }
.theme-geo  { --subject-color: #34D399; }

.tutor-chat { --subject-color: #60A5FA; }
.tutor-chat .tutor-header { border-bottom: 2px solid var(--subject-color, var(--gold)); }
.tutor-chat .tutor-send { background: var(--subject-color, var(--gold)); color: #000; }
.tutor-chat .msg.user { background: var(--subject-color, var(--gold)); }
.tutor-chat .quick-btn:hover { border-color: var(--subject-color, var(--gold)); color: var(--subject-color, var(--gold)); }
.subj-indicator {
  display: inline-block; width: 10px; height: 10px;
  border-radius: 50%; margin-right: .4rem;
  background: var(--subject-color, var(--gold));
}

/* ═══════════════════════════════════════
   GEOMETRY CANVAS
═══════════════════════════════════════ */
#geo-panel {
  display: none;
  position: fixed; top: 64px; right: 0; bottom: 0;
  width: 420px; background: var(--bg2);
  border-left: 1px solid var(--border);
  z-index: 500; flex-direction: column;
  box-shadow: -8px 0 32px rgba(0,0,0,0.5);
}
#geo-panel.show { display: flex; }
.geo-toolbar {
  display: flex; gap: .4rem; flex-wrap: wrap;
  padding: .75rem 1rem;
  border-bottom: 1px solid var(--border);
  background: var(--bg3);
}
.geo-tool {
  padding: .4rem .75rem; border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg4); color: var(--muted);
  font-size: .78rem; cursor: pointer; transition: all .2s;
}
.geo-tool:hover { border-color: var(--gold); color: var(--gold); }
.geo-tool.active { background: var(--gold); color: var(--black); border-color: var(--gold); }
#geo-canvas {
  flex: 1; cursor: crosshair;
  background: radial-gradient(circle at 50% 50%, #141924 0%, #0A0C12 100%);
}
.geo-info {
  padding: .75rem 1rem; background: var(--bg3);
  border-top: 1px solid var(--border);
  font-size: .8rem; color: var(--muted); min-height: 60px;
}
.geo-measurement {
  display: inline-block; background: rgba(201,168,76,0.15);
  border: 1px solid var(--gold); border-radius: 6px;
  padding: .2rem .5rem; font-size: .75rem; color: var(--gold);
  margin: .2rem;
}

/* ═══════════════════════════════════════
   SPACED REPETITION SYSTEM
═══════════════════════════════════════ */
.sr-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 16px; padding: 2rem;
  text-align: center; cursor: pointer;
  transition: all .3s; min-height: 200px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  position: relative; overflow: hidden;
}
.sr-card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(201,168,76,0.05));
}
.sr-card .sr-subject-tag {
  position: absolute; top: 1rem; right: 1rem;
  padding: .2rem .6rem; border-radius: 6px;
  font-size: .7rem; font-weight: 700;
  background: rgba(201,168,76,0.1); color: var(--gold);
}
.sr-question { font-size: 1.1rem; line-height: 1.6; margin-bottom: 1rem; }
.sr-answer {
  display: none; color: var(--green); font-size: 1rem;
  line-height: 1.6; padding: 1rem; background: rgba(74,222,128,0.1);
  border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);
  margin-top: .5rem;
}
.sr-answer.show { display: block; }
.sr-rating { display: none; gap: .75rem; margin-top: 1rem; }
.sr-rating.show { display: flex; }
.sr-rate-btn {
  flex: 1; padding: .75rem; border-radius: 10px;
  border: none; font-weight: 700; cursor: pointer; transition: all .2s;
}
.sr-rate-easy { background: rgba(74,222,128,0.2); color: var(--green); border: 1px solid rgba(74,222,128,0.4); }
.sr-rate-ok { background: rgba(251,146,60,0.2); color: var(--orange); border: 1px solid rgba(251,146,60,0.4); }
.sr-rate-hard { background: rgba(251,113,133,0.2); color: var(--red); border: 1px solid rgba(251,113,133,0.4); }
.sr-rate-btn:hover { transform: translateY(-2px); }
.sr-next-info { font-size: .75rem; color: var(--muted); margin-top: .5rem; }

/* ═══════════════════════════════════════
   COLOURFUL SUBJECT CARDS
═══════════════════════════════════════ */
.subject-pill { transition: all .3s; position: relative; overflow: hidden; }
.subject-pill::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 3px; opacity: 0; transition: opacity .3s;
}
.subject-pill:hover::after { opacity: 1; }
.sp-math::after { background: var(--subj-math); }
.sp-sci::after  { background: var(--subj-sci); }
.sp-eng::after  { background: var(--subj-eng); }
.sp-hist::after { background: var(--subj-hist); }
.sp-comp::after { background: var(--subj-comp); }
.sp-econ::after { background: var(--subj-econ); }
.sp-lang::after { background: var(--subj-lang); }
.sp-geo::after  { background: var(--subj-geo); }

/* ═══════════════════════════════════════
   MATH RENDERED BLOCKS
═══════════════════════════════════════ */
.math-block {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; padding: 1rem 1.5rem;
  margin: .75rem 0; text-align: center; font-size: 1.1rem;
  border-left: 3px solid var(--blue);
  overflow-x: auto;
}
.math-step {
  display: flex; align-items: center; gap: 1rem;
  padding: .5rem .75rem; border-radius: 8px;
  margin: .4rem 0; background: var(--bg4);
}
.math-step-num {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--gold); color: var(--black);
  font-size: .75rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.math-step-op { color: var(--gold); font-weight: 700; font-family: var(--font-mono); }

/* ═══════════════════════════════════════
   MOLECULE VIEWER
═══════════════════════════════════════ */
#molecule-panel {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem;
  display: none;
}
#molecule-panel.show { display: block; }
#molecule-canvas {
  border-radius: 10px; background: #0A0C12;
  border: 1px solid var(--border); cursor: grab;
}
.molecule-atoms {
  display: flex; flex-wrap: wrap; gap: .5rem; margin-top: 1rem;
}
.atom-btn {
  width: 44px; height: 44px; border-radius: 50%;
  border: 2px solid transparent; font-size: .8rem; font-weight: 800;
  cursor: pointer; transition: all .2s; color: white;
}
.atom-btn:hover { transform: scale(1.15); }

/* ═══════════════════════════════════════
   FORCE DIAGRAM
═══════════════════════════════════════ */
#force-panel {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem;
  display: none;
}
#force-panel.show { display: block; }
.force-scenario {
  display: flex; gap: .5rem; flex-wrap: wrap; margin-bottom: 1rem;
}
.force-scene-btn {
  padding: .4rem .9rem; border-radius: 8px;
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--muted); font-size: .8rem; cursor: pointer; transition: all .2s;
}
.force-scene-btn.active { background: rgba(96,165,250,0.2); border-color: var(--blue); color: var(--blue); }
#force-canvas {
  border-radius: 10px; background: #0A0C12;
  border: 1px solid var(--border); width: 100%;
}

/* ═══════════════════════════════════════
   JOYFUL HOMEPAGE ENHANCEMENTS
═══════════════════════════════════════ */
.floating-emoji {
  position: absolute; font-size: 2rem;
  animation: floatEmoji 6s ease-in-out infinite;
  pointer-events: none; opacity: 0.6;
  user-select: none;
}
@keyframes floatEmoji {
  0%,100% { transform: translateY(0) rotate(-5deg); }
  50% { transform: translateY(-20px) rotate(5deg); }
}
.feature-card { cursor: pointer; }
.feature-card:hover .feature-icon { transform: scale(1.2) rotate(-5deg); transition: transform .3s; }

/* Colourful feature cards */
.fc-blue { border-top: 3px solid var(--blue) !important; }
.fc-green { border-top: 3px solid var(--green) !important; }
.fc-pink { border-top: 3px solid var(--pink) !important; }
.fc-orange { border-top: 3px solid var(--orange) !important; }
.fc-purple { border-top: 3px solid var(--purple) !important; }
.fc-gold { border-top: 3px solid var(--gold) !important; }

.feature-card.fc-blue .feature-icon { background: rgba(96,165,250,0.15); }
.feature-card.fc-green .feature-icon { background: rgba(74,222,128,0.15); }
.feature-card.fc-pink .feature-icon { background: rgba(244,114,182,0.15); }
.feature-card.fc-orange .feature-icon { background: rgba(251,146,60,0.15); }
.feature-card.fc-purple .feature-icon { background: rgba(167,139,250,0.15); }
.feature-card.fc-gold .feature-icon { background: rgba(201,168,76,0.15); }

/* Geo panel toggle button */
.geo-toggle-btn {
  position: fixed; right: 1rem; bottom: 5rem;
  background: var(--blue); color: white;
  border: none; border-radius: 50%; width: 52px; height: 52px;
  font-size: 1.3rem; cursor: pointer; z-index: 499;
  box-shadow: 0 4px 20px rgba(96,165,250,0.4);
  display: none; align-items: center; justify-content: center;
  transition: all .2s;
}
.geo-toggle-btn:hover { transform: scale(1.1); }
.geo-toggle-btn.show { display: flex; }

/* Feedback floating button */
#feedback-btn {
  position: fixed; right: 1rem; bottom: 1rem;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 20px; padding: .5rem 1rem;
  font-size: .8rem; color: var(--muted); cursor: pointer;
  z-index: 499; transition: all .2s;
}
#feedback-btn:hover { border-color: var(--gold); color: var(--gold); }

/* SR floating btn */
.sr-float-btn {
  position: fixed; right: 1rem; bottom: 3.5rem;
  background: var(--purple); color: white;
  border: none; border-radius: 50%; width: 52px; height: 52px;
  font-size: 1.2rem; cursor: pointer; z-index: 498;
  box-shadow: 0 4px 20px rgba(167,139,250,0.4);
  display: none; align-items: center; justify-content: center;
}
.sr-float-btn.show { display: flex; }


/* ═══════════════════════════════════════
   MOBILE BOTTOM NAV
═══════════════════════════════════════ */
#mobile-nav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 900;
  background: rgba(10,12,18,0.97);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(20px);
  padding: .5rem 0 calc(.5rem + env(safe-area-inset-bottom));
}
.mob-nav-grid {
  display: grid; grid-template-columns: repeat(5, 1fr);
}
.mob-nav-btn {
  display: flex; flex-direction: column; align-items: center;
  gap: .2rem; padding: .5rem .25rem;
  background: none; border: none; color: var(--muted);
  font-size: .6rem; font-weight: 600; cursor: pointer;
  transition: all .2s;
}
.mob-nav-btn i { font-size: 1.2rem; }
.mob-nav-btn.active { color: var(--gold); }
.mob-nav-btn.active i { 
  filter: drop-shadow(0 0 6px rgba(201,168,76,0.6));
}
@media(max-width: 768px) {
  #mobile-nav { display: block; }
  .sidebar { display: none !important; }
  #page-dashboard.active { padding-bottom: 70px; }
  .main-content { padding: 1rem; }
  .tutor-layout { grid-template-columns: 1fr !important; }
  .tutor-subjects { display: none; }
  #nav .nav-links { display: none !important; }
  .a11y-bar { display: none !important; }
  #xp-badge { display: none !important; }
  #auth-buttons .btn-outline { display: none; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .dash-grid { grid-template-columns: 1fr !important; }
  .form-row { grid-template-columns: 1fr !important; }
  .strengths-grid { grid-template-columns: 1fr !important; }
  #geo-panel { width: 100vw !important; right: 0; left: 0; }
  #molecule-panel, #force-diagram-panel { width: 95vw !important; left: 2.5vw !important; transform: none !important; }
  .pricing-grid { grid-template-columns: 1fr; }
  .hero h1 { font-size: 2rem; }
  .auth-box { padding: 1.5rem; margin: 1rem; }
  .difficulty-grid { grid-template-columns: 1fr 1fr; }
}

/* ═══════════════════════════════════════
   POMODORO TIMER
═══════════════════════════════════════ */
#pomodoro-widget {
  position: fixed; top: 72px; right: 1rem; z-index: 800;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 16px; padding: 1rem 1.25rem;
  min-width: 200px; display: none;
  box-shadow: var(--shadow);
  animation: fadeUp .3s ease;
}
#pomodoro-widget.show { display: block; }
.pom-label { font-size: .7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .1em; margin-bottom: .5rem; }
.pom-time {
  font-family: var(--font-mono); font-size: 2.5rem; font-weight: 700;
  text-align: center; line-height: 1; margin-bottom: .75rem;
  color: var(--white); transition: color .3s;
}
.pom-time.break { color: var(--green); }
.pom-time.warning { color: var(--orange); animation: pulse 1s infinite; }
.pom-ring {
  width: 80px; height: 80px; border-radius: 50%;
  border: 4px solid var(--bg4);
  margin: 0 auto .75rem;
  position: relative; display: flex;
  align-items: center; justify-content: center;
}
.pom-ring svg { position: absolute; top: -4px; left: -4px; transform: rotate(-90deg); }
.pom-ring circle { transition: stroke-dashoffset .5s ease; }
.pom-phase { font-size: .75rem; text-align: center; color: var(--muted); margin-bottom: .75rem; }
.pom-controls { display: flex; gap: .5rem; justify-content: center; }
.pom-btn {
  padding: .4rem .9rem; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg3);
  color: var(--white); font-size: .8rem; cursor: pointer;
  transition: all .2s; font-weight: 600;
}
.pom-btn:hover { border-color: var(--gold); color: var(--gold); }
.pom-btn.start { background: var(--gold); color: var(--black); border-color: var(--gold); }
.pom-sessions { display: flex; gap: .3rem; justify-content: center; margin-top: .75rem; }
.pom-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--bg4); border: 1px solid var(--border); transition: all .3s; }
.pom-dot.done { background: var(--gold); border-color: var(--gold); }
.pom-float-btn {
  position: fixed; top: 72px; right: 1rem; z-index: 799;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 12px; padding: .5rem .75rem;
  font-size: .8rem; cursor: pointer; display: none;
  align-items: center; gap: .4rem; color: var(--muted);
  transition: all .2s; box-shadow: var(--shadow);
}
.pom-float-btn:hover { border-color: var(--gold); color: var(--gold); }
.pom-float-btn.show { display: flex; }

/* ═══════════════════════════════════════
   STUDENT NOTEBOOK
═══════════════════════════════════════ */
.note-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 1.25rem;
  margin-bottom: .75rem; position: relative;
  border-left: 3px solid var(--gold);
  transition: all .2s;
}
.note-card:hover { border-color: rgba(201,168,76,0.4); }
.note-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
.note-subject-tag {
  font-size: .7rem; font-weight: 700; padding: .2rem .5rem;
  border-radius: 6px; background: rgba(201,168,76,0.1); color: var(--gold);
}
.note-date { font-size: .7rem; color: var(--muted); }
.note-text { font-size: .875rem; line-height: 1.6; color: var(--white); }
.note-delete {
  position: absolute; top: .75rem; right: .75rem;
  background: none; border: none; color: var(--muted);
  cursor: pointer; font-size: .9rem; opacity: 0;
  transition: opacity .2s;
}
.note-card:hover .note-delete { opacity: 1; }
.note-delete:hover { color: var(--red); }
.note-input-area {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 1rem;
  margin-bottom: 1.5rem;
}
.note-input {
  width: 100%; background: none; border: none;
  color: var(--white); font-family: var(--font-body);
  font-size: .9rem; resize: none; min-height: 80px;
  line-height: 1.6;
}
.note-input:focus { outline: none; }
.note-input::placeholder { color: var(--muted); }
.note-tags { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .75rem; }
.note-tag-btn {
  padding: .25rem .6rem; border-radius: 6px;
  border: 1px solid var(--border); background: var(--bg4);
  color: var(--muted); font-size: .75rem; cursor: pointer;
  transition: all .2s;
}
.note-tag-btn.selected { background: rgba(201,168,76,0.1); border-color: var(--gold); color: var(--gold); }
.save-note-btn {
  background: var(--gold); color: var(--black);
  border: none; border-radius: 8px; padding: .6rem 1.25rem;
  font-weight: 700; font-size: .85rem; cursor: pointer;
  margin-top: .75rem; transition: all .2s;
}
.save-note-btn:hover { background: var(--gold-light); }

/* ═══════════════════════════════════════
   ONBOARDING TOUR
═══════════════════════════════════════ */
#tour-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 3000;
  pointer-events: none;
}
#tour-overlay.show { display: block; }
.tour-backdrop {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  pointer-events: all;
}
.tour-box {
  position: fixed; z-index: 3001;
  background: var(--bg2); border: 2px solid var(--gold);
  border-radius: 16px; padding: 1.5rem;
  max-width: 320px; width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6), var(--glow);
  pointer-events: all;
  animation: fadeUp .3s ease;
}
.tour-step-num { font-size: .7rem; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: .1em; margin-bottom: .5rem; }
.tour-box h4 { font-size: 1rem; font-weight: 700; margin-bottom: .5rem; }
.tour-box p { font-size: .85rem; color: var(--muted); line-height: 1.6; margin-bottom: 1rem; }
.tour-controls { display: flex; gap: .5rem; align-items: center; }
.tour-next { background: var(--gold); color: var(--black); border: none; border-radius: 8px; padding: .6rem 1.25rem; font-weight: 700; cursor: pointer; flex: 1; }
.tour-skip { background: none; border: 1px solid var(--border); border-radius: 8px; padding: .6rem .75rem; color: var(--muted); cursor: pointer; font-size: .8rem; }
.tour-dots { display: flex; gap: .35rem; margin-left: auto; }
.tour-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--bg4); }
.tour-dot.active { background: var(--gold); }
.tour-highlight {
  position: fixed; border-radius: 12px;
  box-shadow: 0 0 0 4px var(--gold), 0 0 0 9999px rgba(0,0,0,0.7);
  pointer-events: none; z-index: 2999;
  transition: all .4s ease;
}

/* ═══════════════════════════════════════
   LIGHT MODE
═══════════════════════════════════════ */
body.light-mode {
  --black: #F8F5EF;
  --bg1: #FAFAF8;
  --bg2: #FFFFFF;
  --bg3: #F3F0EA;
  --bg4: #E8E4DC;
  --white: #1A1A2E;
  --muted: #6B7280;
  --border: rgba(0,0,0,0.1);
}
body.light-mode #nav {
  background: rgba(255,255,255,0.95);
  border-bottom: 1px solid rgba(0,0,0,0.1);
}
body.light-mode .sidebar {
  background: #F3F0EA;
  border-right: 1px solid rgba(0,0,0,0.1);
}
body.light-mode .sidebar-item:hover { background: #E8E4DC; }
body.light-mode .chat-input, body.light-mode .tutor-input {
  background: #F3F0EA;
}
body.light-mode #geo-panel { background: #FFFFFF; }
body.light-mode #geo-canvas { background: #F3F0EA; }
body.light-mode .msg.bot { background: #F3F0EA; border-color: rgba(0,0,0,0.1); }
body.light-mode .card { background: #FFFFFF; border-color: rgba(0,0,0,0.1); }
body.light-mode .form-group input,
body.light-mode .form-group select { background: #F3F0EA; border-color: rgba(0,0,0,0.15); color: #1A1A2E; }
body.light-mode .assign-card { background: #F3F0EA; }
body.light-mode .sr-card { background: #F3F0EA; }
body.light-mode #pomodoro-widget { background: #FFFFFF; }
body.light-mode .hero-bg .orb { opacity: 0.05; }
body.light-mode .calc-key { background: #F3F0EA; color: #1A1A2E; }


/* ════════════════════════════════════
   ESSAY MARKER
════════════════════════════════════ */
.essay-dropzone {
  border: 2px dashed var(--border); border-radius: 16px;
  padding: 2.5rem; text-align: center; cursor: pointer;
  transition: all .3s; background: var(--bg3);
  margin-bottom: 1.5rem;
}
.essay-dropzone:hover, .essay-dropzone.drag-over {
  border-color: var(--gold); background: rgba(201,168,76,0.05);
}
.essay-dropzone i { font-size: 2.5rem; color: var(--muted); margin-bottom: 1rem; }
.essay-grade {
  display: inline-flex; align-items: center; justify-content: center;
  width: 90px; height: 90px; border-radius: 50%;
  font-size: 2rem; font-weight: 900; font-family: var(--font-head);
  border: 4px solid;
}
.grade-a { color: #4ADE80; border-color: #4ADE80; background: rgba(74,222,128,0.1); }
.grade-b { color: #60A5FA; border-color: #60A5FA; background: rgba(96,165,250,0.1); }
.grade-c { color: #FBBF24; border-color: #FBBF24; background: rgba(251,191,36,0.1); }
.grade-d { color: #FB923C; border-color: #FB923C; background: rgba(251,146,60,0.1); }
.grade-e { color: #FB7185; border-color: #FB7185; background: rgba(251,113,133,0.1); }
.essay-criteria-bar {
  display: flex; align-items: center; gap: 1rem; margin-bottom: .75rem;
}
.essay-criteria-label { width: 160px; font-size: .85rem; flex-shrink: 0; }
.essay-criteria-track {
  flex: 1; height: 8px; background: var(--bg4); border-radius: 4px; overflow: hidden;
}
.essay-criteria-fill {
  height: 100%; border-radius: 4px; transition: width 1s ease;
  background: linear-gradient(90deg, var(--gold), var(--green));
}
.essay-criteria-score { font-size: .8rem; color: var(--gold); font-weight: 700; width: 40px; text-align: right; }

/* ════════════════════════════════════
   IMAGE UPLOAD TO TUTOR
════════════════════════════════════ */
.img-upload-btn {
  width: 36px; height: 36px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg3);
  color: var(--muted); cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  font-size: 1rem; transition: all .2s; flex-shrink: 0;
}
.img-upload-btn:hover { border-color: var(--gold); color: var(--gold); }
.img-preview-strip {
  display: flex; gap: .5rem; padding: .5rem;
  background: var(--bg3); border-radius: 8px;
  margin-bottom: .5rem; flex-wrap: wrap;
}
.img-preview-item {
  position: relative; width: 60px; height: 60px;
}
.img-preview-item img {
  width: 100%; height: 100%; object-fit: cover;
  border-radius: 6px; border: 1px solid var(--border);
}
.img-preview-item button {
  position: absolute; top: -5px; right: -5px;
  background: var(--red); color: white; border: none;
  border-radius: 50%; width: 18px; height: 18px;
  font-size: .65rem; cursor: pointer; line-height: 1;
}

/* ════════════════════════════════════
   EXAM COUNTDOWN
════════════════════════════════════ */
.exam-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 16px; padding: 1.5rem;
  display: flex; align-items: center; gap: 1.5rem;
  margin-bottom: 1rem; transition: all .2s;
  position: relative; overflow: hidden;
}
.exam-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0;
  width: 4px; background: var(--subject-color, var(--gold));
}
.exam-countdown-nums {
  display: flex; gap: .75rem; flex-shrink: 0;
}
.exam-cd-unit {
  text-align: center; background: var(--bg4);
  border-radius: 10px; padding: .5rem .75rem;
  min-width: 52px;
}
.exam-cd-num { font-size: 1.5rem; font-weight: 800; font-family: var(--font-mono); color: var(--gold); }
.exam-cd-label { font-size: .6rem; color: var(--muted); text-transform: uppercase; }
.exam-urgency-bar {
  height: 4px; border-radius: 2px; margin-top: .75rem;
  background: var(--bg4);
}
.exam-urgency-fill { height: 100%; border-radius: 2px; transition: width .5s; }
.add-exam-btn {
  background: none; border: 2px dashed var(--border);
  border-radius: 16px; padding: 1.5rem; width: 100%;
  color: var(--muted); cursor: pointer; transition: all .2s;
  font-size: .9rem; display: flex; align-items: center;
  justify-content: center; gap: .5rem;
}
.add-exam-btn:hover { border-color: var(--gold); color: var(--gold); }

/* ════════════════════════════════════
   REVISION TIMETABLE
════════════════════════════════════ */
.timetable-grid {
  display: grid;
  grid-template-columns: 70px repeat(7, 1fr);
  gap: 2px; font-size: .75rem;
}
.tt-header {
  background: var(--bg3); border-radius: 6px;
  padding: .4rem; text-align: center; font-weight: 700;
  color: var(--muted);
}
.tt-time {
  background: var(--bg3); border-radius: 6px;
  padding: .4rem; text-align: center; color: var(--muted);
  font-family: var(--font-mono);
}
.tt-slot {
  border-radius: 6px; padding: .4rem .5rem;
  min-height: 48px; cursor: pointer; transition: all .2s;
  font-size: .72rem; display: flex; align-items: center;
  justify-content: center; text-align: center;
}
.tt-slot.empty { background: var(--bg3); }
.tt-slot.empty:hover { background: var(--bg4); }
.tt-slot.filled { font-weight: 600; color: var(--black); }

/* ════════════════════════════════════
   CHAT HISTORY
════════════════════════════════════ */
.history-item {
  padding: .75rem 1rem; border-radius: 10px;
  border: 1px solid var(--border); background: var(--bg3);
  margin-bottom: .5rem; cursor: pointer; transition: all .2s;
  display: flex; align-items: center; gap: .75rem;
}
.history-item:hover { border-color: var(--gold); background: rgba(201,168,76,0.05); }
.history-subj-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.history-preview { flex: 1; }
.history-title { font-size: .875rem; font-weight: 600; margin-bottom: .2rem; }
.history-snippet { font-size: .75rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
.history-date { font-size: .7rem; color: var(--muted); flex-shrink: 0; }

/* ════════════════════════════════════
   GLOSSARY
════════════════════════════════════ */
.glossary-letter {
  font-size: 1.2rem; font-weight: 800; color: var(--gold);
  font-family: var(--font-head); margin: 1.5rem 0 .75rem;
  padding-bottom: .25rem; border-bottom: 1px solid var(--border);
}
.glossary-term {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; padding: 1rem 1.25rem;
  margin-bottom: .5rem; transition: all .2s;
}
.glossary-term:hover { border-color: var(--gold); }
.glossary-term-word { font-weight: 700; margin-bottom: .35rem; }
.glossary-term-def { font-size: .875rem; color: var(--muted); line-height: 1.6; }
.glossary-term-example { font-size: .8rem; color: var(--blue); margin-top: .35rem; font-style: italic; }
.glossary-search-bar {
  width: 100%; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 10px; padding: .75rem 1rem; color: var(--white);
  font-family: var(--font-body); font-size: .9rem; margin-bottom: 1.5rem;
  transition: border-color .2s;
}
.glossary-search-bar:focus { outline: none; border-color: var(--gold); }

/* ════════════════════════════════════
   FONT SIZE CONTROL
════════════════════════════════════ */
.font-size-control {
  display: flex; align-items: center; gap: .75rem;
}
.fs-btn {
  width: 36px; height: 36px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg3);
  color: var(--white); cursor: pointer; font-weight: 700;
  transition: all .2s; display: flex; align-items: center; justify-content: center;
}
.fs-btn:hover { border-color: var(--gold); color: var(--gold); }
.fs-display {
  min-width: 44px; text-align: center; font-family: var(--font-mono);
  font-size: .85rem; color: var(--gold);
}

/* ════════════════════════════════════
   LEADERBOARD
════════════════════════════════════ */
.lb-row {
  display: flex; align-items: center; gap: 1rem;
  padding: .875rem 1rem; border-radius: 12px;
  border: 1px solid var(--border); background: var(--bg3);
  margin-bottom: .5rem; transition: all .2s;
}
.lb-row.you { border-color: var(--gold); background: rgba(201,168,76,0.08); }
.lb-rank {
  width: 32px; text-align: center; font-weight: 800;
  font-family: var(--font-mono); color: var(--muted);
  font-size: .9rem;
}
.lb-rank.gold { color: #FFD700; }
.lb-rank.silver { color: #C0C0C0; }
.lb-rank.bronze { color: #CD7F32; }
.lb-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--bg4); display: flex; align-items: center;
  justify-content: center; font-size: 1.1rem; flex-shrink: 0;
}
.lb-name { flex: 1; font-weight: 600; font-size: .9rem; }
.lb-xp { font-family: var(--font-mono); color: var(--gold); font-weight: 700; font-size: .85rem; }
.lb-badge { font-size: .75rem; background: var(--bg4); border-radius: 6px; padding: .2rem .4rem; }

/* ════════════════════════════════════
   VIDEO GENERATOR
════════════════════════════════════ */
.vid-gen-form {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;
}
.vid-gen-preview {
  background: #0A0C12; border: 1px solid var(--border);
  border-radius: 12px; aspect-ratio: 16/9;
  display: flex; align-items: center; justify-content: center;
  position: relative; overflow: hidden; margin-bottom: 1.5rem;
}
.vid-gen-scene {
  width: 100%; height: 100%; padding: 2rem;
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; text-align: center;
}
.vid-scene-title {
  font-family: var(--font-head); font-size: 1.8rem;
  font-weight: 700; margin-bottom: 1rem; color: var(--gold);
}
.vid-scene-content {
  font-size: 1rem; color: var(--white); line-height: 1.8;
  max-width: 600px;
}
.vid-progress-bar {
  height: 4px; background: var(--bg4); border-radius: 2px;
  margin-bottom: 1rem; overflow: hidden;
}
.vid-progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--gold), var(--green));
  border-radius: 2px; transition: width .3s;
  width: 0%;
}
.vid-controls {
  display: flex; gap: .75rem; align-items: center;
}
.vid-ctrl-btn {
  padding: .6rem 1.25rem; border-radius: 8px; border: 1px solid var(--border);
  background: var(--bg3); color: var(--white); cursor: pointer;
  font-size: .85rem; font-weight: 600; transition: all .2s;
}
.vid-ctrl-btn.primary { background: var(--gold); color: var(--black); border-color: var(--gold); }
.vid-ctrl-btn:hover { border-color: var(--gold); }

/* ════════════════════════════════════
   LOADING SKELETON
════════════════════════════════════ */
.skeleton-line {
  height: 14px; border-radius: 7px;
  background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  margin-bottom: .75rem;
}
.skeleton-line.short { width: 40%; }
.skeleton-line.medium { width: 70%; }
.skeleton-line.long { width: 95%; }
.skeleton-block {
  border-radius: 12px;
  background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

/* ════════════════════════════════════
   KEYBOARD SHORTCUTS MODAL
════════════════════════════════════ */
.kb-modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.8); z-index: 3000;
  align-items: center; justify-content: center; padding: 1rem;
}
.kb-modal.show { display: flex; }
.kb-box {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 20px; padding: 2rem; max-width: 480px; width: 100%;
}
.kb-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: .6rem 0; border-bottom: 1px solid var(--border);
  font-size: .875rem;
}
.kb-row:last-child { border: none; }
kbd {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 5px; padding: .2rem .5rem;
  font-family: var(--font-mono); font-size: .75rem;
  color: var(--gold); box-shadow: 0 2px 0 rgba(0,0,0,0.3);
}

/* ════════════════════════════════════
   WELSH LANGUAGE
════════════════════════════════════ */
.lang-toggle {
  display: flex; gap: .25rem; background: var(--bg3);
  border: 1px solid var(--border); border-radius: 8px;
  padding: .25rem;
}
.lang-btn {
  padding: .35rem .75rem; border-radius: 6px; border: none;
  background: none; color: var(--muted); cursor: pointer;
  font-size: .8rem; font-weight: 600; transition: all .2s;
}
.lang-btn.active { background: var(--gold); color: var(--black); }

/* ════════════════════════════════════
   PAST PAPERS LIBRARY
════════════════════════════════════ */
.paper-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 1.25rem;
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: .75rem; cursor: pointer; transition: all .2s;
}
.paper-card:hover { border-color: var(--gold); }
.paper-icon {
  width: 44px; height: 44px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.25rem; flex-shrink: 0;
}
.paper-meta { flex: 1; }
.paper-title { font-weight: 700; font-size: .9rem; margin-bottom: .2rem; }
.paper-info { font-size: .75rem; color: var(--muted); }
.paper-action {
  background: var(--gold); color: var(--black);
  border: none; border-radius: 8px; padding: .5rem 1rem;
  font-size: .8rem; font-weight: 700; cursor: pointer;
}

</style>
</head>
<body>

<!-- ═══════════════════════ BACKGROUND ═══════════════════════ -->
<div class="hero-bg">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
</div>

<!-- ═══════════════════════ NAVIGATION ═══════════════════════ -->
<nav id="nav">
  <div class="nav-logo" onclick="nav('home')">Lumina <span>AI</span></div>
  <div class="nav-links" id="public-nav">
    <a onclick="nav('home')">Home</a>
    <a onclick="scrollTo('#features')">Features</a>
    <a onclick="scrollTo('#pricing')">Pricing</a>
  </div>
  <div class="nav-links" id="app-nav" style="display:none">
    <a onclick="showDash('home')" id="nl-home">Dashboard</a>
    <a onclick="showDash('tutor')" id="nl-tutor">AI Tutor</a>
    <a onclick="showDash('questions')" id="nl-questions">Questions</a>
    <a onclick="showDash('progress')" id="nl-progress">Progress</a>
    <a onclick="showDash('strengths')" id="nl-strengths">Strengths</a>
    <a onclick="showDash('assignments')" id="nl-assign">Assignments</a>
    <a onclick="showDash('settings')" id="nl-settings">Settings</a>
  </div>
  <div class="nav-right">
    <div class="a11y-bar" id="a11y-bar" style="display:none">
      <button class="a11y-btn" id="btn-adhd" onclick="toggleMode('adhd')">ADHD</button>
      <button class="a11y-btn" id="btn-dyslexia" onclick="toggleMode('dyslexia')">Dyslexia</button>
      <button class="a11y-btn" id="btn-dyscalculia" onclick="toggleMode('dyscalculia')">Dyscalculia</button>
    </div>
    <button onclick="document.getElementById('kb-modal').classList.add('show')" style="background:none;border:1px solid var(--border);border-radius:8px;padding:.3rem .6rem;color:var(--muted);cursor:pointer;font-size:.75rem" title="Keyboard shortcuts">⌨️</button>
    <div id="xp-badge"><i class="fas fa-star"></i><span id="xp-display">0 XP</span></div>
    <div id="dash-search-wrap" style="display:none;position:relative">
      <input type="text" id="dash-search" placeholder="🔍 Search notes, topics..." 
        style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:.5rem 1rem;color:var(--white);font-family:var(--font-body);font-size:.85rem;width:220px;transition:all .2s"
        oninput="searchDash(this.value)" onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
      <div id="search-results" style="display:none;position:absolute;top:calc(100% + 6px);right:0;background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:280px;z-index:900;box-shadow:var(--shadow)"></div>
    </div>
    <div id="auth-buttons">
      <button class="btn btn-outline" onclick="nav('auth')">Log In</button>
      <button class="btn btn-gold" onclick="nav('auth')">Sign Up</button>
    </div>
    <div id="user-menu" style="display:none">
      <button class="btn btn-outline" onclick="logout()">Log Out</button>
    </div>
  </div>
</nav>

<!-- ═══════════════════════ HOME PAGE ═══════════════════════ -->
<div id="page-home" class="page active">

  <!-- Hero -->
  <section class="hero">
    <div class="hero-badge"><i class="fas fa-sparkles"></i> UK GCSE & A-Level Learning Platform</div>
    <h1>The <em>Smartest Way</em><br>to Prepare for Your Exams</h1>
    <p>AI-powered tutoring, personalised question papers, teacher assignments, and real-time progress tracking — built for every learner, including ADHD, dyslexia, and other learning differences.</p>
    <div class="hero-actions">
      <button class="btn-hero-primary" onclick="nav('auth')">Start Learning Free →</button>
      <button class="btn-hero-secondary" onclick="document.querySelector('.video-section').scrollIntoView({behavior:'smooth'})">▶ Watch How It Works</button>
    </div>
    <div class="trust-bar">
      <div class="trust-item"><i class="fas fa-credit-card"></i> No credit card required</div>
      <div class="trust-item"><i class="fas fa-graduation-cap"></i> All UK exam boards</div>
      <div class="trust-item"><i class="fas fa-brain"></i> ADHD & dyslexia friendly</div>
      <div class="trust-item"><i class="fas fa-shield-alt"></i> GDPR compliant</div>
    </div>
  </section>

  <!-- Video Section -->
  <section class="video-section">
    <div class="section-label">See it in action</div>
    <h2>Watch How Lumina AI Works</h2>
    <p>A 90-second walkthrough showing how students use the AI tutor, generate exam questions, and track their progress.</p>
    <div class="video-player">
      <div class="video-main" id="video-main" onclick="startVideo()">
        <div class="video-preview-content">
          <div class="video-play-btn"><i class="fas fa-play"></i></div>
          <h3>How Lumina AI Works</h3>
          <p>AI Tutor · Exam Questions · Progress Tracking · Accessibility</p>
        </div>
      </div>
      <div class="video-chapters">
        <button class="chapter-btn active" onclick="playChapter(0)">
          <span class="chapter-icon">👋</span>Welcome<br><span class="chapter-time">0:00</span>
        </button>
        <button class="chapter-btn" onclick="playChapter(1)">
          <span class="chapter-icon">🤖</span>AI Tutor<br><span class="chapter-time">0:22</span>
        </button>
        <button class="chapter-btn" onclick="playChapter(2)">
          <span class="chapter-icon">📝</span>Questions<br><span class="chapter-time">0:45</span>
        </button>
        <button class="chapter-btn" onclick="playChapter(3)">
          <span class="chapter-icon">📊</span>Progress<br><span class="chapter-time">1:05</span>
        </button>
        <button class="chapter-btn" onclick="playChapter(4)">
          <span class="chapter-icon">♿</span>Accessibility<br><span class="chapter-time">1:22</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Features -->
  <section class="features-section" id="features">
    <div class="section-label" style="display:block;text-align:center;margin-bottom:1rem">What's inside</div>
    <h2>Everything a student needs to succeed</h2>
    <p class="sub">From AI tutoring to exam prep — Lumina adapts to how YOU learn best.</p>
    <div class="features-grid">
      <div class="feature-card" onclick="nav('auth')">
        <div class="feature-icon">🤖</div>
        <h3>AI Tutor</h3>
        <p>Ask anything. Get step-by-step explanations tailored to your level, learning style, and exam board. Remembers what you've covered.</p>
        <span class="feature-tag">9 Subjects</span>
      </div>
      <div class="feature-card" onclick="nav('auth')">
        <div class="feature-icon">📝</div>
        <h3>Exam Question Generator</h3>
        <p>Generate real exam-style questions for any topic, mark scheme, difficulty and exam board. Get instant AI feedback on your answers.</p>
        <span class="feature-tag">All Exam Boards</span>
      </div>
      <div class="feature-card" onclick="nav('auth')">
        <div class="feature-icon">🎯</div>
        <h3>Strengths & Weaknesses Analyser</h3>
        <p>Claude analyses your performance and tells you exactly what to focus on. Get a personalised revision priority list.</p>
        <span class="feature-tag">AI Analysis</span>
      </div>
      <div class="feature-card" onclick="nav('auth')">
        <div class="feature-icon">📊</div>
        <h3>Progress Tracking</h3>
        <p>See your improvement over time with beautiful charts, study streaks, achievement badges and topic mastery scores.</p>
        <span class="feature-tag">Real-time</span>
      </div>
      <div class="feature-card" onclick="nav('auth')">
        <div class="feature-icon">🧮</div>
        <h3>Dyscalculia Calculator & Visual Maths</h3>
        <p>A dedicated number-line calculator that shows how maths works visually — step by step, with colour-coded operations.</p>
        <span class="feature-tag">Accessibility</span>
      </div>
      <div class="feature-card" onclick="nav('auth')">
        <div class="feature-icon">👨‍🏫</div>
        <h3>Teacher Assignments</h3>
        <p>Teachers set AI-powered homework. Students get AI hints. Teachers see real-time submission tracking with auto-grading.</p>
        <span class="feature-tag">For Schools</span>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <section class="stats-section">
    <div class="stats-grid">
      <div><div class="stat-num">0</div><div class="stat-label">Students Learning</div></div>
      <div><div class="stat-num">98%</div><div class="stat-label">Satisfaction Rate</div></div>
      <div><div class="stat-num">1M+</div><div class="stat-label">Questions Generated</div></div>
      <div><div class="stat-num">+42%</div><div class="stat-label">Average Grade Boost</div></div>
    </div>
  </section>

  <!-- Subjects -->
  <section class="subjects-section">
    <h2>All the subjects you need</h2>
    <div class="subjects-grid">
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">➕</div><div class="s-name">Mathematics</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">⚡</div><div class="s-name">Physics</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">🧪</div><div class="s-name">Chemistry</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">🧬</div><div class="s-name">Biology</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">📖</div><div class="s-name">English Lit</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">🏛️</div><div class="s-name">History</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">💻</div><div class="s-name">Computer Sci</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">💰</div><div class="s-name">Economics</div><div class="s-level">A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">🇫🇷</div><div class="s-name">French</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">🌍</div><div class="s-name">Geography</div><div class="s-level">GCSE / A-Level</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">🎨</div><div class="s-name">Art & Design</div><div class="s-level">GCSE</div></div>
      <div class="subject-pill" onclick="nav('auth')"><div class="s-icon">📐</div><div class="s-name">Further Maths</div><div class="s-level">A-Level</div></div>
    </div>
  </section>

  <!-- Pricing -->
  <section class="pricing-section" id="pricing">
    <h2>Simple, transparent pricing</h2>
    <p class="pricing-sub">No hidden fees. Cancel any time. Start with a 7-day free trial.</p>
    <div class="pricing-grid">
      <div class="price-card">
        <div class="price-name">Student Plan</div>
        <div class="price-amount">£60<span>/month</span></div>
        <div class="price-desc">Perfect for individual GCSE & A-Level students</div>
        <ul class="price-features">
          <li><i class="fas fa-check"></i>Full AI Tutor (Lumina AI)</li>
          <li><i class="fas fa-check"></i>Unlimited practice questions</li>
          <li><i class="fas fa-check"></i>Personalised explanations</li>
          <li><i class="fas fa-check"></i>Exam preparation tools</li>
          <li><i class="fas fa-check"></i>Progress tracking</li>
          <li><i class="fas fa-check"></i>All accessibility features</li>
        </ul>
        <button class="btn-full" onclick="nav('auth')">Get Started</button>
      </div>
      <div class="price-card featured">
        <div class="price-name">Homeschool Plan</div>
        <div class="price-amount">£200<span>/month</span></div>
        <div class="price-desc">Complete AI tutoring system for homeschool families</div>
        <ul class="price-features">
          <li><i class="fas fa-check"></i>Everything in Student Plan</li>
          <li><i class="fas fa-check"></i>Full curriculum support</li>
          <li><i class="fas fa-check"></i>Teacher assignment tools</li>
          <li><i class="fas fa-check"></i>Parent progress dashboard</li>
          <li><i class="fas fa-check"></i>Multiple student profiles</li>
          <li><i class="fas fa-check"></i>Priority support</li>
        </ul>
        <button class="btn-full" onclick="nav('auth')">Get Started</button>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="cta-section">
    <h2>Ready to transform<br><em style="color:var(--gold);font-style:normal">how you learn?</em></h2>
    <p>Join thousands of UK students achieving better grades with AI-powered tutoring.</p>
    <button class="btn-hero-primary" onclick="nav('auth')">Start Your Free Trial →</button>
  </section>

  <!-- Footer -->
  <footer style="background:var(--bg2);border-top:1px solid var(--border);padding:2rem;text-align:center;">
    <div class="nav-logo" style="margin-bottom:.5rem">Lumina <span style="color:var(--gold)">AI</span></div>
    <p style="color:var(--muted);font-size:.8rem;margin-bottom:1rem">The smartest way to prepare for your exams</p>
    <div style="display:flex;gap:1.5rem;justify-content:center;font-size:.8rem;">
      <a onclick="nav('privacy')" style="color:var(--muted);cursor:pointer;text-decoration:none">Privacy Policy</a>
      <a style="color:var(--muted);cursor:pointer;text-decoration:none">Terms of Service</a>
      <a style="color:var(--muted);cursor:pointer;text-decoration:none">Contact</a>
    </div>
    <p style="color:var(--muted);font-size:.75rem;margin-top:1rem">© 2025 Lumina AI. All rights reserved.</p>
  </footer>
</div>

<!-- ═══════════════════════ AUTH PAGE ═══════════════════════ -->
<div id="page-auth" class="page">
  <div class="auth-box">
    <div class="auth-logo">Lumina <span>AI</span></div>
    <p class="auth-sub">Join thousands of UK students achieving better grades</p>

    <!-- Signup flow -->
    <div id="signup-flow">
      <div class="step-indicator">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
        <div class="step-dot" id="dot4"></div>
      </div>

      <!-- Step 1: Account -->
      <div class="auth-step active" id="step1">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1.5rem">Create your account</h3>
        <div class="plan-options">
          <div class="plan-opt selected" id="plan-student" onclick="selectPlan('student')">
            <div class="plan-name">Student</div>
            <div class="plan-price">£60<span style="font-size:.75rem;font-weight:400">/mo</span></div>
            <div class="plan-tag">Individual</div>
          </div>
          <div class="plan-opt" id="plan-home" onclick="selectPlan('home')">
            <div class="plan-name">Homeschool</div>
            <div class="plan-price">£200<span style="font-size:.75rem;font-weight:400">/mo</span></div>
            <div class="plan-tag">Family</div>
          </div>
        </div>
        <div class="form-group"><label>Full Name</label><input type="text" id="reg-name" placeholder="Your full name"></div>
        <div class="form-group"><label>Email</label><input type="email" id="reg-email" placeholder="you@email.com"></div>
        <div class="form-group"><label>Password</label><input type="password" id="reg-pass" placeholder="Min. 8 characters"></div>
        <button class="btn-full" onclick="nextStep(1)">Continue →</button>
      </div>

      <!-- Step 2: Profile -->
      <div class="auth-step" id="step2">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1.5rem">Tell us about yourself</h3>
        <div class="form-group">
          <label>I am a...</label>
          <select id="reg-role">
            <option>Student</option>
            <option>Teacher</option>
            <option>Parent / Guardian</option>
          </select>
        </div>
        <div class="form-group">
          <label>Year Group</label>
          <select id="reg-year">
            <option>Year 9</option><option>Year 10</option><option selected>Year 11 (GCSE)</option>
            <option>Year 12 (AS)</option><option>Year 13 (A-Level)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Primary Subject</label>
          <select id="reg-subject">
            <option>Mathematics</option><option>Physics</option><option>Chemistry</option>
            <option>Biology</option><option>English Literature</option><option>History</option>
            <option>Computer Science</option><option>Economics</option><option>French</option>
          </select>
        </div>
        <div class="form-group">
          <label>Exam Board</label>
          <select id="reg-board">
            <option>AQA</option><option>Edexcel</option><option>OCR</option><option>WJEC</option>
          </select>
        </div>
        <button class="btn-full" onclick="nextStep(2)">Continue →</button>
        <button class="btn-back" onclick="prevStep(1)">← Back</button>
      </div>

      <!-- Step 3: Learning needs -->
      <div class="auth-step" id="step3">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:.5rem">How do you learn best?</h3>
        <p style="color:var(--muted);font-size:.8rem;margin-bottom:1.5rem">Select any that apply — Lumina will adapt to you automatically</p>
        <div class="difficulty-grid">
          <div class="diff-card" id="diff-adhd" onclick="toggleDiff('adhd')">
            <div class="diff-icon">⚡</div>
            <div class="diff-name">ADHD</div>
            <div class="diff-desc">Shorter tasks, focus breaks, clear structure</div>
          </div>
          <div class="diff-card" id="diff-dyslexia" onclick="toggleDiff('dyslexia')">
            <div class="diff-icon">📖</div>
            <div class="diff-name">Dyslexia</div>
            <div class="diff-desc">Special fonts, spacing, audio read-aloud</div>
          </div>
          <div class="diff-card" id="diff-dyscalculia" onclick="toggleDiff('dyscalculia')">
            <div class="diff-icon">🧮</div>
            <div class="diff-name">Dyscalculia</div>
            <div class="diff-desc">Visual maths, number lines, step-by-step</div>
          </div>
          <div class="diff-card" id="diff-autism" onclick="toggleDiff('autism')">
            <div class="diff-icon">🧩</div>
            <div class="diff-name">Autism Spectrum</div>
            <div class="diff-desc">Predictable structure, literal explanations</div>
          </div>
          <div class="diff-card" id="diff-visual" onclick="toggleDiff('visual')">
            <div class="diff-icon">👁️</div>
            <div class="diff-name">Visual Impairment</div>
            <div class="diff-desc">High contrast, larger text</div>
          </div>
          <div class="diff-card" id="diff-none" onclick="toggleDiff('none')">
            <div class="diff-icon">✨</div>
            <div class="diff-name">No Specific Needs</div>
            <div class="diff-desc">Standard experience</div>
          </div>
        </div>
        <button class="btn-full" style="margin-top:1.5rem" onclick="nextStep(3)">Continue →</button>
        <button class="btn-back" onclick="prevStep(2)">← Back</button>
      </div>

      <!-- Step 4: GDPR -->
      <div class="auth-step" id="step4">
        <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:1.5rem">Almost there! 🎉</h3>
        <div style="background:var(--bg3);border-radius:12px;padding:1rem;margin-bottom:1.5rem;font-size:.85rem;color:var(--muted);line-height:1.6">
          <strong style="color:var(--white);display:block;margin-bottom:.5rem">Your learning profile is ready:</strong>
          <div id="profile-summary"></div>
        </div>
        <div class="gdpr-check">
          <input type="checkbox" id="gdpr-check">
          <label for="gdpr-check">I agree to the <a onclick="nav('privacy')">Privacy Policy</a> and <a href="#">Terms of Service</a>. I understand my data helps personalise my learning experience and can be deleted at any time.</label>
        </div>
        <button class="btn-full" onclick="createAccount()">🚀 Start Learning Free</button>
        <button class="btn-back" onclick="prevStep(3)">← Back</button>
      </div>
    </div>

    <!-- Login form -->
    <div class="login-form" id="login-form">
      <div class="auth-tabs">
        <button class="auth-tab" onclick="showSignup()">Sign Up</button>
        <button class="auth-tab active">Log In</button>
      </div>
      <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="you@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-pass" placeholder="Your password"></div>
      <button class="btn-full" onclick="loginUser()">Log In →</button>
      <p style="text-align:center;margin-top:1rem;font-size:.8rem;color:var(--muted)">Don't have an account? <a onclick="showSignup()" style="color:var(--gold);cursor:pointer">Sign up free</a></p>
    </div>
  </div>
</div>

<!-- ═══════════════════════ DASHBOARD ═══════════════════════ -->
<div id="page-dashboard" class="page">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-user">
      <div class="avatar" id="sb-avatar">S</div>
      <div class="sidebar-user-info">
        <div class="user-name" id="sb-name">Student</div>
        <div class="user-plan" id="sb-plan">Student Plan</div>
      </div>
    </div>
    <div class="sidebar-xp">
      <div class="xp-header">
        <span class="xp-level" id="xp-level-text">Level 1</span>
        <span style="color:var(--muted);font-size:.75rem" id="xp-progress-text">0 / 200 XP</span>
      </div>
      <div class="xp-bar"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
    </div>
    <div class="sidebar-nav">
      <div class="sidebar-section-label">Learning</div>
      <div class="sidebar-item active" id="si-home" onclick="showDash('home')"><i class="fas fa-house"></i>Dashboard</div>
      <div class="sidebar-item" id="si-tutor" onclick="showDash('tutor')"><i class="fas fa-robot"></i>AI Tutor</div>
      <div class="sidebar-item" id="si-questions" onclick="showDash('questions')"><i class="fas fa-file-lines"></i>Question Papers</div>
      <div class="sidebar-section-label">Progress</div>
      <div class="sidebar-item" id="si-progress" onclick="showDash('progress')"><i class="fas fa-chart-line"></i>Progress</div>
      <div class="sidebar-item" id="si-strengths" onclick="showDash('strengths')"><i class="fas fa-bullseye"></i>Strengths</div>
      <div class="sidebar-section-label">School</div>
      <div class="sidebar-item" id="si-essay" onclick="showDash('essay')"><i class="fas fa-pen-nib"></i>Essay Marker</div>
      <div class="sidebar-item" id="si-exams" onclick="showDash('exams')"><i class="fas fa-calendar"></i>Exam Countdown</div>
      <div class="sidebar-item" id="si-video" onclick="showDash('video')"><i class="fas fa-film"></i>Video Explainer</div>
      <div class="sidebar-item" id="si-papers" onclick="showDash('papers')"><i class="fas fa-file-alt"></i>Past Papers</div>
      <div class="sidebar-item" id="si-glossary" onclick="showDash('glossary')"><i class="fas fa-book-open"></i>Glossary</div>
      <div class="sidebar-item" id="si-history" onclick="showDash('history')"><i class="fas fa-clock"></i>Chat History</div>
      <div class="sidebar-item" id="si-leaderboard" onclick="showDash('leaderboard')"><i class="fas fa-trophy"></i>Leaderboard</div>
      <div class="sidebar-item" id="si-notes" onclick="showDash('notes')"><i class="fas fa-book"></i>Notebook</div>
      <div class="sidebar-item" id="si-assign" onclick="showDash('assignments')"><i class="fas fa-clipboard-list"></i>Assignments<span class="sidebar-badge">2</span></div>
      <div class="sidebar-section-label">Account</div>
      <div class="sidebar-item" id="si-settings" onclick="showDash('settings')"><i class="fas fa-gear"></i>Settings</div>
    </div>
  </div>

  <!-- Main content -->
  <div class="main-content">

    <!-- HOME SUBPAGE -->
    <div class="subpage active" id="sp-home">
      <div class="page-title" id="dash-greeting">Good morning! 👋</div>
      <p class="page-subtitle">Here's your learning overview</p>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-card-label">Questions Answered</div><div class="stat-card-value" id="stat-q">1,247</div><div class="stat-card-change">↑ 12 today</div></div>
        <div class="stat-card"><div class="stat-card-label">Accuracy Rate</div><div class="stat-card-value" id="stat-acc">78%</div><div class="stat-card-change">↑ 3% this week</div></div>
        <div class="stat-card"><div class="stat-card-label">Study Streak</div><div class="stat-card-value">14 🔥</div><div class="stat-card-change">days in a row</div></div>
        <div class="stat-card"><div class="stat-card-label">Topics Mastered</div><div class="stat-card-value">0</div><div class="stat-card-change">of 60 total</div></div>
      </div>
      <div class="dash-grid">
        <div>
          <!-- Quick chat -->
          <div class="card" style="margin-bottom:1.5rem">
            <div class="card-header">
              <span class="card-title">🤖 Quick Ask — AI Tutor</span>
              <button class="btn btn-gold" style="font-size:.75rem;padding:.4rem .9rem" onclick="showDash('tutor')">Open Tutor →</button>
            </div>
            <div class="chat-messages" id="dash-chat"></div>
            <div class="chat-input-row">
              <textarea class="chat-input" id="dash-input" placeholder="Ask anything..." onkeydown="dashKey(event)"></textarea>
              <button class="chat-send" onclick="dashSend()">Send ✦</button>
            </div>
          </div>
          <!-- Progress -->
          <div class="card">
            <div class="card-header"><span class="card-title">📊 Subject Progress</span></div>
            <div class="card-body">
              <div class="progress-item"><div class="progress-header"><span>Mathematics</span><span>72%</span></div><div class="progress-bar"><div class="progress-fill" style="width:72%;background:var(--blue)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>Physics</span><span>65%</span></div><div class="progress-bar"><div class="progress-fill" style="width:65%;background:var(--green)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>Chemistry</span><span>58%</span></div><div class="progress-bar"><div class="progress-fill" style="width:58%;background:var(--purple)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>Biology</span><span>81%</span></div><div class="progress-bar"><div class="progress-fill" style="width:81%;background:var(--pink)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>English Lit</span><span>70%</span></div><div class="progress-bar"><div class="progress-fill" style="width:70%;background:var(--orange)"></div></div></div>
            </div>
          </div>
        </div>
        <div>
          <!-- Recent activity -->
          <div class="card">
            <div class="card-header"><span class="card-title">⚡ Recent Activity</span></div>
            <div class="card-body" style="padding:1rem 1.5rem">
              <div class="activity-item"><div class="activity-icon" style="background:rgba(96,165,250,0.15);color:var(--blue)">📝</div><div><div class="activity-text fw700">Completed 5 Maths questions</div><div style="font-size:.75rem;color:var(--muted)">Algebra — Quadratics</div></div><div class="activity-time">2m</div></div>
              <div class="activity-item"><div class="activity-icon" style="background:rgba(201,168,76,0.15);color:var(--gold)">🤖</div><div><div class="activity-text fw700">AI Tutor session</div><div style="font-size:.75rem;color:var(--muted)">Physics — Forces</div></div><div class="activity-time">1h</div></div>
              <div class="activity-item"><div class="activity-icon" style="background:rgba(74,222,128,0.15);color:var(--green)">✅</div><div><div class="activity-text fw700">Assignment submitted</div><div style="font-size:.75rem;color:var(--muted)">Chemistry homework</div></div><div class="activity-time">3h</div></div>
              <div class="activity-item"><div class="activity-icon" style="background:rgba(167,139,250,0.15);color:var(--purple)">🏆</div><div><div class="activity-text fw700">Achievement unlocked!</div><div style="font-size:.75rem;color:var(--muted)">7-day streak 🔥</div></div><div class="activity-time">1d</div></div>
            </div>
          </div>
          <!-- Quick actions -->
          <div class="card" style="margin-top:1.5rem">
            <div class="card-header"><span class="card-title">🚀 Quick Actions</span></div>
            <div class="card-body" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
              <button class="btn btn-outline" style="border-radius:10px;padding:.875rem" onclick="showDash('tutor')">🤖 AI Tutor</button>
              <button class="btn btn-outline" style="border-radius:10px;padding:.875rem" onclick="showDash('questions')">📝 Generate Questions</button>
              <button class="btn btn-outline" style="border-radius:10px;padding:.875rem" onclick="showDash('progress')">📊 Progress</button>
              <button class="btn btn-outline" style="border-radius:10px;padding:.875rem" onclick="showDash('strengths')">🎯 Strengths</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI TUTOR SUBPAGE -->
    <div class="subpage" id="sp-tutor" style="padding:0;margin:-2rem;height:calc(100vh - 64px)">
      <div class="tutor-layout">
        <div class="tutor-subjects">
          <h4>Subjects</h4>
          <button class="subj-btn active" id="tsub-math" onclick="setSubject('Mathematics','➕','math')">➕ Mathematics</button>
          <button class="subj-btn" id="tsub-econ" onclick="setSubject('Economics','💰','econ')">💰 Economics</button>
          <button class="subj-btn" id="tsub-phys" onclick="setSubject('Physics','⚡','sci')">⚡ Physics</button>
          <button class="subj-btn" id="tsub-chem" onclick="setSubject('Chemistry','🧪','sci')">🧪 Chemistry</button>
          <button class="subj-btn" id="tsub-bio" onclick="setSubject('Biology','🧬','sci')">🧬 Biology</button>
          <button class="subj-btn" id="tsub-eng" onclick="setSubject('English Literature','📖','eng')">📖 English Lit</button>
          <button class="subj-btn" id="tsub-hist" onclick="setSubject('History','🏛️','hist')">🏛️ History</button>
          <button class="subj-btn" id="tsub-comp" onclick="setSubject('Computer Science','💻','comp')">💻 Computer Sci</button>
          <button class="subj-btn" id="tsub-fr" onclick="setSubject('French','🇫🇷','lang')">🇫🇷 French</button>
        </div>
        <div class="tutor-chat">
          <div class="tutor-header">
            <div>
              <h3 id="tutor-subject-title">Mathematics Tutor</h3>
              <p>Ask me anything — I'll explain step by step</p>
            </div>
            <div style="display:flex;gap:.5rem">
              <button class="tts-btn" id="tts-toggle" onclick="toggleTTS()" title="Read aloud (Dyslexia support)">🔊</button>
            <button class="tts-btn" onclick="saveLastMsgToNotes()" title="Save to Notes">📓</button>
            <button class="img-upload-btn" onclick="document.getElementById('tutor-img-upload').click()" title="Upload image of question">📷</button>
            <input type="file" id="tutor-img-upload" accept="image/*" style="display:none" onchange="handleTutorImage(event)">
              <button class="btn btn-outline" style="font-size:.75rem" onclick="clearTutor()">Clear Chat</button>
            </div>
          </div>
          <div class="quick-actions">
            <button class="quick-btn" onclick="tutorQuick('Explain a key concept for me')">💡 Explain concept</button>
            <button class="quick-btn" onclick="tutorQuick('Give me a practice question')">📝 Practice question</button>
            <button class="quick-btn" onclick="tutorQuick('Give me exam technique tips')">🎯 Exam technique</button>
            <button class="quick-btn" onclick="tutorQuick('What are the most common exam topics?')">📋 Common topics</button>
            <button class="quick-btn" onclick="tutorQuick('Explain this simply as if I am 10 years old')">🧒 Simplify</button>
            <button class="quick-btn" onclick="showMolecule()">🧪 Molecules</button>
            <button class="quick-btn" onclick="showForce()">⚡ Force Diagram</button>
            <button class="quick-btn" onclick="toggleGeo()">📐 Geometry</button>
            <button class="quick-btn" onclick="openSR()">🧠 Flashcards</button>
          </div>
          <div class="tutor-messages" id="tutor-messages"></div>
          <div class="tutor-input-area">
            <div class="tutor-input-row">
              <textarea class="tutor-input" id="tutor-input" placeholder="Ask your tutor anything..." onkeydown="tutorKey(event)" rows="1"></textarea>
              <button class="tts-btn" id="speak-btn" onclick="speakInput()" title="Speak your question">🎤</button>
              <button class="tutor-send" onclick="tutorSend()">Send ✦</button>
            </div>
            <p style="font-size:.75rem;color:var(--muted);margin-top:.5rem;text-align:center">Your personal AI tutor</p>
          </div>
        </div>
      </div>
    </div>

    <!-- MOLECULE & FORCE PANELS (shown via tutor quick actions) -->
    <div id="molecule-panel" class="molecule-panel" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:1.5rem;z-index:800;width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.6)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
        <div style="font-weight:700">🧪 Molecule Viewer</div>
        <button onclick="document.getElementById('molecule-panel').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">✕</button>
      </div>
      <div style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">
        <button class="geo-tool active" onclick="drawMolecule('H2O')">H₂O</button>
        <button class="geo-tool" onclick="drawMolecule('CO2')">CO₂</button>
        <button class="geo-tool" onclick="drawMolecule('CH4')">CH₄</button>
        <button class="geo-tool" onclick="drawMolecule('NH3')">NH₃</button>
      </div>
      <canvas id="mol-canvas" width="400" height="320" style="border-radius:10px;background:#0A0C12;border:1px solid var(--border);width:100%"></canvas>
    </div>

    <div id="force-diagram-panel" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:1.5rem;z-index:800;width:560px;box-shadow:0 20px 60px rgba(0,0,0,0.6)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
        <div style="font-weight:700">⚡ Force Diagrams</div>
        <button onclick="document.getElementById('force-diagram-panel').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">✕</button>
      </div>
      <div class="force-scenario">
        <button class="force-scene-btn active" onclick="drawForceScene('freebody')">Free Body</button>
        <button class="force-scene-btn" onclick="drawForceScene('incline')">Inclined Plane</button>
        <button class="force-scene-btn" onclick="drawForceScene('circular')">Circular Motion</button>
      </div>
      <canvas id="force-canvas-el" width="500" height="280" style="border-radius:10px;background:#0A0C12;border:1px solid var(--border);width:100%"></canvas>
      <p style="font-size:.75rem;color:var(--muted);margin-top:.5rem;text-align:center">Click a scenario to switch · All forces drawn to scale</p>
    </div>

    <!-- QUESTIONS SUBPAGE -->
    <div class="subpage" id="sp-questions">
      <div class="page-title">📝 Question Paper Generator</div>
      <p class="page-subtitle">Generate exam-style questions tailored to your level and board</p>
      <div class="questions-layout">
        <div class="form-card">
          <div class="form-row">
            <div class="form-group"><label>Subject</label>
              <select id="q-subject">
                <option>Mathematics</option><option>Physics</option><option>Chemistry</option>
                <option>Biology</option><option>English Literature</option><option>History</option>
                <option>Computer Science</option><option>Economics</option><option>French</option>
              </select>
            </div>
            <div class="form-group"><label>Exam Board</label>
              <select id="q-board"><option>AQA</option><option>Edexcel</option><option>OCR</option><option>WJEC</option></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Level</label>
              <select id="q-level"><option>Foundation GCSE</option><option>Higher GCSE</option><option>AS Level</option><option>A-Level</option></select>
            </div>
            <div class="form-group"><label>Number of Questions</label>
              <select id="q-num"><option>3</option><option selected>5</option><option>8</option><option>10</option></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Question Type</label>
              <select id="q-type"><option>Mixed</option><option>Multiple Choice</option><option>Short Answer</option><option>Extended Writing</option><option>Calculation</option></select>
            </div>
            <div class="form-group"><label>Target Grade</label>
              <select id="q-grade"><option>Grade 4-5</option><option>Grade 6-7</option><option selected>Grade 7-8</option><option>Grade 8-9</option></select>
            </div>
          </div>
          <div class="form-group"><label>Specific Topics (optional)</label>
            <input type="text" id="q-topics" placeholder="e.g. Quadratics, Pythagoras, Trigonometry">
          </div>
          <button class="btn btn-gold" style="width:100%;padding:1rem;font-size:1rem" onclick="generateQuestions()">✦ Generate with Lumina AI</button>
        </div>
        <div class="gen-output" id="q-output">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
            <div><div class="page-title" style="font-size:1.4rem" id="q-output-title">Practice Paper</div>
            <p class="text-muted" id="q-output-sub">5 questions</p></div>
            <div style="display:flex;gap:.75rem">
              <button class="btn btn-outline" onclick="window.print()">🖨️ Print</button>
              <button class="btn btn-gold" onclick="generateQuestions()">↻ Regenerate</button>
            </div>
          </div>
          <div id="q-questions"></div>
        </div>
      </div>
    </div>

    <!-- PROGRESS SUBPAGE -->
    <div class="subpage" id="sp-progress">
      <div class="page-title">📊 Your Progress</div>
      <p class="page-subtitle">Track your improvement over time</p>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-card-label">Total Questions</div><div class="stat-card-value">1,247</div><div class="stat-card-change">↑ 12 today</div></div>
        <div class="stat-card"><div class="stat-card-label">Accuracy</div><div class="stat-card-value">78%</div><div class="stat-card-change">↑ 3% this week</div></div>
        <div class="stat-card"><div class="stat-card-label">Study Streak</div><div class="stat-card-value">14 🔥</div></div>
        <div class="stat-card"><div class="stat-card-label">Topics Mastered</div><div class="stat-card-value">0</div></div>
      </div>
      <div class="dash-grid">
        <div>
          <div class="card">
            <div class="card-header"><span class="card-title">Subject Performance</span></div>
            <div class="card-body">
              <div class="progress-item"><div class="progress-header"><span>Mathematics</span><span class="fw700" style="color:var(--blue)">72%</span></div><div class="progress-bar"><div class="progress-fill" style="width:72%;background:var(--blue)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>Biology</span><span class="fw700" style="color:var(--green)">81%</span></div><div class="progress-bar"><div class="progress-fill" style="width:81%;background:var(--green)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>Physics</span><span class="fw700" style="color:var(--purple)">65%</span></div><div class="progress-bar"><div class="progress-fill" style="width:65%;background:var(--purple)"></div></div></div>
              <div class="progress-item"><div class="progress-header"><span>Chemistry</span><span class="fw700" style="color:var(--orange)">58%</span></div><div class="progress-bar"><div class="progress-fill" style="width:58%;background:var(--orange)"></div></div></div>
            </div>
          </div>
          <!-- Heatmap -->
          <div class="card" style="margin-top:1.5rem">
            <div class="card-header"><span class="card-title">📅 Study Activity (Last 12 Weeks)</span></div>
            <div class="card-body">
              <div class="heatmap" id="heatmap"></div>
              <div style="display:flex;align-items:center;gap:.5rem;margin-top:1rem;font-size:.75rem;color:var(--muted)">
                Less <div style="width:14px;height:14px;background:var(--bg4);border-radius:2px"></div>
                <div style="width:14px;height:14px;background:rgba(201,168,76,0.2);border-radius:2px"></div>
                <div style="width:14px;height:14px;background:rgba(201,168,76,0.5);border-radius:2px"></div>
                <div style="width:14px;height:14px;background:var(--gold);border-radius:2px"></div> More
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <div class="card-header"><span class="card-title">🏆 Achievements</span></div>
            <div class="card-body">
              <div class="achievements-grid">
                <div class="ach-card earned"><div class="ach-icon">🔥</div><div class="ach-name">7-Day Streak</div><div class="ach-desc">Study 7 days in a row</div></div>
                <div class="ach-card earned"><div class="ach-icon">💯</div><div class="ach-name">Perfect Score</div><div class="ach-desc">100% on a paper</div></div>
                <div class="ach-card earned"><div class="ach-icon">🚀</div><div class="ach-name">Fast Learner</div><div class="ach-desc">Complete 100 questions</div></div>
                <div class="ach-card locked"><div class="ach-icon">⭐</div><div class="ach-name">Star Student</div><div class="ach-desc">30-day streak</div></div>
                <div class="ach-card locked"><div class="ach-icon">🎓</div><div class="ach-name">Graduate</div><div class="ach-desc">Master all topics</div></div>
                <div class="ach-card locked"><div class="ach-icon">🏆</div><div class="ach-name">Top of Class</div><div class="ach-desc">Score 95%+ average</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STRENGTHS SUBPAGE -->
    <div class="subpage" id="sp-strengths">
      <div class="page-title">🎯 Strengths & Weaknesses</div>
      <p class="page-subtitle">Know exactly what to focus on</p>
      <div style="margin-bottom:1.5rem">
        <button class="btn btn-gold" onclick="analyseStrengths()">✦ Run AI Analysis with Lumina AI</button>
      </div>
      <div class="strengths-grid">
        <div class="card">
          <div class="card-header" style="border-left:3px solid var(--green)"><span class="card-title">💪 Your Strengths</span></div>
          <div class="card-body" id="strengths-list">
            <div class="strength-item"><span class="sw-topic">Biology — Cell Structure</span><span class="sw-pct good">91%</span></div>
            <div class="strength-item"><span class="sw-topic">Maths — Algebra</span><span class="sw-pct good">88%</span></div>
            <div class="strength-item"><span class="sw-topic">English — Analysis</span><span class="sw-pct good">85%</span></div>
            <div class="strength-item"><span class="sw-topic">History — WW2</span><span class="sw-pct good">82%</span></div>
            <div class="strength-item"><span class="sw-topic">Physics — Waves</span><span class="sw-pct good">79%</span></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header" style="border-left:3px solid var(--red)"><span class="card-title">⚠️ Focus Areas</span></div>
          <div class="card-body" id="weaknesses-list">
            <div class="weakness-item"><span class="sw-topic">Maths — Trigonometry</span><span class="sw-pct bad">38%</span></div>
            <div class="weakness-item"><span class="sw-topic">Chemistry — Organic</span><span class="sw-pct bad">42%</span></div>
            <div class="weakness-item"><span class="sw-topic">Physics — Electricity</span><span class="sw-pct bad">45%</span></div>
            <div class="weakness-item"><span class="sw-topic">Maths — Statistics</span><span class="sw-pct bad">51%</span></div>
            <div class="weakness-item"><span class="sw-topic">Biology — Genetics</span><span class="sw-pct bad">55%</span></div>
          </div>
        </div>
      </div>
      <div class="card" id="ai-recs" style="margin-top:1.5rem;display:none">
        <div class="card-header"><span class="card-title">🤖 AI Recommendations</span></div>
        <div class="card-body" id="ai-recs-body"></div>
      </div>
    </div>


    <!-- NOTES SUBPAGE -->
    <div class="subpage" id="sp-notes">
      <div class="page-title">📓 My Notebook</div>
      <p class="page-subtitle">Save key explanations and notes from your AI tutor sessions</p>
      <div style="max-width:800px">
        <!-- Add note -->
        <div class="note-input-area">
          <textarea class="note-input" id="note-text-input" placeholder="Write a note, paste an AI explanation, or jot down a key formula...&#10;&#10;You can also use the ✦ Save to Notes button after any AI response."></textarea>
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem">
            <div class="note-tags" id="note-subject-tags">
              <span style="font-size:.75rem;color:var(--muted);align-self:center">Tag:</span>
              <button class="note-tag-btn selected" data-tag="Mathematics" onclick="selectNoteTag(this)">Mathematics</button>
              <button class="note-tag-btn" data-tag="Physics" onclick="selectNoteTag(this)">Physics</button>
              <button class="note-tag-btn" data-tag="Chemistry" onclick="selectNoteTag(this)">Chemistry</button>
              <button class="note-tag-btn" data-tag="Biology" onclick="selectNoteTag(this)">Biology</button>
              <button class="note-tag-btn" data-tag="English" onclick="selectNoteTag(this)">English</button>
              <button class="note-tag-btn" data-tag="History" onclick="selectNoteTag(this)">History</button>
              <button class="note-tag-btn" data-tag="General" onclick="selectNoteTag(this)">General</button>
            </div>
            <div style="display:flex;gap:.75rem">
              <button class="save-note-btn" onclick="saveNote()">💾 Save Note</button>
              <button class="save-note-btn" style="background:var(--bg3);color:var(--muted);border:1px solid var(--border)" onclick="aiSummariseNote()">✦ AI Summarise</button>
            </div>
          </div>
        </div>
        <!-- Filter -->
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem;align-items:center">
          <span style="font-size:.8rem;color:var(--muted)">Filter:</span>
          <button class="note-tag-btn selected" id="filter-all" onclick="filterNotes('all',this)">All</button>
          <button class="note-tag-btn" id="filter-Mathematics" onclick="filterNotes('Mathematics',this)">Mathematics</button>
          <button class="note-tag-btn" id="filter-Physics" onclick="filterNotes('Physics',this)">Physics</button>
          <button class="note-tag-btn" id="filter-Chemistry" onclick="filterNotes('Chemistry',this)">Chemistry</button>
          <button class="note-tag-btn" id="filter-Biology" onclick="filterNotes('Biology',this)">Biology</button>
          <button class="note-tag-btn" id="filter-English" onclick="filterNotes('English',this)">English</button>
          <button class="note-tag-btn" id="filter-History" onclick="filterNotes('History',this)">History</button>
          <button class="note-tag-btn" id="filter-General" onclick="filterNotes('General',this)">General</button>
        </div>
        <!-- Notes list -->
        <div id="notes-list">
          <div style="text-align:center;padding:3rem;color:var(--muted)">
            <div style="font-size:3rem;margin-bottom:1rem">📓</div>
            <div style="font-weight:700;margin-bottom:.5rem">No notes yet</div>
            <div style="font-size:.875rem">Write a note above, or use the "Save to Notes" button after any AI explanation</div>
          </div>
        </div>
      </div>
    </div>


    <!-- ═══ ESSAY MARKER ═══ -->
    <div class="subpage" id="sp-essay">
      <div class="page-title">✍️ Essay Marker</div>
      <p class="page-subtitle">Submit your essay for instant AI marking with grade, criteria breakdown, and detailed feedback</p>
      <div style="max-width:800px">
        <div class="form-row" style="grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
          <div class="form-group">
            <label class="form-label">Subject</label>
            <select class="form-select" id="essay-subject">
              <option>English Literature</option><option>English Language</option>
              <option>History</option><option>Geography</option><option>Biology</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Exam Board</label>
            <select class="form-select" id="essay-board">
              <option>AQA</option><option>Edexcel</option><option>OCR</option><option>WJEC</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:1rem">
          <label class="form-label">Essay Question / Title</label>
          <input type="text" class="form-input" id="essay-question" placeholder="e.g. How does Shakespeare present ambition in Macbeth?">
        </div>
        <div class="form-group" style="margin-bottom:1rem">
          <label class="form-label">Mark Scheme Focus (optional)</label>
          <input type="text" class="form-input" id="essay-markscheme" placeholder="e.g. AO1: 20 marks, AO2: 20 marks, AO3: 20 marks">
        </div>
        <!-- Image upload for essay question -->
        <div class="essay-dropzone" id="essay-img-drop" onclick="document.getElementById('essay-img-input').click()">
          <i class="fas fa-image"></i>
          <div style="font-weight:600;margin-bottom:.25rem">Upload question image (optional)</div>
          <div style="font-size:.8rem;color:var(--muted)">Photograph your question paper or mark scheme</div>
          <input type="file" id="essay-img-input" accept="image/*" style="display:none" onchange="handleEssayImage(event)">
        </div>
        <div class="form-group" style="margin-bottom:1.5rem">
          <label class="form-label">Your Essay</label>
          <textarea class="form-textarea" id="essay-text" rows="14" placeholder="Paste or type your essay here...&#10;&#10;Minimum 100 words for accurate marking."></textarea>
        </div>
        <button class="btn-gold" onclick="markEssay()" id="essay-submit-btn" style="width:100%;padding:1rem;font-size:1rem">✦ Mark My Essay</button>

        <!-- Results -->
        <div id="essay-results" style="display:none;margin-top:2rem">
          <div style="display:flex;align-items:center;gap:2rem;margin-bottom:2rem;flex-wrap:wrap">
            <div class="essay-grade grade-a" id="essay-grade-circle">—</div>
            <div>
              <div style="font-size:1.5rem;font-weight:800" id="essay-grade-label">—</div>
              <div style="color:var(--muted);font-size:.875rem" id="essay-marks-label">Calculating...</div>
            </div>
          </div>
          <div id="essay-criteria-bars" style="margin-bottom:2rem"></div>
          <div style="background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:1rem">
            <div style="font-weight:700;margin-bottom:1rem">📋 Detailed Feedback</div>
            <div id="essay-feedback-text" style="font-size:.9rem;line-height:1.8;color:var(--muted)"></div>
          </div>
          <div style="background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.2);border-radius:16px;padding:1.5rem;margin-bottom:1rem">
            <div style="font-weight:700;margin-bottom:1rem;color:var(--green)">💡 How to Improve</div>
            <div id="essay-improve-text" style="font-size:.9rem;line-height:1.8"></div>
          </div>
          <div style="display:flex;gap:.75rem;flex-wrap:wrap">
            <button class="btn-gold" onclick="markEssay()">↺ Mark Again</button>
            <button class="vid-ctrl-btn" onclick="exportEssayFeedback()">⬇ Download Feedback</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ EXAM COUNTDOWN ═══ -->
    <div class="subpage" id="sp-exams">
      <div class="page-title">📅 Exam Countdown</div>
      <p class="page-subtitle">Track your upcoming exams and stay on schedule</p>
      <div style="max-width:800px">
        <!-- Add exam form -->
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-bottom:2rem">
          <div style="font-weight:700;margin-bottom:1rem">➕ Add Exam</div>
          <div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:1rem">
            <div class="form-group">
              <label class="form-label">Subject</label>
              <input type="text" class="form-input" id="new-exam-subject" placeholder="e.g. Mathematics">
            </div>
            <div class="form-group">
              <label class="form-label">Board</label>
              <select class="form-select" id="new-exam-board">
                <option>AQA</option><option>Edexcel</option><option>OCR</option><option>WJEC</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Exam Date</label>
              <input type="date" class="form-input" id="new-exam-date">
            </div>
          </div>
          <button class="btn-gold" onclick="addExam()" style="margin-top:.75rem">Add Exam</button>
        </div>
        <!-- Exams list -->
        <div id="exams-list">
          <div style="text-align:center;padding:3rem;color:var(--muted)">
            <div style="font-size:3rem;margin-bottom:1rem">📅</div>
            <div style="font-weight:700;margin-bottom:.5rem">No exams added yet</div>
            <div style="font-size:.875rem">Add your exam dates above to start the countdown</div>
          </div>
        </div>
        <!-- Revision timetable generator -->
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:16px;padding:1.5rem;margin-top:2rem">
          <div style="font-weight:700;margin-bottom:.5rem">📆 Generate Revision Timetable</div>
          <div style="font-size:.875rem;color:var(--muted);margin-bottom:1rem">Lumina AI builds a personalised weekly revision schedule based on your exams</div>
          <div class="form-row" style="grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
            <div class="form-group">
              <label class="form-label">Study hours per day</label>
              <select class="form-select" id="tt-hours">
                <option value="2">2 hours</option><option value="3">3 hours</option>
                <option value="4" selected>4 hours</option><option value="6">6 hours</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Rest day</label>
              <select class="form-select" id="tt-rest">
                <option>Sunday</option><option>Saturday</option><option>None</option>
              </select>
            </div>
          </div>
          <button class="btn-gold" onclick="generateTimetable()" id="tt-gen-btn">✦ Generate My Timetable</button>
          <div id="timetable-output" style="margin-top:1.5rem;display:none"></div>
        </div>
      </div>
    </div>

    <!-- ═══ CHAT HISTORY ═══ -->
    <div class="subpage" id="sp-history">
      <div class="page-title">🕐 Chat History</div>
      <p class="page-subtitle">Your saved tutor conversations</p>
      <div style="max-width:800px">
        <div style="display:flex;gap:.75rem;margin-bottom:1.5rem;flex-wrap:wrap">
          <input type="text" class="glossary-search-bar" id="history-search" placeholder="🔍 Search conversations..." style="margin:0;flex:1" oninput="filterHistory(this.value)">
          <button class="vid-ctrl-btn" onclick="clearHistory()">🗑️ Clear All</button>
        </div>
        <div id="history-list">
          <div style="text-align:center;padding:3rem;color:var(--muted)">
            <div style="font-size:3rem;margin-bottom:1rem">💬</div>
            <div style="font-weight:700;margin-bottom:.5rem">No conversations yet</div>
            <div style="font-size:.875rem">Your tutor sessions will be saved here automatically</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ GLOSSARY ═══ -->
    <div class="subpage" id="sp-glossary">
      <div class="page-title">📖 Subject Glossary</div>
      <p class="page-subtitle">AI-powered definitions for every topic</p>
      <div style="max-width:800px">
        <div style="display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap">
          <input type="text" class="glossary-search-bar" id="glossary-search" placeholder="🔍 Search terms e.g. photosynthesis, quadratic, osmosis..." style="margin:0;flex:1" oninput="searchGlossary(this.value)">
          <select class="form-select" id="glossary-subject" onchange="loadGlossary()" style="width:auto">
            <option>Mathematics</option><option>Physics</option><option>Chemistry</option>
            <option>Biology</option><option>English Literature</option><option>History</option>
          </select>
        </div>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem" id="glossary-alpha">
          <button class="note-tag-btn selected" onclick="filterGlossaryLetter('all',this)">All</button>
        </div>
        <div id="glossary-list">
          <div style="text-align:center;padding:3rem;color:var(--muted)">
            <div style="font-size:3rem;margin-bottom:1rem">📖</div>
            <div style="font-weight:700;margin-bottom:.5rem">Search for a term or select a subject</div>
            <div style="font-size:.875rem">Lumina AI will generate clear definitions with examples</div>
          </div>
        </div>
        <button class="btn-gold" onclick="lookupTerm()" style="margin-top:1rem" id="glossary-lookup-btn" style="display:none">✦ Look Up with AI</button>
      </div>
    </div>

    <!-- ═══ PAST PAPERS ═══ -->
    <div class="subpage" id="sp-papers">
      <div class="page-title">📄 Past Papers</div>
      <p class="page-subtitle">AI-generated exam questions organised by topic and board</p>
      <div style="max-width:800px">
        <div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:1.5rem">
          <div class="form-group">
            <label class="form-label">Subject</label>
            <select class="form-select" id="pp-subject" onchange="loadPastPapers()">
              <option>Mathematics</option><option>Physics</option><option>Chemistry</option>
              <option>Biology</option><option>English Literature</option><option>History</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Exam Board</label>
            <select class="form-select" id="pp-board" onchange="loadPastPapers()">
              <option>AQA</option><option>Edexcel</option><option>OCR</option><option>WJEC</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Difficulty</label>
            <select class="form-select" id="pp-diff" onchange="loadPastPapers()">
              <option>Foundation</option><option>Higher</option><option>A-Level</option>
            </select>
          </div>
        </div>
        <button class="btn-gold" onclick="generatePastPaper()" style="margin-bottom:1.5rem">✦ Generate Paper</button>
        <div id="papers-list"></div>
      </div>
    </div>

    <!-- ═══ VIDEO GENERATOR ═══ -->
    <div class="subpage" id="sp-video">
      <div class="page-title">🎬 Video Explainer</div>
      <p class="page-subtitle">Generate a step-by-step animated video explanation for any topic</p>
      <div style="max-width:800px">
        <div class="vid-gen-form">
          <div class="form-row" style="grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
            <div class="form-group">
              <label class="form-label">Subject</label>
              <select class="form-select" id="vid-subject">
                <option>Mathematics</option><option>Physics</option><option>Chemistry</option>
                <option>Biology</option><option>English Literature</option><option>History</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Level</label>
              <select class="form-select" id="vid-level">
                <option>Foundation GCSE</option><option>Higher GCSE</option><option>A-Level</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:1rem">
            <label class="form-label">Topic to Explain</label>
            <input type="text" class="form-input" id="vid-topic" placeholder="e.g. Pythagoras Theorem, Osmosis, The French Revolution">
          </div>
          <div class="form-group" style="margin-bottom:1rem">
            <label class="form-label">Style</label>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="note-tag-btn selected" data-style="step-by-step" onclick="selectVidStyle(this)">📝 Step by Step</button>
              <button class="note-tag-btn" data-style="story" onclick="selectVidStyle(this)">📖 Story Format</button>
              <button class="note-tag-btn" data-style="visual" onclick="selectVidStyle(this)">🎨 Visual & Diagrams</button>
              <button class="note-tag-btn" data-style="exam" onclick="selectVidStyle(this)">🎯 Exam Focused</button>
            </div>
          </div>
          <button class="btn-gold" onclick="generateVideo()" id="vid-gen-btn" style="width:100%;padding:1rem">🎬 Generate Video Explanation</button>
        </div>

        <div id="vid-output" style="display:none">
          <div class="vid-progress-bar"><div class="vid-progress-fill" id="vid-prog"></div></div>
          <div class="vid-gen-preview" id="vid-preview">
            <div class="vid-gen-scene" id="vid-scene">
              <div class="vid-scene-title" id="vid-scene-title">Loading...</div>
              <div class="vid-scene-content" id="vid-scene-content"></div>
            </div>
          </div>
          <div class="vid-controls">
            <button class="vid-ctrl-btn primary" id="vid-play-btn" onclick="toggleVidPlay()">⏸ Pause</button>
            <button class="vid-ctrl-btn" onclick="vidPrev()">⬅ Prev</button>
            <button class="vid-ctrl-btn" onclick="vidNext()">Next ➡</button>
            <span style="font-size:.8rem;color:var(--muted)" id="vid-slide-counter">Scene 1 of 1</span>
            <button class="vid-ctrl-btn" onclick="saveVideoToNotes()">📓 Save to Notes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ LEADERBOARD ═══ -->
    <div class="subpage" id="sp-leaderboard">
      <div class="page-title">🏆 Leaderboard</div>
      <p class="page-subtitle">See how you rank against other Lumina learners this week</p>
      <div style="max-width:640px">
        <div style="display:flex;gap:.5rem;margin-bottom:1.5rem">
          <button class="note-tag-btn selected" onclick="switchLBTab('weekly',this)">This Week</button>
          <button class="note-tag-btn" onclick="switchLBTab('alltime',this)">All Time</button>
          <button class="note-tag-btn" onclick="switchLBTab('subject',this)">By Subject</button>
        </div>
        <div id="lb-list"></div>
        <div id="lb-your-rank" style="margin-top:1.5rem"></div>
      </div>
    </div>

    <!-- ASSIGNMENTS SUBPAGE -->
    <div class="subpage" id="sp-assignments">
      <div class="page-title">📋 Assignments</div>
      <p class="page-subtitle">Teacher-set homework and AI-assisted completion</p>
      <div class="assign-tabs">
        <button class="assign-tab active" id="at-student" onclick="switchAssign('student')">👨‍🎓 Student View</button>
        <button class="assign-tab" id="at-teacher" onclick="switchAssign('teacher')">👨‍🏫 Teacher View</button>
      </div>
      <div class="assign-view active" id="av-student">
        <div class="assign-card">
          <div class="assign-header">
            <div class="assign-title">Algebra Practice — Quadratics</div>
            <span class="status-badge status-due">Due Soon</span>
          </div>
          <div class="assign-meta">📚 Mathematics · AQA Higher · Due: Tomorrow · 20 marks</div>
          <p style="font-size:.875rem;color:var(--muted);margin-bottom:1rem">Solve the following quadratic equations and show all working. Use the quadratic formula where necessary.</p>
          <div style="display:flex;gap:.75rem">
            <button class="btn btn-gold" onclick="openAssignment(1)">Start Assignment</button>
            <button class="btn btn-outline" onclick="getHint(1)">💡 Get AI Hint</button>
          </div>
        </div>
        <div class="assign-card">
          <div class="assign-header">
            <div class="assign-title">Forces & Newton's Laws Essay</div>
            <span class="status-badge status-new">New</span>
          </div>
          <div class="assign-meta">⚡ Physics · Edexcel · Due: Friday · 15 marks</div>
          <p style="font-size:.875rem;color:var(--muted);margin-bottom:1rem">Write an extended answer explaining Newton's three laws of motion with real-world examples.</p>
          <div style="display:flex;gap:.75rem">
            <button class="btn btn-gold" onclick="openAssignment(2)">Start Assignment</button>
            <button class="btn btn-outline" onclick="getHint(2)">💡 Get AI Hint</button>
          </div>
        </div>
      </div>
      <div class="assign-view" id="av-teacher">
        <div class="form-card">
          <h3 style="font-weight:700;margin-bottom:1.5rem">Create New Assignment</h3>
          <div class="form-row">
            <div class="form-group"><label>Title</label><input type="text" id="asgn-title" placeholder="Assignment title"></div>
            <div class="form-group"><label>Subject</label><select id="asgn-subject"><option>Mathematics</option><option>Physics</option><option>Chemistry</option><option>Biology</option><option>English Literature</option><option>History</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Year Group</label><select id="asgn-year"><option>Year 10</option><option>Year 11</option><option>Year 12</option><option>Year 13</option></select></div>
            <div class="form-group"><label>Due Date</label><input type="date" id="asgn-due"></div>
          </div>
          <div class="form-group"><label>Instructions</label><textarea style="width:100%;padding:.875rem;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--white);font-family:var(--font-body);min-height:80px;resize:vertical" id="asgn-instructions" placeholder="What should students do?"></textarea></div>
          <div style="display:flex;gap:.75rem">
            <button class="btn btn-gold" style="padding:.875rem 1.5rem" onclick="createAssignment()">✦ Generate with Lumina AI</button>
            <button class="btn btn-outline" style="padding:.875rem 1.5rem" onclick="saveAssignment()">💾 Save & Assign</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS SUBPAGE -->
    <div class="subpage" id="sp-settings">
      <div class="page-title">⚙️ Settings</div>
      <p class="page-subtitle">Manage your account and learning preferences</p>
      <div class="settings-section">
        <h3>🎨 Accessibility Settings</h3>
        <p style="font-size:.85rem;color:var(--muted);margin-bottom:1.25rem">Each setting works independently — enable any combination that helps you learn best.</p>
        <div class="a11y-full-card">
          <div class="a11y-full-header">
            <h4>⚡ ADHD Mode</h4>
            <div class="toggle" id="tog-adhd" onclick="toggleMode('adhd')"></div>
          </div>
          <p class="a11y-desc">Breaks content into numbered steps. Adds focus timers. Highlights key information. Shows break reminders every 25 minutes.</p>
        </div>
        <div class="a11y-full-card">
          <div class="a11y-full-header">
            <h4>📖 Dyslexia Mode</h4>
            <div class="toggle" id="tog-dyslexia" onclick="toggleMode('dyslexia')"></div>
          </div>
          <p class="a11y-desc">Switches to Lexend font with wider letter spacing and increased line height. Adds audio read-aloud button to all content.</p>
        </div>
        <div class="a11y-full-card">
          <div class="a11y-full-header">
            <h4>🧮 Dyscalculia Mode</h4>
            <div class="toggle" id="tog-dyscalculia" onclick="toggleMode('dyscalculia')"></div>
          </div>
          <p class="a11y-desc">Opens a visual calculator with number line, colour-coded operations, and step-by-step breakdowns. All maths shown visually.</p>
        </div>
      </div>
      <div class="settings-section">
        <h3>🎨 Display & Language</h3>
        <div class="setting-row">
          <div class="setting-info"><h4>☀️ Light Mode</h4><p>Switch to a light background</p></div>
          <div class="toggle" id="tog-light" onclick="toggleLightMode()"></div>
        </div>
        <div class="setting-row">
          <div class="setting-info"><h4>🔤 Text Size</h4><p>Adjust the font size across the app</p></div>
          <div class="font-size-control">
            <button class="fs-btn" onclick="changeFontSize(-1)">A−</button>
            <span class="fs-display" id="fs-display">100%</span>
            <button class="fs-btn" onclick="changeFontSize(1)">A+</button>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-info"><h4>🏴󠁷󠁢󠁷󠁬󠁳󠁿 Language / Iaith</h4><p>Switch between English and Welsh / Newid rhwng Cymraeg a Saesneg</p></div>
          <div class="lang-toggle">
            <button class="lang-btn active" id="lang-en" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" id="lang-cy" onclick="setLanguage('cy')">CY</button>
          </div>
        </div>
        <div class="setting-row">
          <div class="setting-info"><h4>☀️ Light Mode</h4><p>Switch to a light background for studying in bright environments</p></div>
          <div class="toggle" id="tog-light" onclick="toggleLightMode()"></div>
        </div>
        <div class="setting-row">
          <div class="setting-info"><h4>⏱️ Pomodoro Timer</h4><p>Focus timer with study/break intervals (25 min focus, 5 min break)</p></div>
          <div class="toggle on" id="tog-pom" onclick="document.getElementById('pom-float').classList.toggle('show')"></div>
        </div>
      </div>
      <div class="settings-section">
        <h3>🔔 Notifications</h3>
        <div class="setting-row"><div class="setting-info"><h4>Study Reminders</h4><p>Get notified when it's time to study</p></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="setting-row"><div class="setting-info"><h4>Assignment Due Dates</h4><p>Reminders 24h before deadlines</p></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="setting-row"><div class="setting-info"><h4>Achievement Unlocked</h4><p>Celebrate your milestones</p></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section">
        <h3>🔐 Privacy & Data</h3>
        <div class="setting-row"><div class="setting-info"><h4>Download My Data</h4><p>Export all your learning data (GDPR)</p></div><button class="btn btn-outline" style="font-size:.8rem;padding:.5rem 1rem">Download</button></div>
        <div class="setting-row"><div class="setting-info"><h4>Delete Account</h4><p>Permanently delete your account and all data</p></div><button class="btn" style="background:rgba(251,113,133,0.1);color:var(--red);border:1px solid rgba(251,113,133,0.3);font-size:.8rem;padding:.5rem 1rem;border-radius:8px;cursor:pointer">Delete</button></div>
      </div>
    </div>

  </div><!-- end main-content -->
</div><!-- end page-dashboard -->

<!-- ═══════════════════════ PRIVACY PAGE ═══════════════════════ -->
<div id="page-privacy" class="page">
  <div class="privacy-body">
    <h1>Privacy Policy</h1>
    <p>Last updated: January 2025</p>
    <h2>1. Data We Collect</h2>
    <p>We collect your name, email, learning profile (including any learning difficulties you disclose), and learning activity data including questions answered, tutor conversations, and progress metrics.</p>
    <h2>2. How We Use Your Data</h2>
    <p>Your data is used exclusively to personalise your learning experience. Learning difficulty information is used to adapt the AI tutor, font settings, question formatting, and accessibility features.</p>
    <h2>3. AI Conversations</h2>
    <p>Your conversations with the AI tutor are processed via the Anthropic API. These conversations are used to provide responses and are not stored permanently beyond your active session.</p>
    <h2>4. Your Rights (GDPR)</h2>
    <p>You have the right to: access your data, correct inaccurate data, delete your data, export your data, and withdraw consent at any time. Contact us at privacy@luminaai.co.uk.</p>
    <h2>5. Data for Minors</h2>
    <p>For users under 13, we require parental consent. We collect minimal data and do not use it for any purpose beyond providing the educational service.</p>
    <h2>6. Cookies</h2>
    <p>We use essential cookies for authentication and optional analytics cookies (which you can decline). We do not use advertising cookies.</p>
    <p><button class="btn btn-gold" onclick="nav('home')">← Back to Home</button></p>
  </div>
</div>

<!-- ═══════════════════════ DYSCALCULIA CALCULATOR ═══════════════════════ -->
<div id="calc-overlay">
  <div class="calc-title">
    🧮 Visual Calculator
    <button onclick="document.getElementById('calc-overlay').classList.remove('show')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">✕</button>
  </div>
  <div class="calc-visual" id="calc-display">0</div>
  <div class="calc-btn-grid">
    <button class="calc-key" onclick="calcInput('7')">7</button>
    <button class="calc-key" onclick="calcInput('8')">8</button>
    <button class="calc-key" onclick="calcInput('9')">9</button>
    <button class="calc-key op" onclick="calcInput('÷')">÷</button>
    <button class="calc-key" onclick="calcInput('4')">4</button>
    <button class="calc-key" onclick="calcInput('5')">5</button>
    <button class="calc-key" onclick="calcInput('6')">6</button>
    <button class="calc-key op" onclick="calcInput('×')">×</button>
    <button class="calc-key" onclick="calcInput('1')">1</button>
    <button class="calc-key" onclick="calcInput('2')">2</button>
    <button class="calc-key" onclick="calcInput('3')">3</button>
    <button class="calc-key op" onclick="calcInput('−')">−</button>
    <button class="calc-key" onclick="calcInput('0')">0</button>
    <button class="calc-key" onclick="calcInput('.')">.</button>
    <button class="calc-key eq" onclick="calcEquals()">=</button>
    <button class="calc-key op" onclick="calcInput('+')">+</button>
    <button class="calc-key op" style="grid-column:span 2" onclick="calcClear()">Clear</button>
    <button class="calc-key op" style="grid-column:span 2" onclick="calcDelete()">⌫ Delete</button>
  </div>
  <div class="calc-number-line" id="calc-number-line">
    <div class="number-line" id="nl"></div>
  </div>
</div>

<!-- ═══════════════════════ TOAST & XP ═══════════════════════ -->
<div id="toast"></div>
<div id="xp-popup">+50 XP ⭐</div>

<!-- ═══════════════════════ COOKIE BANNER ═══════════════════════ -->
<div id="cookie-banner">
  <p class="cookie-text">We use cookies to improve your experience and comply with GDPR. See our <a onclick="nav('privacy')">Privacy Policy</a>.</p>
  <div class="cookie-btns">
    <button class="btn btn-outline" style="font-size:.8rem" onclick="document.getElementById('cookie-banner').remove()">Reject</button>
    <button class="btn btn-gold" style="font-size:.8rem" onclick="document.getElementById('cookie-banner').remove()">Accept All</button>
  </div>
</div>

<!-- ═══════════════════════ JAVASCRIPT ═══════════════════════ -->
<script>
// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
const state = {
  user: null,
  xp: 0,
  level: 1,
  modes: { adhd: false, dyslexia: false, dyscalculia: false },
  subject: 'Mathematics',
  subjectColor: 'math',
  tutorHistory: [],
  dashHistory: [],
  selectedPlan: 'student',
  selectedDiffs: [],
  currentSubpage: 'home',
  ttsEnabled: false,
  calcValue: '',
  calcPrev: '',
  calcOp: ''
};

// ═══════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════
function nav(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (el) el.classList.add('active');

  if (page === 'auth') {
    document.getElementById('public-nav').style.display = 'flex';
    document.getElementById('app-nav').style.display = 'none';
    document.getElementById('auth-buttons').style.display = 'flex';
    document.getElementById('user-menu').style.display = 'none';
    document.getElementById('a11y-bar').style.display = 'none';
    document.getElementById('xp-badge').style.display = 'none';
  }

  if (page === 'home' && !state.user) {
    document.getElementById('public-nav').style.display = 'flex';
    document.getElementById('app-nav').style.display = 'none';
    document.getElementById('auth-buttons').style.display = 'flex';
    document.getElementById('user-menu').style.display = 'none';
    document.getElementById('a11y-bar').style.display = 'none';
    document.getElementById('xp-badge').style.display = 'none';
  }
}

function scrollTo(sel) {
  const el = document.querySelector(sel);
  if (el) el.scrollIntoView({ behavior: 'smooth' });
}

function showDash(sub) {
  document.querySelectorAll('.subpage').forEach(s => s.classList.remove('active'));
  document.getElementById('sp-' + sub).classList.add('active');
  document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
  const si = document.getElementById('si-' + sub);
  if (si) si.classList.add('active');
  document.querySelectorAll('#app-nav a').forEach(a => a.classList.remove('active'));
  state.currentSubpage = sub;

  if (sub === 'progress') buildHeatmap();
  if (sub === 'home') {
    updateGreeting();
    if (state.dashHistory.length === 0) addDashMsg('bot', "Hello! I'm your Lumina AI tutor. What would you like to learn today? 🎓");
  }
  if (sub === 'tutor') {
    if (state.tutorHistory.length === 0) addTutorMsg('bot', `Hello! I'm your ${state.subject} tutor, here to help. I can explain concepts step-by-step, create practice questions, or help with exam technique.\n\nWhat would you like to work on today? ✦`);
  }
}

// ═══════════════════════════════════════
// AUTH
// ═══════════════════════════════════════
function selectPlan(p) {
  state.selectedPlan = p;
  document.getElementById('plan-student').classList.toggle('selected', p === 'student');
  document.getElementById('plan-home').classList.toggle('selected', p === 'home');
}

function toggleDiff(d) {
  if (d === 'none') {
    state.selectedDiffs = [];
    document.querySelectorAll('.diff-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('diff-none').classList.add('selected');
    return;
  }
  document.getElementById('diff-none').classList.remove('selected');
  const el = document.getElementById('diff-' + d);
  if (state.selectedDiffs.includes(d)) {
    state.selectedDiffs = state.selectedDiffs.filter(x => x !== d);
    el.classList.remove('selected');
  } else {
    state.selectedDiffs.push(d);
    el.classList.add('selected');
  }
}

function nextStep(from) {
  if (from === 1) {
    const name = document.getElementById('reg-name').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-pass').value;
    if (!name || !email || !pass) { showToast('Please fill in all fields'); return; }
    if (pass.length < 8) { showToast('Password must be at least 8 characters'); return; }
  }
  document.getElementById('step' + from).classList.remove('active');
  document.getElementById('step' + (from + 1)).classList.add('active');
  for (let i = 1; i <= 4; i++) {
    const dot = document.getElementById('dot' + i);
    dot.classList.toggle('active', i <= from + 1);
  }
  if (from === 3) {
    const diffs = state.selectedDiffs.length ? state.selectedDiffs.join(', ') : 'No specific needs';
    document.getElementById('profile-summary').innerHTML = `
      <strong>Plan:</strong> ${state.selectedPlan === 'student' ? 'Student (£60/mo)' : 'Homeschool (£200/mo)'}<br>
      <strong>Year:</strong> ${document.getElementById('reg-year').value}<br>
      <strong>Subject:</strong> ${document.getElementById('reg-subject').value}<br>
      <strong>Learning needs:</strong> ${diffs}
    `;
  }
}

function prevStep(to) {
  document.querySelectorAll('.auth-step').forEach(s => s.classList.remove('active'));
  document.getElementById('step' + to).classList.add('active');
  for (let i = 1; i <= 4; i++) {
    document.getElementById('dot' + i).classList.toggle('active', i <= to);
  }
}

function createAccount() {
  if (!document.getElementById('gdpr-check').checked) {
    showToast('Please accept the privacy policy to continue'); return;
  }
  const name = document.getElementById('reg-name').value;
  const email = document.getElementById('reg-email').value;
  state.user = {
    name, email,
    plan: state.selectedPlan,
    year: document.getElementById('reg-year').value,
    subject: document.getElementById('reg-subject').value,
    board: document.getElementById('reg-board').value,
    diffs: state.selectedDiffs
  };
  try { localStorage.setItem('lumina_user', JSON.stringify(state.user)); } catch(e) {}
  applyLearningProfile();
  enterDashboard();
  addXP(100, '🎉 Welcome bonus!');
}

function loginUser() {
  const email = document.getElementById('login-email').value;
  const pass = document.getElementById('login-pass').value;
  if (!email || !pass) { showToast('Please enter your email and password'); return; }
  // In a real app this would verify with a backend
  // For demo, restore from localStorage or create demo user
  try {
    const saved = localStorage.getItem('lumina_user');
    if (saved) { state.user = JSON.parse(saved); }
    else {
      state.user = { name: email.split('@')[0], email, plan: 'student', diffs: [] };
    }
  } catch(e) {
    state.user = { name: 'Student', email, plan: 'student', diffs: [] };
  }
  applyLearningProfile();
  enterDashboard();
}

function logout() {
  state.user = null;
  state.tutorHistory = [];
  state.dashHistory = [];
  try { localStorage.removeItem('lumina_user'); } catch(e) {}
  document.getElementById('app-nav').style.display = 'none';
  document.getElementById('public-nav').style.display = 'flex';
  document.getElementById('auth-buttons').style.display = 'flex';
  document.getElementById('user-menu').style.display = 'none';
  document.getElementById('a11y-bar').style.display = 'none';
  document.getElementById('xp-badge').style.display = 'none';
  nav('home');
  showToast('Logged out successfully');
}

function enterDashboard() {
  // Update sidebar
  const u = state.user;
  document.getElementById('sb-name').textContent = u.name;
  document.getElementById('sb-plan').textContent = u.plan === 'student' ? 'Student Plan' : 'Homeschool Plan';
  document.getElementById('sb-avatar').textContent = u.name.charAt(0).toUpperCase();
  document.getElementById('dash-greeting').textContent = `${getGreeting()}, ${u.name.split(' ')[0]}! 👋`;

  // Swap nav
  document.getElementById('public-nav').style.display = 'none';
  document.getElementById('app-nav').style.display = 'flex';
  document.getElementById('auth-buttons').style.display = 'none';
  document.getElementById('user-menu').style.display = 'flex';
  document.getElementById('a11y-bar').style.display = 'flex';
  document.getElementById('xp-badge').style.display = 'flex';

  nav('dashboard');
  showDash('home');
}

function showSignup() {
  document.getElementById('signup-flow').style.display = 'block';
  document.getElementById('login-form').classList.remove('active');
}

function showLogin() {
  document.getElementById('signup-flow').style.display = 'none';
  document.getElementById('login-form').classList.add('active');
}

// Check auth tabs
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.auth-tab').forEach((tab, i) => {
    tab.addEventListener('click', () => {
      if (i === 0) showSignup();
      else showLogin();
    });
  });
  // Check for saved session
  try {
    const saved = localStorage.getItem('lumina_user');
    if (saved) {
      state.user = JSON.parse(saved);
      applyLearningProfile();
    }
  } catch(e) {}
  buildNumberLine(0);
});

// ═══════════════════════════════════════
// ACCESSIBILITY MODES
// ═══════════════════════════════════════
function applyLearningProfile() {
  if (!state.user || !state.user.diffs) return;
  const diffs = state.user.diffs;
  if (diffs.includes('adhd')) setMode('adhd', true);
  if (diffs.includes('dyslexia')) setMode('dyslexia', true);
  if (diffs.includes('dyscalculia')) setMode('dyscalculia', true);
}

function setMode(mode, on) {
  state.modes[mode] = on;
  document.body.classList.toggle('mode-' + mode, on);
  const btn = document.getElementById('btn-' + mode);
  if (btn) btn.classList.toggle('on', on);
  const tog = document.getElementById('tog-' + mode);
  if (tog) tog.classList.toggle('on', on);
  if (mode === 'dyscalculia') {
    document.getElementById('calc-overlay').classList.toggle('show', on);
  }
}

function toggleMode(mode) {
  setMode(mode, !state.modes[mode]);
  if (mode === 'adhd' && state.modes[mode]) showToast('⚡ ADHD Mode ON — content will be broken into steps');
  if (mode === 'dyslexia' && state.modes[mode]) showToast('📖 Dyslexia Mode ON — Lexend font enabled');
  if (mode === 'dyscalculia' && state.modes[mode]) showToast('🧮 Dyscalculia Mode ON — visual calculator opened');
}

// ═══════════════════════════════════════
// CALCULATOR
// ═══════════════════════════════════════
function calcInput(val) {
  const ops = ['+', '−', '×', '÷'];
  if (ops.includes(val)) {
    if (state.calcValue) {
      state.calcPrev = state.calcValue;
      state.calcOp = val;
      state.calcValue = '';
    }
  } else {
    if (state.calcValue === '0' && val !== '.') state.calcValue = val;
    else state.calcValue += val;
  }
  updateCalcDisplay();
}

function calcEquals() {
  if (!state.calcPrev || !state.calcOp || !state.calcValue) return;
  const a = parseFloat(state.calcPrev), b = parseFloat(state.calcValue);
  let result;
  if (state.calcOp === '+') result = a + b;
  else if (state.calcOp === '−') result = a - b;
  else if (state.calcOp === '×') result = a * b;
  else if (state.calcOp === '÷') result = b !== 0 ? a / b : 'Error';
  const disp = document.getElementById('calc-display');
  disp.innerHTML = `<span style="color:var(--muted);font-size:.9rem">${state.calcPrev} ${state.calcOp} ${state.calcValue} =</span><br><span style="font-size:1.5rem;color:var(--gold)">${result}</span>`;
  buildNumberLine(result);
  state.calcValue = String(result);
  state.calcPrev = '';
  state.calcOp = '';
}

function calcClear() {
  state.calcValue = '';
  state.calcPrev = '';
  state.calcOp = '';
  document.getElementById('calc-display').textContent = '0';
  buildNumberLine(0);
}

function calcDelete() {
  state.calcValue = state.calcValue.slice(0, -1);
  updateCalcDisplay();
}

function updateCalcDisplay() {
  const disp = document.getElementById('calc-display');
  let shown = '';
  if (state.calcPrev) shown += `${state.calcPrev} ${state.calcOp} `;
  shown += state.calcValue || '0';
  disp.textContent = shown;
  const num = parseFloat(state.calcValue || '0');
  if (!isNaN(num)) buildNumberLine(num);
}

function buildNumberLine(highlight) {
  const container = document.getElementById('nl');
  if (!container) return;
  const hl = Math.round(highlight);
  const start = Math.max(0, hl - 5);
  const end = start + 10;
  let html = '';
  for (let i = start; i <= end; i++) {
    html += `<div class="nl-num ${i === hl ? 'highlight' : ''}">${i}</div>`;
    if (i < end) html += '<div class="nl-line"></div>';
  }
  container.innerHTML = html;
}

// ═══════════════════════════════════════
// CLAUDE API
// ═══════════════════════════════════════
async function callClaude(messages, system) {
  const body = {
    model: 'claude-opus-4-6',
    max_tokens: 1500,
    messages
  };
  if (system) body.system = system;
  let r;
  try {
    r = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
  } catch (netErr) {
    throw new Error('Network error — check /api/chat is deployed: ' + netErr.message);
  }
  const text = await r.text();
  let data;
  try { data = JSON.parse(text); } catch (e) { throw new Error('Bad API response (' + r.status + '): ' + text.slice(0, 200)); }
  if (!r.ok) throw new Error('API error ' + r.status + ': ' + JSON.stringify(data));
  if (data.error) throw new Error('Anthropic error: ' + JSON.stringify(data.error));
  return data;
}

function getReply(data) {
  return data.content && data.content[0] ? data.content[0].text : '(no response)';
}

// ═══════════════════════════════════════
// LEARNING PROFILE SYSTEM PROMPT
// ═══════════════════════════════════════
function getA11yInstructions() {
  const parts = [];
  if (state.modes.adhd) parts.push('ADHD MODE: Format all responses with clear numbered steps. Keep each step SHORT (max 2 sentences). Add "🎯 FOCUS:" before the most important point. After 4+ steps add "⏸️ QUICK BREAK — Stand up, stretch for 30 seconds, then continue."');
  if (state.modes.dyslexia) parts.push('DYSLEXIA MODE: Use very short sentences. Avoid long words where possible. Use bullet points. Add a "📢 Summary in one sentence:" at the end of every response.');
  if (state.modes.dyscalculia) parts.push('DYSCALCULIA MODE: For ANY maths, always write it out in words first, then show the visual representation. Break every calculation into tiny steps. Use colours like [RED: subtract] [GREEN: add] [BLUE: multiply]. Show each step on its own line.');
  return parts.join('\n\n');
}

function getTutorSystem() {
  const user = state.user;
  const year = user?.year || 'Year 11';
  const board = user?.board || 'AQA';
  let sys = `You are an expert ${state.subject} tutor for UK students, specialising in ${board} ${year}. 
Your name is Lumina. You are encouraging, patient, and brilliant at explaining complex ideas simply.
Always tailor your explanations to the student's level. Use UK terminology and exam board conventions.
When giving examples, use real-world scenarios. If the student seems stuck, break it down further.
For maths and science, always show your working step by step.`;
  const a11y = getA11yInstructions();
  if (a11y) sys += '\n\n' + a11y;
  return sys;
}

// ═══════════════════════════════════════
// TUTOR CHAT
// ═══════════════════════════════════════
function setSubject(name, icon, color) {
  state.subject = name;
  state.subjectColor = color;
  state.tutorHistory = [];
  document.querySelectorAll('.subj-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tutor-subject-title').textContent = name + ' Tutor';
  document.getElementById('tutor-messages').innerHTML = '';
  addTutorMsg('bot', `Subject switched to ${icon} ${name}! I'm ready to help. What would you like to explore? ✦`);
}

function addTutorMsg(role, text) {
  const el = document.createElement('div');
  el.className = 'msg ' + role;
  // Format ADHD steps
  if (state.modes.adhd && role === 'bot') {
    el.innerHTML = formatADHD(text);
  } else {
    el.textContent = text;
  }
  document.getElementById('tutor-messages').appendChild(el);
  document.getElementById('tutor-messages').scrollTop = 99999;
  if (role === 'bot' && state.ttsEnabled) speak(text);
}

function formatADHD(text) {
  // Add visual step breaks
  return text.replace(/\n/g, '<br>')
    .replace(/(\d+\.) /g, '<span class="step-badge" style="display:inline-block">$1</span> ');
}

async function tutorSend() {
  const input = document.getElementById('tutor-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addTutorMsg('user', text);
  state.tutorHistory.push({ role: 'user', content: text });
  const typing = document.createElement('div');
  typing.className = 'msg bot typing';
  typing.innerHTML = '<span></span><span></span><span></span>';
  document.getElementById('tutor-messages').appendChild(typing);
  document.getElementById('tutor-messages').scrollTop = 99999;
  try {
    const data = await callClaude(state.tutorHistory, getTutorSystem());
    const reply = getReply(data);
    typing.remove();
    state.tutorHistory.push({ role: 'assistant', content: reply });
    addTutorMsg('bot', reply);
    addXP(10);
  } catch (e) {
    typing.remove();
    addTutorMsg('bot', '⚠️ ' + e.message);
  }
}

function tutorKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); tutorSend(); }
}

function tutorQuick(prompt) {
  document.getElementById('tutor-input').value = prompt;
  tutorSend();
}

function clearTutor() {
  state.tutorHistory = [];
  document.getElementById('tutor-messages').innerHTML = '';
  addTutorMsg('bot', `Chat cleared! Ready to help with ${state.subject}. ✦`);
}

// ═══════════════════════════════════════
// DASHBOARD CHAT
// ═══════════════════════════════════════
function addDashMsg(role, text) {
  const el = document.createElement('div');
  el.className = 'msg ' + role;
  el.textContent = text;
  document.getElementById('dash-chat').appendChild(el);
  document.getElementById('dash-chat').scrollTop = 99999;
}

async function dashSend() {
  const input = document.getElementById('dash-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addDashMsg('user', text);
  state.dashHistory.push({ role: 'user', content: text });
  const typing = document.createElement('div');
  typing.className = 'msg bot typing';
  typing.innerHTML = '<span></span><span></span><span></span>';
  document.getElementById('dash-chat').appendChild(typing);
  document.getElementById('dash-chat').scrollTop = 99999;
  const sys = 'You are Lumina, a helpful AI tutor. Answer questions concisely and helpfully for UK students. Keep answers short (2-3 paragraphs max) for the dashboard widget. ' + getA11yInstructions();
  try {
    const data = await callClaude(state.dashHistory, sys);
    const reply = getReply(data);
    typing.remove();
    state.dashHistory.push({ role: 'assistant', content: reply });
    addDashMsg('bot', reply);
    addXP(5);
  } catch (e) {
    typing.remove();
    addDashMsg('bot', '⚠️ ' + e.message);
  }
}

function dashKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); dashSend(); }
}

// ═══════════════════════════════════════
// QUESTION GENERATOR
// ═══════════════════════════════════════
async function generateQuestions() {
  const sub = document.getElementById('q-subject').value;
  const board = document.getElementById('q-board').value;
  const level = document.getElementById('q-level').value;
  const num = document.getElementById('q-num').value;
  const type = document.getElementById('q-type').value;
  const grade = document.getElementById('q-grade').value;
  const topics = document.getElementById('q-topics').value;
  const output = document.getElementById('q-output');
  const qContainer = document.getElementById('q-questions');
  output.classList.add('show');
  document.getElementById('q-output-title').textContent = `${sub} Practice Paper`;
  document.getElementById('q-output-sub').textContent = `${num} questions · ${board} ${level} · ${grade}`;
  qContainer.innerHTML = '<div class="msg bot" style="max-width:100%">✦ Generating your questions with Lumina AI...</div>';
  const a11y = getA11yInstructions();
  let sys = `You are an expert UK exam question writer specialising in ${board} ${level} ${sub}.
Generate exactly ${num} exam-style questions for ${grade} target.
Question types: ${type}. ${topics ? 'Focus on: ' + topics : 'Cover key topics.'}
Format STRICTLY as JSON array with this structure:
[{"question":"...","marks":3,"type":"short answer","hint":"..."}]
Each question must be exam-quality, use UK spelling, follow ${board} style.
ONLY return the JSON array, nothing else.${a11y ? '\n\nIMPORTANT accessibility notes: ' + a11y : ''}`;
  try {
    const data = await callClaude([{ role: 'user', content: `Generate ${num} ${sub} questions for ${board} ${level}, ${grade} target. ${topics ? 'Topics: ' + topics : ''}` }], sys);
    const reply = getReply(data);
    let questions;
    try {
      const clean = reply.replace(/```json|```/g, '').trim();
      questions = JSON.parse(clean);
    } catch (e) {
      qContainer.innerHTML = '<div class="msg bot" style="max-width:100%">⚠️ Could not parse questions. Raw response:<br>' + reply + '</div>';
      return;
    }
    qContainer.innerHTML = '';
    questions.forEach((q, i) => {
      qContainer.innerHTML += `
        <div class="question-block">
          <div class="question-num">Question ${i + 1} <span class="marks-badge">${q.marks || 3} marks</span></div>
          <div class="question-text">${q.question}</div>
          ${q.hint ? `<div style="font-size:.8rem;color:var(--gold);margin-bottom:.5rem">💡 Hint: ${q.hint}</div>` : ''}
          <div class="answer-space" contenteditable="true" spellcheck="true" style="outline:none">Click here to write your answer...</div>
        </div>`;
    });
    addXP(20);
    showToast('✦ Questions generated!');
  } catch (e) {
    qContainer.innerHTML = `<div class="msg bot" style="max-width:100%">⚠️ Error: ${e.message}</div>`;
  }
}

// ═══════════════════════════════════════
// STRENGTHS ANALYSER
// ═══════════════════════════════════════
async function analyseStrengths() {
  const recs = document.getElementById('ai-recs');
  const body = document.getElementById('ai-recs-body');
  recs.style.display = 'block';
  body.innerHTML = '<div class="msg bot" style="max-width:100%">⏳ Lumina AI is analysing your performance...</div>';
  const sys = `You are an expert educational analyst. Given a student's strengths and weaknesses, provide specific, actionable recommendations.
Format response as HTML with: <div class="weakness-item"><span class="sw-topic">Action</span><span class="sw-pct bad">Priority</span></div>
Provide 5 specific study recommendations. Use Priority: HIGH, MEDIUM, or LOW.
${getA11yInstructions()}`;
  try {
    const data = await callClaude([{ role: 'user', content: 'My strongest topics: Biology Cell Structure (91%), Maths Algebra (88%), English Analysis (85%). My weakest: Maths Trigonometry (38%), Chemistry Organic (42%), Physics Electricity (45%). Give me a personalised study plan.' }], sys);
    body.innerHTML = getReply(data);
    addXP(15);
  } catch (e) {
    body.innerHTML = `<p style="color:var(--red)">⚠️ ${e.message}</p>`;
  }
}

// ═══════════════════════════════════════
// ASSIGNMENTS
// ═══════════════════════════════════════
function switchAssign(view) {
  document.querySelectorAll('.assign-view').forEach(v => v.classList.remove('active'));
  document.getElementById('av-' + view).classList.add('active');
  document.querySelectorAll('.assign-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('at-' + view).classList.add('active');
}

async function getHint(id) {
  const hints = {
    1: 'quadratic equations — try using the quadratic formula x = (-b ± √(b²-4ac)) / 2a, or factorising first',
    2: 'Newton\'s three laws — think about inertia, F=ma, and equal/opposite reactions with real examples'
  };
  showToast('💡 Asking Claude for a hint...');
  const sys = `You are a supportive tutor helping a student with their homework. Give a helpful HINT that guides them WITHOUT giving the answer away. Keep it to 2-3 sentences. ${getA11yInstructions()}`;
  try {
    const data = await callClaude([{ role: 'user', content: `Give me a hint for: ${hints[id]}. Don't give me the answer, just guide me.` }], sys);
    showToast('💡 ' + getReply(data).slice(0, 100) + '...');
  } catch (e) {
    showToast('⚠️ ' + e.message.slice(0, 80));
  }
}

async function createAssignment() {
  const title = document.getElementById('asgn-title').value;
  const subject = document.getElementById('asgn-subject').value;
  const year = document.getElementById('asgn-year').value;
  if (!title) { showToast('Please enter a title first'); return; }
  showToast('✦ Generating assignment with Lumina AI...');
  const sys = `You are an experienced UK teacher creating a homework assignment. Write clear, engaging instructions appropriate for the level. Follow UK curriculum standards.`;
  try {
    const data = await callClaude([{ role: 'user', content: `Create a detailed homework assignment for ${year} ${subject} titled "${title}". Include learning objectives, instructions, mark scheme hints, and 3-5 specific tasks.` }], sys);
    document.getElementById('asgn-instructions').value = getReply(data).slice(0, 500);
    showToast('✦ Assignment generated!');
  } catch (e) {
    showToast('⚠️ ' + e.message.slice(0, 80));
  }
}

function saveAssignment() { showToast('✅ Assignment saved and sent to students!'); }
function openAssignment(id) { showToast('Opening assignment...'); showDash('tutor'); }

// ═══════════════════════════════════════
// VIDEO PLAYER (Interactive)
// ═══════════════════════════════════════
const videoChapters = [
  { title: 'Welcome to Lumina AI', desc: 'Learn how the platform transforms your studying', q: null },
  { title: 'AI Tutor', desc: 'Ask Lumina AI anything — step by step explanations', q: { text: 'What makes Lumina\'s AI tutor different from Google?', opts: ['It uses Lumina AI, the most advanced AI model', 'It has better images', 'It plays videos', 'It\'s cheaper'], correct: 0 } },
  { title: 'Question Generator', desc: 'Create real exam-style questions for any topic', q: { text: 'Which exam boards does Lumina support?', opts: ['Only AQA', 'AQA, Edexcel, OCR, and WJEC', 'Only Edexcel', 'No specific board'], correct: 1 } },
  { title: 'Progress Tracking', desc: 'See exactly how you\'re improving over time', q: null },
  { title: 'Accessibility Features', desc: 'ADHD, Dyslexia, and Dyscalculia support', q: { text: 'Which accessibility modes does Lumina offer?', opts: ['Only ADHD', 'Only dyslexia fonts', 'ADHD, Dyslexia AND Dyscalculia — separately', 'Colour blindness only'], correct: 2 } }
];
let currentChapter = 0;

function playChapter(i) {
  currentChapter = i;
  document.querySelectorAll('.chapter-btn').forEach((b, j) => b.classList.toggle('active', j === i));
  const chapter = videoChapters[i];
  const main = document.getElementById('video-main');
  const colors = ['#C9A84C', '#60A5FA', '#4ADE80', '#F472B6', '#A78BFA'];
  main.style.background = `radial-gradient(ellipse at center, ${colors[i]}22 0%, var(--bg3) 70%)`;
  main.querySelector('.video-preview-content h3').textContent = chapter.title;
  main.querySelector('.video-preview-content p').textContent = chapter.desc;
  const existing = main.querySelector('.video-question');
  if (existing) existing.remove();
  if (chapter.q) {
    setTimeout(() => showVideoQuestion(chapter.q), 1500);
  }
}

function startVideo() { playChapter(1); }

function showVideoQuestion(q) {
  const main = document.getElementById('video-main');
  const el = document.createElement('div');
  el.className = 'video-question show';
  el.innerHTML = `<h4>📝 Quick Check: ${q.text}</h4><div class="vq-options">${q.opts.map((o, i) => `<button class="vq-opt" onclick="answerVQ(this,${i},${q.correct})">${o}</button>`).join('')}</div>`;
  main.appendChild(el);
}

function answerVQ(btn, chosen, correct) {
  btn.parentElement.querySelectorAll('.vq-opt').forEach(b => b.onclick = null);
  if (chosen === correct) {
    btn.classList.add('correct');
    showToast('✅ Correct! +5 XP');
    addXP(5);
  } else {
    btn.classList.add('wrong');
    btn.parentElement.children[correct].classList.add('correct');
    showToast('Not quite — the correct answer is highlighted');
  }
}

// ═══════════════════════════════════════
// TEXT TO SPEECH
// ═══════════════════════════════════════
function toggleTTS() {
  state.ttsEnabled = !state.ttsEnabled;
  document.getElementById('tts-toggle').classList.toggle('active', state.ttsEnabled);
  showToast(state.ttsEnabled ? '🔊 Read-aloud enabled' : '🔇 Read-aloud disabled');
}

function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text.slice(0, 500));
  utt.rate = 0.9; utt.pitch = 1;
  window.speechSynthesis.speak(utt);
}

function speakInput() {
  if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
    showToast('Speech recognition not supported in this browser');
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recog = new SR();
  recog.onresult = (e) => {
    document.getElementById('tutor-input').value = e.results[0][0].transcript;
  };
  recog.start();
  showToast('🎤 Listening...');
}

// ═══════════════════════════════════════
// XP SYSTEM
// ═══════════════════════════════════════
function addXP(amount, msg) {
  state.xp += amount;
  const newLevel = Math.floor(state.xp / 200) + 1;
  if (newLevel > state.level) {
    state.level = newLevel;
    showToast(`🎉 Level Up! You're now Level ${newLevel}!`);
  }
  updateXPDisplay();
  const popup = document.getElementById('xp-popup');
  popup.textContent = (msg || `+${amount} XP ⭐`);
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 2000);
}

function updateXPDisplay() {
  const xpInLevel = state.xp % 200;
  document.getElementById('xp-display').textContent = state.xp + ' XP';
  document.getElementById('xp-level-text').textContent = 'Level ' + state.level;
  document.getElementById('xp-progress-text').textContent = xpInLevel + ' / 200 XP';
  document.getElementById('xp-fill').style.width = (xpInLevel / 200 * 100) + '%';
}

// ═══════════════════════════════════════
// HEATMAP
// ═══════════════════════════════════════
function buildHeatmap() {
  const el = document.getElementById('heatmap');
  const levels = ['', 'l1', 'l2', 'l3', 'l4'];
  let html = '';
  for (let i = 0; i < 84; i++) {
    const rand = Math.random();
    const lvl = rand < 0.3 ? 0 : rand < 0.5 ? 1 : rand < 0.7 ? 2 : rand < 0.9 ? 3 : 4;
    const date = new Date(); date.setDate(date.getDate() - (83 - i));
    const label = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    html += `<div class="heat-cell ${levels[lvl]}" data-tip="${label}: ${lvl * 3} sessions"></div>`;
  }
  el.innerHTML = html;
}

// ═══════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

function getGreeting() {
  const h = new Date().getHours();
  return h < 12 ? 'Good morning' : h < 18 ? 'Good afternoon' : 'Good evening';
}

function updateGreeting() {
  const el = document.getElementById('dash-greeting');
  if (el && state.user) el.textContent = `${getGreeting()}, ${state.user.name.split(' ')[0]}! 👋`;
}

// Init welcome tutor message if on tutor subpage
function initTutor() {
  if (!document.getElementById('tutor-messages').children.length) {
    addTutorMsg('bot', `Hello! I'm your Mathematics tutor, ✦\n\nI can explain any concept step by step, give you practice questions, help with exam technique, or simplify tricky topics.\n\nWhat would you like to work on today?`);
  }
}
</script>

<!-- ═══════════════ MOBILE BOTTOM NAV ═══════════════ -->
<div id="mobile-nav">
  <div class="mob-nav-grid">
    <button class="mob-nav-btn active" id="mn-home" onclick="showDash('home');setMobNav('home')"><i class="fas fa-house"></i>Home</button>
    <button class="mob-nav-btn" id="mn-tutor" onclick="showDash('tutor');setMobNav('tutor')"><i class="fas fa-robot"></i>Tutor</button>
    <button class="mob-nav-btn" id="mn-questions" onclick="showDash('questions');setMobNav('questions')"><i class="fas fa-file-lines"></i>Questions</button>
    <button class="mob-nav-btn" id="mn-notes" onclick="showDash('notes');setMobNav('notes')"><i class="fas fa-book"></i>Notes</button>
    <button class="mob-nav-btn" id="mn-progress" onclick="showDash('progress');setMobNav('progress')"><i class="fas fa-chart-line"></i>Progress</button>
  </div>
</div>

<!-- ═══════════════ POMODORO WIDGET ═══════════════ -->
<button class="pom-float-btn" id="pom-float" onclick="togglePomodoro()">
  ⏱️ <span id="pom-float-time">25:00</span>
</button>

<div id="pomodoro-widget">
  <div class="pom-label" id="pom-phase-label">Focus Session</div>
  <div class="pom-ring">
    <svg width="88" height="88" viewBox="0 0 88 88">
      <circle cx="44" cy="44" r="40" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="4"/>
      <circle id="pom-ring-circle" cx="44" cy="44" r="40" fill="none" stroke="#C9A84C" stroke-width="4"
        stroke-dasharray="251.2" stroke-dashoffset="0" stroke-linecap="round"/>
    </svg>
    <div class="pom-time" id="pom-display">25:00</div>
  </div>
  <div class="pom-phase" id="pom-phase-text">Stay focused — you've got this! 💪</div>
  <div class="pom-controls">
    <button class="pom-btn start" id="pom-start-btn" onclick="pomStart()">▶ Start</button>
    <button class="pom-btn" onclick="pomReset()">↺ Reset</button>
    <button class="pom-btn" onclick="togglePomodoro()">✕</button>
  </div>
  <div class="pom-sessions" id="pom-sessions">
    <div class="pom-dot" id="pd0"></div>
    <div class="pom-dot" id="pd1"></div>
    <div class="pom-dot" id="pd2"></div>
    <div class="pom-dot" id="pd3"></div>
  </div>
</div>

<!-- ═══════════════ ONBOARDING TOUR ═══════════════ -->
<div id="tour-overlay">
  <div class="tour-backdrop" onclick="skipTour()"></div>
  <div class="tour-highlight" id="tour-highlight"></div>
  <div class="tour-box" id="tour-box">
    <div class="tour-step-num" id="tour-step-num">Step 1 of 6</div>
    <h4 id="tour-title">Welcome to Lumina AI! 🎓</h4>
    <p id="tour-desc">Let me show you around. This is your personal AI-powered learning platform built for every type of learner.</p>
    <div class="tour-controls">
      <button class="tour-skip" onclick="skipTour()">Skip tour</button>
      <div class="tour-dots" id="tour-dots"></div>
      <button class="tour-next" onclick="tourNext()">Next →</button>
    </div>
  </div>
</div>


<!-- KEYBOARD SHORTCUTS MODAL -->
<div class="kb-modal" id="kb-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="kb-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
      <div style="font-weight:700;font-size:1.1rem">⌨️ Keyboard Shortcuts</div>
      <button onclick="document.getElementById('kb-modal').classList.remove('show')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.3rem">✕</button>
    </div>
    <div class="kb-row"><span>Open AI Tutor</span><div><kbd>Ctrl</kbd> + <kbd>T</kbd></div></div>
    <div class="kb-row"><span>Search</span><div><kbd>Ctrl</kbd> + <kbd>K</kbd></div></div>
    <div class="kb-row"><span>New Question</span><div><kbd>Ctrl</kbd> + <kbd>Q</kbd></div></div>
    <div class="kb-row"><span>Open Notebook</span><div><kbd>Ctrl</kbd> + <kbd>N</kbd></div></div>
    <div class="kb-row"><span>Pomodoro Timer</span><div><kbd>Ctrl</kbd> + <kbd>P</kbd></div></div>
    <div class="kb-row"><span>Geometry Canvas</span><div><kbd>Ctrl</kbd> + <kbd>G</kbd></div></div>
    <div class="kb-row"><span>Flashcards</span><div><kbd>Ctrl</kbd> + <kbd>F</kbd></div></div>
    <div class="kb-row"><span>This Menu</span><div><kbd>?</kbd></div></div>
    <div class="kb-row"><span>Go Home</span><div><kbd>Esc</kbd></div></div>
  </div>
</div>

<!-- FORGOT PASSWORD MODAL -->
<div id="forgot-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:3000;align-items:center;justify-content:center;padding:1rem">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:2rem;max-width:400px;width:100%">
    <div style="font-weight:700;font-size:1.1rem;margin-bottom:.5rem">🔑 Reset Password</div>
    <p style="color:var(--muted);font-size:.875rem;margin-bottom:1.5rem">Enter your email and we'll send you a reset link.</p>
    <div class="form-group" style="margin-bottom:1rem">
      <input type="email" class="form-input" id="reset-email" placeholder="Your email address">
    </div>
    <div style="display:flex;gap:.75rem">
      <button class="btn-gold" onclick="sendPasswordReset()" style="flex:1">Send Reset Link</button>
      <button onclick="document.getElementById('forgot-modal').style.display='none'" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:.6rem 1rem;color:var(--muted);cursor:pointer">Cancel</button>
    </div>
    <div id="reset-confirm" style="display:none;margin-top:1rem;color:var(--green);font-size:.875rem;text-align:center">✅ If that email exists, a reset link has been sent!</div>
  </div>
</div>

<!-- SHARE QUESTION MODAL -->
<div id="share-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:3000;align-items:center;justify-content:center;padding:1rem">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:2rem;max-width:480px;width:100%">
    <div style="font-weight:700;font-size:1.1rem;margin-bottom:.5rem">📤 Share Question</div>
    <p style="color:var(--muted);font-size:.875rem;margin-bottom:1.5rem">Share this question with a classmate</p>
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem;font-size:.875rem" id="share-question-preview">No question selected</div>
    <div style="display:flex;gap:.5rem;margin-bottom:1rem">
      <input type="text" class="form-input" id="share-link" value="https://lumina.ai/q/share/abc123" readonly style="flex:1">
      <button class="btn-gold" onclick="copyShareLink()">Copy</button>
    </div>
    <div style="display:flex;gap:.5rem">
      <button class="vid-ctrl-btn" style="flex:1" onclick="shareViaWhatsApp()">💬 WhatsApp</button>
      <button class="vid-ctrl-btn" style="flex:1" onclick="shareViaEmail()">📧 Email</button>
      <button onclick="document.getElementById('share-modal').style.display='none'" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:.6rem 1rem;color:var(--muted);cursor:pointer">✕</button>
    </div>
  </div>
</div>

</body>
</html>

<!-- ═══════════════════ GEOMETRY PANEL ═══════════════════ -->
<div id="geo-panel">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--border);background:var(--bg3)">
    <div style="font-weight:700;font-size:.95rem">📐 Geometry Canvas</div>
    <button onclick="toggleGeo()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">✕</button>
  </div>
  <div class="geo-toolbar">
    <button class="geo-tool active" id="gt-point" onclick="setGeoTool('point')">• Point</button>
    <button class="geo-tool" id="gt-line" onclick="setGeoTool('line')">— Line</button>
    <button class="geo-tool" id="gt-triangle" onclick="setGeoTool('triangle')">△ Triangle</button>
    <button class="geo-tool" id="gt-circle" onclick="setGeoTool('circle')">○ Circle</button>
    <button class="geo-tool" id="gt-rect" onclick="setGeoTool('rect')">□ Rectangle</button>
    <button class="geo-tool" id="gt-angle" onclick="setGeoTool('angle')">∠ Angle</button>
    <button class="geo-tool" id="gt-measure" onclick="setGeoTool('measure')">📏 Measure</button>
    <button class="geo-tool" onclick="clearGeo()">🗑️ Clear</button>
  </div>
  <canvas id="geo-canvas" width="420" height="420"></canvas>
  <div class="geo-info" id="geo-info">
    Select a tool and click on the canvas to draw. Measurements appear automatically.
  </div>
</div>

<!-- Geometry toggle button -->
<button class="geo-toggle-btn" id="geo-toggle-btn" onclick="toggleGeo()">📐</button>

<!-- ═══════════════════ SPACED REPETITION MODAL ═══════════════════ -->
<div id="sr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center;padding:2rem">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:2rem;max-width:560px;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
      <div>
        <div style="font-weight:700;font-size:1.1rem">🧠 Spaced Repetition Review</div>
        <div style="font-size:.8rem;color:var(--muted)" id="sr-count">Card 1 of 5 due today</div>
      </div>
      <button onclick="closeSR()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.5rem">✕</button>
    </div>
    <div class="sr-card" id="sr-card" onclick="revealSR()">
      <div class="sr-subject-tag" id="sr-tag">Mathematics</div>
      <div class="sr-question" id="sr-question">Loading...</div>
      <div style="font-size:.8rem;color:var(--muted);margin-top:1rem">👆 Tap to reveal answer</div>
      <div class="sr-answer" id="sr-answer"></div>
    </div>
    <div class="sr-rating" id="sr-rating">
      <button class="sr-rate-btn sr-rate-easy" onclick="rateSR('easy')">😊 Easy<div class="sr-next-info">Next: 7 days</div></button>
      <button class="sr-rate-btn sr-rate-ok" onclick="rateSR('ok')">🤔 Got it<div class="sr-next-info">Next: 3 days</div></button>
      <button class="sr-rate-btn sr-rate-hard" onclick="rateSR('hard')">😅 Hard<div class="sr-next-info">Next: Tomorrow</div></button>
    </div>
    <div style="text-align:center;margin-top:1rem">
      <button onclick="generateSRCard()" style="background:var(--gold);color:var(--black);border:none;border-radius:8px;padding:.6rem 1.5rem;font-weight:700;cursor:pointer">✦ Generate New Card with AI</button>
    </div>
  </div>
</div>

<!-- SR float button -->
<button class="sr-float-btn show" id="sr-float-btn" onclick="openSR()" style="display:none" title="Spaced Repetition Review">🧠</button>

<!-- Feedback -->
<div id="feedback-btn" onclick="showToast('Thank you for your feedback! 💛')">💬 Feedback</div>
<script>
// ═══════════════════════════════════════
// GEOMETRY CANVAS ENGINE
// ═══════════════════════════════════════
const geo = {
  tool: 'point',
  points: [],
  shapes: [],
  tempPoints: [],
  canvas: null,
  ctx: null,
  colors: { point:'#C9A84C', line:'#60A5FA', triangle:'#4ADE80', circle:'#F472B6', rect:'#FB923C', angle:'#A78BFA' }
};

function initGeo() {
  geo.canvas = document.getElementById('geo-canvas');
  geo.ctx = geo.canvas.getContext('2d');
  geo.canvas.addEventListener('click', geoClick);
  geo.canvas.addEventListener('mousemove', geoMouseMove);
  drawGeoGrid();
}

function drawGeoGrid() {
  const ctx = geo.ctx, w = geo.canvas.width, h = geo.canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  for(let x=0;x<w;x+=20) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
  for(let y=0;y<h;y+=20) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  // Axes
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(w/2,0); ctx.lineTo(w/2,h); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
  // Redraw all shapes
  geo.shapes.forEach(s => drawShape(s));
}

function geoClick(e) {
  const r = geo.canvas.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const ctx = geo.ctx;

  if (geo.tool === 'point') {
    geo.shapes.push({type:'point', x, y});
    drawShape({type:'point',x,y});
    updateGeoInfo(`Point at (${Math.round(x-210)}, ${Math.round(210-y)})`);
  } else if (geo.tool === 'line') {
    geo.tempPoints.push({x,y});
    drawDot(x,y,'#60A5FA');
    if (geo.tempPoints.length === 2) {
      const [p1,p2] = geo.tempPoints;
      const len = Math.sqrt((p2.x-p1.x)**2+(p2.y-p1.y)**2);
      geo.shapes.push({type:'line',p1,p2});
      drawShape({type:'line',p1,p2});
      updateGeoInfo(`Line length: ${(len/20).toFixed(2)} units`);
      geo.tempPoints = [];
      drawGeoGrid();
    }
  } else if (geo.tool === 'triangle') {
    geo.tempPoints.push({x,y});
    drawDot(x,y,'#4ADE80');
    if (geo.tempPoints.length === 3) {
      const [a,b,c] = geo.tempPoints;
      geo.shapes.push({type:'triangle',a,b,c});
      drawShape({type:'triangle',a,b,c});
      const ab = Math.sqrt((b.x-a.x)**2+(b.y-a.y)**2);
      const bc = Math.sqrt((c.x-b.x)**2+(c.y-b.y)**2);
      const ca = Math.sqrt((a.x-c.x)**2+(a.y-c.y)**2);
      const area = Math.abs((b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y))/2;
      updateGeoInfo(`Triangle — Sides: ${(ab/20).toFixed(1)}, ${(bc/20).toFixed(1)}, ${(ca/20).toFixed(1)} units | Area: ${(area/400).toFixed(1)} sq.units`);
      geo.tempPoints = [];
      drawGeoGrid();
    }
  } else if (geo.tool === 'circle') {
    geo.tempPoints.push({x,y});
    if (geo.tempPoints.length === 2) {
      const [c,e] = geo.tempPoints;
      const r = Math.sqrt((e.x-c.x)**2+(e.y-c.y)**2);
      geo.shapes.push({type:'circle',cx:c.x,cy:c.y,r});
      drawShape({type:'circle',cx:c.x,cy:c.y,r});
      updateGeoInfo(`Circle — Radius: ${(r/20).toFixed(2)} units | Circumference: ${(2*Math.PI*r/20).toFixed(2)} units | Area: ${(Math.PI*r*r/400).toFixed(2)} sq.units`);
      geo.tempPoints = [];
      drawGeoGrid();
    }
  } else if (geo.tool === 'rect') {
    geo.tempPoints.push({x,y});
    if (geo.tempPoints.length === 2) {
      const [p1,p2] = geo.tempPoints;
      const w = Math.abs(p2.x-p1.x), h2 = Math.abs(p2.y-p1.y);
      geo.shapes.push({type:'rect',x:Math.min(p1.x,p2.x),y:Math.min(p1.y,p2.y),w,h:h2});
      drawShape({type:'rect',x:Math.min(p1.x,p2.x),y:Math.min(p1.y,p2.y),w,h:h2});
      updateGeoInfo(`Rectangle — Width: ${(w/20).toFixed(1)}, Height: ${(h2/20).toFixed(1)} units | Area: ${(w*h2/400).toFixed(1)} sq.units | Perimeter: ${((2*w+2*h2)/20).toFixed(1)} units`);
      geo.tempPoints = [];
      drawGeoGrid();
    }
  } else if (geo.tool === 'angle') {
    geo.tempPoints.push({x,y});
    drawDot(x,y,'#A78BFA');
    if (geo.tempPoints.length === 3) {
      const [a,v,b] = geo.tempPoints;
      const angle = calcAngle(a,v,b);
      geo.shapes.push({type:'angle',a,v,b,angle});
      drawShape({type:'angle',a,v,b,angle});
      updateGeoInfo(`Angle: ${angle.toFixed(1)}° | Type: ${angle < 90 ? 'Acute' : angle === 90 ? 'Right' : angle < 180 ? 'Obtuse' : 'Reflex'}`);
      geo.tempPoints = [];
      drawGeoGrid();
    }
  } else if (geo.tool === 'measure') {
    geo.tempPoints.push({x,y});
    drawDot(x,y,'#FBBF24');
    if (geo.tempPoints.length === 2) {
      const [p1,p2] = geo.tempPoints;
      const d = Math.sqrt((p2.x-p1.x)**2+(p2.y-p1.y)**2);
      const a = Math.atan2(p2.y-p1.y,p2.x-p1.x)*180/Math.PI;
      drawMeasureLine(p1,p2,d);
      updateGeoInfo(`Distance: ${(d/20).toFixed(2)} units | Bearing: ${((a+360)%360).toFixed(1)}°`);
      geo.tempPoints = [];
    }
  }
}

function geoMouseMove(e) {
  if (geo.tempPoints.length === 0) return;
  drawGeoGrid();
  const r = geo.canvas.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const ctx = geo.ctx;
  geo.tempPoints.forEach(p => drawDot(p.x, p.y, geo.colors[geo.tool] || '#C9A84C'));
  ctx.setLineDash([5,5]);
  ctx.strokeStyle = geo.colors[geo.tool] || '#C9A84C';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(geo.tempPoints[geo.tempPoints.length-1].x, geo.tempPoints[geo.tempPoints.length-1].y);
  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawShape(s) {
  const ctx = geo.ctx;
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  if (s.type === 'point') {
    drawDot(s.x, s.y, geo.colors.point);
    ctx.fillStyle = geo.colors.point;
    ctx.font = '11px monospace';
    ctx.fillText(`(${Math.round(s.x-210)},${Math.round(210-s.y)})`, s.x+8, s.y-8);
  } else if (s.type === 'line') {
    ctx.strokeStyle = geo.colors.line; ctx.lineWidth = 2.5;
    ctx.beginPath(); ctx.moveTo(s.p1.x,s.p1.y); ctx.lineTo(s.p2.x,s.p2.y); ctx.stroke();
    drawDot(s.p1.x,s.p1.y,geo.colors.line); drawDot(s.p2.x,s.p2.y,geo.colors.line);
  } else if (s.type === 'triangle') {
    ctx.strokeStyle = geo.colors.triangle; ctx.lineWidth = 2.5;
    ctx.fillStyle = 'rgba(74,222,128,0.08)';
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.lineTo(s.c.x,s.c.y); ctx.closePath();
    ctx.fill(); ctx.stroke();
    [s.a,s.b,s.c].forEach(p => drawDot(p.x,p.y,geo.colors.triangle));
  } else if (s.type === 'circle') {
    ctx.strokeStyle = geo.colors.circle; ctx.lineWidth = 2.5;
    ctx.fillStyle = 'rgba(244,114,182,0.08)';
    ctx.beginPath(); ctx.arc(s.cx,s.cy,s.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
    drawDot(s.cx,s.cy,geo.colors.circle);
  } else if (s.type === 'rect') {
    ctx.strokeStyle = geo.colors.rect; ctx.lineWidth = 2.5;
    ctx.fillStyle = 'rgba(251,146,60,0.08)';
    ctx.beginPath(); ctx.rect(s.x,s.y,s.w,s.h); ctx.fill(); ctx.stroke();
  } else if (s.type === 'angle') {
    ctx.strokeStyle = geo.colors.angle; ctx.lineWidth = 2.5;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.v.x,s.v.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    // Arc
    const a1 = Math.atan2(s.a.y-s.v.y,s.a.x-s.v.x);
    const a2 = Math.atan2(s.b.y-s.v.y,s.b.x-s.v.x);
    ctx.beginPath(); ctx.arc(s.v.x,s.v.y,30,a1,a2); ctx.strokeStyle='rgba(167,139,250,0.5)'; ctx.stroke();
    ctx.fillStyle='#A78BFA'; ctx.font='bold 12px sans-serif';
    ctx.fillText(s.angle.toFixed(1)+'°',s.v.x+35,s.v.y);
  }
}

function drawDot(x,y,color) {
  const ctx = geo.ctx;
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.stroke();
}

function drawMeasureLine(p1,p2,d) {
  const ctx = geo.ctx;
  ctx.strokeStyle = '#FBBF24'; ctx.lineWidth = 2;
  ctx.setLineDash([6,3]);
  ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
  ctx.setLineDash([]);
  const mx=(p1.x+p2.x)/2, my=(p1.y+p2.y)/2;
  ctx.fillStyle='#FBBF24'; ctx.font='bold 12px monospace';
  ctx.fillText((d/20).toFixed(2)+'u',mx+5,my-5);
  drawDot(p1.x,p1.y,'#FBBF24'); drawDot(p2.x,p2.y,'#FBBF24');
}

function calcAngle(a,v,b) {
  const v1 = {x:a.x-v.x, y:a.y-v.y};
  const v2 = {x:b.x-v.x, y:b.y-v.y};
  const dot = v1.x*v2.x+v1.y*v2.y;
  const mag = Math.sqrt(v1.x**2+v1.y**2)*Math.sqrt(v2.x**2+v2.y**2);
  return Math.acos(Math.max(-1,Math.min(1,dot/mag)))*180/Math.PI;
}

function setGeoTool(tool) {
  geo.tool = tool; geo.tempPoints = [];
  document.querySelectorAll('.geo-tool').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('gt-'+tool);
  if (btn) btn.classList.add('active');
  updateGeoInfo({
    point:'Click to place a point',
    line:'Click two points to draw a line',
    triangle:'Click three points to draw a triangle',
    circle:'Click centre then edge for a circle',
    rect:'Click two opposite corners for a rectangle',
    angle:'Click three points: first ray, vertex, second ray',
    measure:'Click two points to measure distance'
  }[tool]);
}

function clearGeo() { geo.shapes = []; geo.tempPoints = []; drawGeoGrid(); updateGeoInfo('Canvas cleared. Select a tool to draw.'); }
function updateGeoInfo(msg) { document.getElementById('geo-info').innerHTML = '<span class="geo-measurement">'+msg+'</span>'; }

function toggleGeo() {
  const panel = document.getElementById('geo-panel');
  panel.classList.toggle('show');
  if (panel.classList.contains('show') && !geo.canvas) initGeo();
  else if (panel.classList.contains('show')) drawGeoGrid();
}

// ═══════════════════════════════════════
// MOLECULE VIEWER (Canvas-based)
// ═══════════════════════════════════════
const molecules = {
  H2O: { atoms:[{s:'O',x:200,y:180,c:'#FB7185'},{s:'H',x:140,y:240,c:'#60A5FA'},{s:'H',x:260,y:240,c:'#60A5FA'}], bonds:[[0,1],[0,2]], name:'Water (H₂O)', angle:'104.5°' },
  CO2: { atoms:[{s:'C',x:200,y:200,c:'#94A3B8'},{s:'O',x:120,y:200,c:'#FB7185'},{s:'O',x:280,y:200,c:'#FB7185'}], bonds:[[0,1],[0,2]], name:'Carbon Dioxide (CO₂)', angle:'180° (linear)' },
  CH4: { atoms:[{s:'C',x:200,y:200,c:'#94A3B8'},{s:'H',x:200,y:130,c:'#60A5FA'},{s:'H',x:260,y:240,c:'#60A5FA'},{s:'H',x:140,y:240,c:'#60A5FA'},{s:'H',x:200,y:270,c:'#60A5FA'}], bonds:[[0,1],[0,2],[0,3],[0,4]], name:'Methane (CH₄)', angle:'109.5° (tetrahedral)' },
  NH3: { atoms:[{s:'N',x:200,y:180,c:'#60A5FA'},{s:'H',x:140,y:240,c:'#E2E8F0'},{s:'H',x:260,y:240,c:'#E2E8F0'},{s:'H',x:200,y:260,c:'#E2E8F0'}], bonds:[[0,1],[0,2],[0,3]], name:'Ammonia (NH₃)', angle:'107° (trigonal pyramidal)' },
};
let currentMolecule = 'H2O';

function drawMolecule(name) {
  currentMolecule = name;
  const mol = molecules[name];
  const canvas = document.getElementById('mol-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,400,320);
  ctx.fillStyle = '#0A0C12'; ctx.fillRect(0,0,400,320);
  // Draw bonds
  mol.bonds.forEach(([i,j]) => {
    const a=mol.atoms[i], b=mol.atoms[j];
    ctx.strokeStyle='rgba(255,255,255,0.4)'; ctx.lineWidth=6; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  });
  // Draw atoms
  mol.atoms.forEach(a => {
    ctx.shadowColor=a.c; ctx.shadowBlur=20;
    const grad=ctx.createRadialGradient(a.x-8,a.y-8,2,a.x,a.y,22);
    grad.addColorStop(0,'#fff'); grad.addColorStop(0.3,a.c); grad.addColorStop(1,a.c+'88');
    ctx.fillStyle=grad;
    ctx.beginPath(); ctx.arc(a.x,a.y,22,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    ctx.fillStyle='#fff'; ctx.font='bold 14px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(a.s,a.x,a.y);
  });
  // Info
  ctx.fillStyle='rgba(201,168,76,0.9)'; ctx.font='13px DM Sans'; ctx.textAlign='left';
  ctx.fillText(mol.name, 10, 290);
  ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.font='12px DM Sans';
  ctx.fillText('Bond angle: '+mol.angle, 10, 308);
}

// ═══════════════════════════════════════
// FORCE DIAGRAM (Canvas-based)
// ═══════════════════════════════════════
const forceScenes = {
  incline: {
    name: 'Object on Slope',
    draw: (ctx) => {
      ctx.clearRect(0,0,500,280);
      ctx.fillStyle='#0A0C12'; ctx.fillRect(0,0,500,280);
      // Slope
      ctx.fillStyle='#1C2030'; ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(50,250); ctx.lineTo(400,250); ctx.lineTo(400,100); ctx.closePath();
      ctx.fill(); ctx.stroke();
      // Object
      ctx.fillStyle='#60A5FA'; ctx.shadowColor='#60A5FA'; ctx.shadowBlur=10;
      ctx.fillRect(190,155,50,40); ctx.shadowBlur=0;
      // Gravity
      drawArrow(ctx,215,175,215,240,'#FB7185','Weight (mg)');
      // Normal
      const nx=-Math.sin(Math.PI/6)*70, ny=-Math.cos(Math.PI/6)*70;
      drawArrow(ctx,215,175,215+nx,175+ny,'#4ADE80','Normal Force (N)');
      // Friction
      drawArrow(ctx,215,175,155,175-35,'#FBBF24','Friction (f)');
      // Angle label
      ctx.fillStyle='#A78BFA'; ctx.font='14px DM Sans';
      ctx.fillText('θ = 30°', 340, 240);
    }
  },
  freebody: {
    name: 'Free Body Diagram',
    draw: (ctx) => {
      ctx.clearRect(0,0,500,280);
      ctx.fillStyle='#0A0C12'; ctx.fillRect(0,0,500,280);
      // Object block
      ctx.fillStyle='#1C2030'; ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=2;
      ctx.fillRect(215,115,70,70); ctx.strokeRect(215,115,70,70);
      // Arrows
      drawArrow(ctx,250,115,250,30,'#4ADE80','Normal (150N)');
      drawArrow(ctx,250,185,250,260,'#FB7185','Weight (150N)');
      drawArrow(ctx,215,150,120,150,'#60A5FA','Applied F (80N)');
      drawArrow(ctx,285,150,380,150,'#FBBF24','Friction (20N)');
      ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.font='12px DM Sans'; ctx.textAlign='center';
      ctx.fillText('Net Force = 80 - 20 = 60N →', 250, 275);
    }
  },
  circular: {
    name: 'Circular Motion',
    draw: (ctx) => {
      ctx.clearRect(0,0,500,280);
      ctx.fillStyle='#0A0C12'; ctx.fillRect(0,0,500,280);
      // Circle path
      ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.lineWidth=2; ctx.setLineDash([5,5]);
      ctx.beginPath(); ctx.arc(250,140,100,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
      // Object at top
      ctx.fillStyle='#F472B6'; ctx.shadowColor='#F472B6'; ctx.shadowBlur=10;
      ctx.beginPath(); ctx.arc(250,40,18,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
      ctx.fillStyle='#fff'; ctx.font='bold 12px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('m',250,40);
      // Centripetal force
      drawArrow(ctx,250,58,250,115,'#F472B6','Centripetal F');
      // Velocity
      drawArrow(ctx,268,40,340,40,'#60A5FA','v (velocity)');
      // Center
      ctx.fillStyle='#C9A84C'; ctx.fillText('Centre',250,145);
      ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.font='12px DM Sans';
      ctx.fillText('F = mv²/r', 250, 270);
    }
  }
};

function drawArrow(ctx,x1,y1,x2,y2,color,label) {
  const dx=x2-x1, dy=y2-y1;
  const angle=Math.atan2(dy,dx);
  const len=Math.sqrt(dx*dx+dy*dy);
  ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=3; ctx.lineCap='round';
  ctx.shadowColor=color; ctx.shadowBlur=6;
  ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  ctx.shadowBlur=0;
  // Arrowhead
  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2-12*Math.cos(angle-0.4),y2-12*Math.sin(angle-0.4));
  ctx.lineTo(x2-12*Math.cos(angle+0.4),y2-12*Math.sin(angle+0.4));
  ctx.closePath(); ctx.fill();
  if(label) {
    ctx.fillStyle=color; ctx.font='bold 11px DM Sans'; ctx.textAlign='center';
    ctx.fillText(label, (x1+x2)/2+15, (y1+y2)/2-8);
  }
}

function drawForceScene(scene) {
  document.querySelectorAll('.force-scene-btn').forEach(b => b.classList.remove('active'));
  const canvas = document.getElementById('force-canvas-el');
  if (!canvas) return;
  canvas.getContext('2d');
  forceScenes[scene].draw(canvas.getContext('2d'));
  event.target.classList.add('active');
}

// ═══════════════════════════════════════
// SPACED REPETITION ENGINE
// ═══════════════════════════════════════
const srCards = [
  { q:'What is the quadratic formula?', a:'x = (-b ± √(b²-4ac)) / 2a\n\nUsed to solve ax² + bx + c = 0', subj:'Mathematics', color:'#60A5FA' },
  { q:'What is Newton\'s Second Law of Motion?', a:'F = ma\n\nForce equals mass multiplied by acceleration. The net force on an object equals the rate of change of momentum.', subj:'Physics', color:'#4ADE80' },
  { q:'What is the difference between mitosis and meiosis?', a:'Mitosis: produces 2 identical daughter cells (diploid) — for growth and repair.\n\nMeiosis: produces 4 genetically unique cells (haploid) — for sexual reproduction.', subj:'Biology', color:'#F472B6' },
  { q:'What does "tragic flaw" (hamartia) mean in literature?', a:'A character\'s inherent quality that leads to their downfall. Often pride (hubris) in Greek tragedy. Examples: Macbeth\'s ambition, Othello\'s jealousy.', subj:'English Literature', color:'#FB923C' },
  { q:'What is Ohm\'s Law?', a:'V = IR\n\nVoltage = Current × Resistance\n\nTriangle: V on top, I and R on bottom. Cover what you need to find.', subj:'Physics', color:'#4ADE80' },
  { q:'What is the difference between ionic and covalent bonding?', a:'Ionic: transfer of electrons between a metal and non-metal (e.g. NaCl). Forms a lattice structure.\n\nCovalent: sharing of electrons between non-metals (e.g. H₂O). Can be polar or non-polar.', subj:'Chemistry', color:'#A78BFA' },
];
let srIndex = 0;
let srRevealed = false;

function openSR() {
  document.getElementById('sr-modal').style.display='flex';
  loadSRCard();
}
function closeSR() { document.getElementById('sr-modal').style.display='none'; }

function loadSRCard() {
  const card = srCards[srIndex % srCards.length];
  document.getElementById('sr-question').textContent = card.q;
  document.getElementById('sr-answer').textContent = card.a;
  document.getElementById('sr-answer').classList.remove('show');
  document.getElementById('sr-rating').classList.remove('show');
  document.getElementById('sr-tag').textContent = card.subj;
  document.getElementById('sr-tag').style.background = card.color + '22';
  document.getElementById('sr-tag').style.color = card.color;
  document.getElementById('sr-count').textContent = `Card ${srIndex+1} of ${srCards.length}`;
  srRevealed = false;
}

function revealSR() {
  if (srRevealed) return;
  srRevealed = true;
  document.getElementById('sr-answer').classList.add('show');
  document.getElementById('sr-rating').classList.add('show');
}

function rateSR(difficulty) {
  const xpMap = { easy:5, ok:10, hard:15 };
  addXP(xpMap[difficulty], difficulty==='hard'?'💪 Kept at it +15 XP':'⭐ +' + xpMap[difficulty]+' XP');
  srIndex++;
  if (srIndex >= srCards.length) {
    closeSR();
    showToast('🎉 All cards reviewed! Come back tomorrow for more.');
    return;
  }
  loadSRCard();
}

async function generateSRCard() {
  const sys = 'Create one spaced repetition flashcard for a UK GCSE/A-Level student. Return ONLY valid JSON: {"q":"question","a":"answer with key facts","subj":"subject","color":"#hexcolor"}. No markdown, no explanation.';
  try {
    const data = await callClaude([{role:'user',content:'Generate a flashcard for ' + (state.subject || 'Mathematics') + ' GCSE level'}], sys);
    const text = getReply(data).replace(/```json|```/g,'').trim();
    const card = JSON.parse(text);
    srCards.push(card);
    srIndex = srCards.length - 1;
    loadSRCard();
    showToast('✦ New AI card generated!');
  } catch(e) {
    showToast('⚠️ Could not generate card: ' + e.message.slice(0,50));
  }
}

// ═══════════════════════════════════════
// MATHJAX TRIGGER
// ═══════════════════════════════════════
function renderMath(el) {
  if (window.MathJax && window.MathJax.typesetPromise) {
    window.MathJax.typesetPromise([el]).catch(e => console.log('MathJax:', e));
  }
}

// Override addTutorMsg to trigger MathJax on AI responses
const _origAddTutorMsg = addTutorMsg;
// We patch it inline below after page load
window.addEventListener('load', () => {
  // Patch tutor messages to render math
  const origTutor = window.addTutorMsg;
  if (origTutor) {
    window.addTutorMsg = function(role, text) {
      origTutor(role, text);
      const msgs = document.getElementById('tutor-messages');
      if (msgs) renderMath(msgs);
    };
  }
  // Show SR and geo buttons after login
  const origEnterDash = window.enterDashboard;
  if (origEnterDash) {
    window.enterDashboard = function() {
      origEnterDash();
      document.getElementById('geo-toggle-btn').classList.add('show');
      document.getElementById('sr-float-btn').style.display='flex';
    };
  }
});

// ═══════════════════════════════════════
// SUBJECT COLOUR THEMING
// ═══════════════════════════════════════
const subjectThemes = {
  'Mathematics': {color:'#60A5FA', class:'theme-math', emoji:'➕'},
  'Economics': {color:'#C9A84C', class:'theme-econ', emoji:'💰'},
  'Physics': {color:'#4ADE80', class:'theme-sci', emoji:'⚡'},
  'Chemistry': {color:'#A78BFA', class:'theme-comp', emoji:'🧪'},
  'Biology': {color:'#F472B6', class:'theme-eng', emoji:'🧬'},
  'English Literature': {color:'#FB923C', class:'theme-hist', emoji:'📖'},
  'History': {color:'#FBBF24', class:'theme-lang', emoji:'🏛️'},
  'Computer Science': {color:'#A78BFA', class:'theme-comp', emoji:'💻'},
  'French': {color:'#34D399', class:'theme-geo', emoji:'🇫🇷'},
};

// Override setSubject to also apply colour theme
const _origSetSubject = window.setSubject;
window.addEventListener('DOMContentLoaded', () => {
  window.setSubject = function(name, icon, color) {
    if (_origSetSubject) _origSetSubject(name, icon, color);
    const theme = subjectThemes[name];
    if (theme) {
      const chat = document.querySelector('.tutor-chat');
      if (chat) {
        chat.style.setProperty('--subject-color', theme.color);
      }
      // Update sidebar active item
      document.querySelectorAll('.subj-btn').forEach(b => b.classList.remove('active'));
    }
  };
});

// ═══════════════════════════════════════
// SHOW PANELS
// ═══════════════════════════════════════
function showMolecule() {
  const panel = document.getElementById('molecule-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display !== 'none') {
    setTimeout(() => drawMolecule('H2O'), 50);
  }
}

function showForce() {
  const panel = document.getElementById('force-diagram-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display !== 'none') {
    setTimeout(() => {
      const ctx = document.getElementById('force-canvas-el').getContext('2d');
      forceScenes.freebody.draw(ctx);
    }, 50);
  }
}

// ═══════════════════════════════════════
// COLOURFUL HOMEPAGE FLOATING EMOJIS
// ═══════════════════════════════════════
window.addEventListener('DOMContentLoaded', () => {
  const hero = document.querySelector('.hero');
  if (hero) {
    const emojis = ['🧮','⚗️','📐','🔬','📝','🎯','⚡','🧬','📖','💡','🏆','🎓'];
    emojis.forEach((em, i) => {
      const el = document.createElement('div');
      el.className = 'floating-emoji';
      el.textContent = em;
      el.style.left = (10 + Math.random() * 80) + '%';
      el.style.top = (10 + Math.random() * 80) + '%';
      el.style.animationDelay = (i * 0.5) + 's';
      el.style.animationDuration = (5 + Math.random() * 4) + 's';
      el.style.position = 'absolute';
      hero.style.position = 'relative';
      hero.appendChild(el);
    });
  }

  // Colourful feature cards
  const fcColors = ['fc-blue','fc-green','fc-pink','fc-orange','fc-purple','fc-gold'];
  document.querySelectorAll('.feature-card').forEach((card, i) => {
    card.classList.add(fcColors[i % fcColors.length]);
  });

  // Colourful subject pills
  const spColors = ['sp-math','sp-sci','sp-eng','sp-hist','sp-comp','sp-econ','sp-lang','sp-geo','sp-lang','sp-geo','sp-sci','sp-math'];
  document.querySelectorAll('.subject-pill').forEach((pill, i) => {
    pill.classList.add(spColors[i % spColors.length]);
  });
});
</script>
<script>
// ═══════════════════════════════════════
// MOBILE NAV
// ═══════════════════════════════════════
function setMobNav(active) {
  document.querySelectorAll('.mob-nav-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('mn-' + active);
  if (btn) btn.classList.add('active');
}

function showMobileNav(show) {
  document.getElementById('mobile-nav').style.display = show ? 'block' : 'none';
}

// ═══════════════════════════════════════
// POMODORO TIMER
// ═══════════════════════════════════════
const pom = {
  duration: 25 * 60,
  breakDuration: 5 * 60,
  longBreakDuration: 15 * 60,
  timeLeft: 25 * 60,
  isRunning: false,
  isBreak: false,
  session: 0,
  interval: null,
  totalSessions: 4
};

function togglePomodoro() {
  const w = document.getElementById('pomodoro-widget');
  w.classList.toggle('show');
}

function pomStart() {
  if (pom.isRunning) {
    clearInterval(pom.interval);
    pom.isRunning = false;
    document.getElementById('pom-start-btn').textContent = '▶ Resume';
    return;
  }
  pom.isRunning = true;
  document.getElementById('pom-start-btn').textContent = '⏸ Pause';
  pom.interval = setInterval(() => {
    pom.timeLeft--;
    updatePomDisplay();
    if (pom.timeLeft <= 0) {
      clearInterval(pom.interval);
      pom.isRunning = false;
      pomPhaseEnd();
    }
  }, 1000);
}

function pomPhaseEnd() {
  if (!pom.isBreak) {
    pom.session++;
    document.getElementById('pd' + (pom.session - 1))?.classList.add('done');
    addXP(25, '⏱️ Focus session complete! +25 XP');
    if (pom.session >= pom.totalSessions) {
      pom.timeLeft = pom.longBreakDuration;
      pom.session = 0;
      document.querySelectorAll('.pom-dot').forEach(d => d.classList.remove('done'));
      document.getElementById('pom-phase-label').textContent = '🎉 Long Break';
      document.getElementById('pom-phase-text').textContent = 'Amazing work! Take a 15 minute break.';
      document.getElementById('pom-display').classList.add('break');
    } else {
      pom.timeLeft = pom.breakDuration;
      document.getElementById('pom-phase-label').textContent = '☕ Short Break';
      document.getElementById('pom-phase-text').textContent = 'Take a 5 minute break — stretch and breathe!';
      document.getElementById('pom-display').classList.add('break');
    }
    pom.isBreak = true;
    showToast('✅ Focus session done! Take a break.');
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('Lumina AI — Break time!', { body: 'Great focus session! Time for a break 🎉', icon: '/favicon.ico' });
    }
  } else {
    pom.timeLeft = pom.duration;
    pom.isBreak = false;
    document.getElementById('pom-phase-label').textContent = '🎯 Focus Session';
    document.getElementById('pom-phase-text').textContent = "Stay focused — you've got this! 💪";
    document.getElementById('pom-display').classList.remove('break');
    showToast('🎯 Break over — back to studying!');
  }
  document.getElementById('pom-start-btn').textContent = '▶ Start';
  updatePomDisplay();
}

function pomReset() {
  clearInterval(pom.interval);
  pom.isRunning = false;
  pom.isBreak = false;
  pom.timeLeft = pom.duration;
  document.getElementById('pom-start-btn').textContent = '▶ Start';
  document.getElementById('pom-phase-label').textContent = '🎯 Focus Session';
  document.getElementById('pom-phase-text').textContent = "Stay focused — you've got this! 💪";
  document.getElementById('pom-display').classList.remove('break', 'warning');
  updatePomDisplay();
}

function updatePomDisplay() {
  const m = Math.floor(pom.timeLeft / 60);
  const s = pom.timeLeft % 60;
  const str = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  document.getElementById('pom-display').textContent = str;
  document.getElementById('pom-float-time').textContent = str;
  // Ring
  const total = pom.isBreak ? (pom.session >= pom.totalSessions ? pom.longBreakDuration : pom.breakDuration) : pom.duration;
  const pct = pom.timeLeft / total;
  const circumference = 251.2;
  document.getElementById('pom-ring-circle').style.strokeDashoffset = circumference * (1 - pct);
  document.getElementById('pom-ring-circle').style.stroke = pom.isBreak ? '#4ADE80' : (pom.timeLeft < 60 ? '#FB923C' : '#C9A84C');
  if (pom.timeLeft < 60 && !pom.isBreak) {
    document.getElementById('pom-display').classList.add('warning');
  } else {
    document.getElementById('pom-display').classList.remove('warning');
  }
}

// ═══════════════════════════════════════
// STUDENT NOTEBOOK
// ═══════════════════════════════════════
let notes = [];
let noteFilter = 'all';
let selectedNoteTag = 'Mathematics';

function selectNoteTag(btn) {
  document.querySelectorAll('#note-subject-tags .note-tag-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedNoteTag = btn.dataset.tag;
}

function saveNote() {
  const text = document.getElementById('note-text-input').value.trim();
  if (!text) { showToast('Please write something first!'); return; }
  const note = {
    id: Date.now(),
    text,
    subject: selectedNoteTag,
    date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
    time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
  };
  notes.unshift(note);
  saveNotesToStorage();
  document.getElementById('note-text-input').value = '';
  renderNotes();
  addXP(5, '📓 Note saved +5 XP');
  showToast('✅ Note saved to your notebook!');
}

function saveLastMsgToNotes() {
  const msgs = document.getElementById('tutor-messages');
  if (!msgs) return;
  const botMsgs = msgs.querySelectorAll('.msg.bot');
  if (!botMsgs.length) { showToast('No AI response to save yet!'); return; }
  const last = botMsgs[botMsgs.length - 1].textContent;
  document.getElementById('note-text-input').value = last;
  showDash('notes');
  showToast('📓 Last AI response copied — add a tag and save!');
}

async function aiSummariseNote() {
  const text = document.getElementById('note-text-input').value.trim();
  if (!text) { showToast('Write or paste something to summarise first!'); return; }
  showToast('✦ Claude is summarising...');
  const sys = 'You are helping a student create concise revision notes. Summarise the provided text into clear bullet points. Use UK English. Keep it short and memorable — ideal for revision.';
  try {
    const data = await callClaude([{ role: 'user', content: 'Summarise this for my revision notes:\n\n' + text }], sys);
    document.getElementById('note-text-input').value = getReply(data);
    showToast('✦ Summarised! Review and save.');
  } catch(e) {
    showToast('⚠️ ' + e.message.slice(0,60));
  }
}

function deleteNote(id) {
  notes = notes.filter(n => n.id !== id);
  saveNotesToStorage();
  renderNotes();
  showToast('🗑️ Note deleted');
}

function filterNotes(filter, btn) {
  noteFilter = filter;
  document.querySelectorAll('[id^="filter-"]').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  renderNotes();
}

function renderNotes() {
  const container = document.getElementById('notes-list');
  const filtered = noteFilter === 'all' ? notes : notes.filter(n => n.subject === noteFilter);
  if (!filtered.length) {
    container.innerHTML = `<div style="text-align:center;padding:3rem;color:var(--muted)">
      <div style="font-size:3rem;margin-bottom:1rem">📓</div>
      <div style="font-weight:700;margin-bottom:.5rem">${noteFilter === 'all' ? 'No notes yet' : 'No ' + noteFilter + ' notes'}</div>
      <div style="font-size:.875rem">Write a note above or save an AI explanation</div>
    </div>`;
    return;
  }
  const subjectColors = {Mathematics:'#60A5FA',Physics:'#4ADE80',Chemistry:'#A78BFA',Biology:'#F472B6',English:'#FB923C',History:'#FBBF24',General:'#C9A84C'};
  container.innerHTML = filtered.map(n => `
    <div class="note-card" style="border-left-color:${subjectColors[n.subject]||'var(--gold)'}">
      <div class="note-card-header">
        <span class="note-subject-tag" style="background:${subjectColors[n.subject]||'var(--gold)'}22;color:${subjectColors[n.subject]||'var(--gold)'}">${n.subject}</span>
        <span class="note-date">${n.date} · ${n.time}</span>
      </div>
      <div class="note-text">${n.text.replace(/\n/g,'<br>')}</div>
      <button class="note-delete" onclick="deleteNote(${n.id})" title="Delete note">🗑️</button>
    </div>
  `).join('');
}

function saveNotesToStorage() {
  try { localStorage.setItem('lumina_notes', JSON.stringify(notes)); } catch(e) {}
}

function loadNotesFromStorage() {
  try {
    const saved = localStorage.getItem('lumina_notes');
    if (saved) { notes = JSON.parse(saved); renderNotes(); }
  } catch(e) {}
}

// ═══════════════════════════════════════
// ONBOARDING TOUR
// ═══════════════════════════════════════
const tourSteps = [
  { title: 'Welcome to Lumina AI! 🎓', desc: "You're about to experience AI-powered learning built for every type of learner. Let me show you the 6 key features in 60 seconds.", target: null },
  { title: 'AI Tutor 🤖', desc: 'This is your personal Lumina AI tutor. Ask anything — it explains step by step, adapts to your level, and remembers the subject you\'re studying.', target: 'si-tutor' },
  { title: 'Question Generator 📝', desc: 'Generate real exam-style questions for any subject, board, or topic. Get instant AI feedback on your answers.', target: 'si-questions' },
  { title: 'Your Notebook 📓', desc: 'Save important AI explanations and formulas here. Use the Save to Notes button after any tutor response.', target: 'si-notes' },
  { title: 'Accessibility Modes ♿', desc: 'Three independent modes — ADHD, Dyslexia, and Dyscalculia. Each adapts the whole platform to how you learn best. Toggle them anytime.', target: 'a11y-bar' },
  { title: 'Pomodoro Timer ⏱️', desc: 'Use the focus timer to study in 25-minute sessions with 5-minute breaks. Perfect for ADHD and building good study habits.', target: 'pom-float' },
];
let tourStep = 0;

function startTour() {
  tourStep = 0;
  document.getElementById('tour-overlay').classList.add('show');
  showTourStep();
}

function showTourStep() {
  const step = tourSteps[tourStep];
  document.getElementById('tour-title').textContent = step.title;
  document.getElementById('tour-desc').textContent = step.desc;
  document.getElementById('tour-step-num').textContent = `Step ${tourStep + 1} of ${tourSteps.length}`;
  // Dots
  document.getElementById('tour-dots').innerHTML = tourSteps.map((_,i) =>
    `<div class="tour-dot ${i === tourStep ? 'active' : ''}"></div>`
  ).join('');
  // Highlight
  const hl = document.getElementById('tour-highlight');
  if (step.target) {
    const el = document.getElementById(step.target);
    if (el) {
      const r = el.getBoundingClientRect();
      hl.style.cssText = `top:${r.top-6}px;left:${r.left-6}px;width:${r.width+12}px;height:${r.height+12}px;display:block`;
    }
  } else {
    hl.style.display = 'none';
  }
  // Position tour box
  const box = document.getElementById('tour-box');
  if (step.target) {
    const el = document.getElementById(step.target);
    if (el) {
      const r = el.getBoundingClientRect();
      box.style.top = (r.bottom + 16) + 'px';
      box.style.left = Math.max(16, r.left) + 'px';
      box.style.right = 'auto';
    }
  } else {
    box.style.cssText = 'top:50%;left:50%;transform:translate(-50%,-50%)';
  }
  // Button label
  document.querySelector('.tour-next').textContent = tourStep === tourSteps.length - 1 ? '🚀 Let\'s Go!' : 'Next →';
}

function tourNext() {
  tourStep++;
  if (tourStep >= tourSteps.length) { skipTour(); return; }
  showTourStep();
}

function skipTour() {
  document.getElementById('tour-overlay').classList.remove('show');
  try { localStorage.setItem('lumina_tour_done', '1'); } catch(e) {}
}

// ═══════════════════════════════════════
// LIGHT MODE
// ═══════════════════════════════════════
function toggleLightMode() {
  document.body.classList.toggle('light-mode');
  const tog = document.getElementById('tog-light');
  if (tog) tog.classList.toggle('on', document.body.classList.contains('light-mode'));
  try { localStorage.setItem('lumina_light', document.body.classList.contains('light-mode') ? '1' : '0'); } catch(e) {}
}

// ═══════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════
function searchDash(query) {
  const results = document.getElementById('search-results');
  if (!query.trim()) { results.style.display = 'none'; return; }
  const q = query.toLowerCase();
  // Search notes
  const noteMatches = notes.filter(n => n.text.toLowerCase().includes(q) || n.subject.toLowerCase().includes(q)).slice(0, 3);
  // Search subjects
  const subjects = ['Mathematics','Physics','Chemistry','Biology','English Literature','History','Computer Science','Economics','French'];
  const subjectMatches = subjects.filter(s => s.toLowerCase().includes(q));
  // Search features
  const features = [
    { name:'AI Tutor', action:"showDash('tutor')" },
    { name:'Question Generator', action:"showDash('questions')" },
    { name:'Progress', action:"showDash('progress')" },
    { name:'Notebook', action:"showDash('notes')" },
    { name:'Strengths', action:"showDash('strengths')" },
    { name:'Assignments', action:"showDash('assignments')" },
    { name:'Settings', action:"showDash('settings')" },
    { name:'Geometry Canvas', action:"toggleGeo()" },
    { name:'Flashcards', action:"openSR()" },
    { name:'Pomodoro Timer', action:"togglePomodoro()" },
  ];
  const featureMatches = features.filter(f => f.name.toLowerCase().includes(q));

  let html = '';
  if (featureMatches.length) {
    html += `<div style="padding:.5rem 1rem;font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em">Pages</div>`;
    featureMatches.slice(0,4).forEach(f => {
      html += `<div onclick="${f.action};document.getElementById('search-results').style.display='none';document.getElementById('dash-search').value=''" 
        style="padding:.6rem 1rem;cursor:pointer;font-size:.875rem;transition:background .1s" 
        onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">${f.name}</div>`;
    });
  }
  if (subjectMatches.length) {
    html += `<div style="padding:.5rem 1rem;font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em">Subjects</div>`;
    subjectMatches.slice(0,3).forEach(s => {
      html += `<div onclick="showDash('tutor');setSubject('${s}','','');document.getElementById('search-results').style.display='none'" 
        style="padding:.6rem 1rem;cursor:pointer;font-size:.875rem" 
        onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">📚 ${s}</div>`;
    });
  }
  if (noteMatches.length) {
    html += `<div style="padding:.5rem 1rem;font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em">Notes</div>`;
    noteMatches.forEach(n => {
      html += `<div onclick="showDash('notes');document.getElementById('search-results').style.display='none'" 
        style="padding:.6rem 1rem;cursor:pointer;font-size:.85rem;border-bottom:1px solid var(--border)" 
        onmouseover="this.style.background='var(--bg3)'" onmouseout="this.style.background=''">
        <div style="font-weight:600;color:var(--gold);font-size:.75rem">${n.subject}</div>
        <div style="color:var(--white)">${n.text.slice(0,60)}...</div>
      </div>`;
    });
  }
  if (!html) {
    html = `<div style="padding:1rem;text-align:center;color:var(--muted);font-size:.85rem">No results for "${query}"</div>`;
  }
  results.innerHTML = html;
  results.style.display = 'block';
}

// Close search on click outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('#dash-search-wrap')) {
    const r = document.getElementById('search-results');
    if (r) r.style.display = 'none';
  }
});

// ═══════════════════════════════════════
// PARENT DASHBOARD (homeschool plan)
// ═══════════════════════════════════════
function showParentDash() {
  // Inject parent dashboard panel if not exists
  if (document.getElementById('parent-dash-modal')) {
    document.getElementById('parent-dash-modal').style.display = 'flex';
    return;
  }
  const modal = document.createElement('div');
  modal.id = 'parent-dash-modal';
  modal.style.cssText = 'display:flex;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center;padding:1rem';
  modal.innerHTML = `
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:2rem;max-width:700px;width:100%;max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2rem">
        <div>
          <div style="font-family:var(--font-head);font-size:1.5rem;font-weight:700">👨‍👩‍👧 Parent Dashboard</div>
          <div style="color:var(--muted);font-size:.875rem">Monitor your child's progress — Homeschool Plan</div>
        </div>
        <button onclick="document.getElementById('parent-dash-modal').style.display='none'" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.5rem">✕</button>
      </div>
      <!-- Child overview -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem">
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center">
          <div style="font-size:1.8rem;font-weight:800;color:var(--gold)">14</div>
          <div style="font-size:.75rem;color:var(--muted)">Day Streak 🔥</div>
        </div>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center">
          <div style="font-size:1.8rem;font-weight:800;color:var(--green)">78%</div>
          <div style="font-size:.75rem;color:var(--muted)">Avg. Accuracy</div>
        </div>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center">
          <div style="font-size:1.8rem;font-weight:800;color:var(--blue)">1,247</div>
          <div style="font-size:.75rem;color:var(--muted)">Questions Done</div>
        </div>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:1.25rem;text-align:center">
          <div style="font-size:1.8rem;font-weight:800;color:var(--purple)">0</div>
          <div style="font-size:.75rem;color:var(--muted)">Topics Mastered</div>
        </div>
      </div>
      <!-- Weekly activity -->
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem">
        <div style="font-weight:700;margin-bottom:1rem">📅 This Week's Activity</div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:.4rem;text-align:center">
          ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map((d,i) => {
            const h = [45,80,30,95,60,20,70][i];
            return `<div>
              <div style="background:rgba(201,168,76,${h/100});border-radius:6px;height:${Math.max(20,h*0.6)}px;margin-bottom:.25rem"></div>
              <div style="font-size:.65rem;color:var(--muted)">${d}</div>
              <div style="font-size:.65rem;color:var(--gold)">${h}m</div>
            </div>`;
          }).join('')}
        </div>
      </div>
      <!-- Subject progress -->
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem">
        <div style="font-weight:700;margin-bottom:1rem">📊 Subject Progress</div>
        ${[['Mathematics','72%',72,'#60A5FA'],['Biology','81%',81,'#4ADE80'],['Physics','65%',65,'#A78BFA'],['Chemistry','58%',58,'#FB923C']].map(([s,pct,n,c]) =>
          `<div style="margin-bottom:.75rem">
            <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:.35rem"><span>${s}</span><strong style="color:${c}">${pct}</strong></div>
            <div style="height:8px;background:var(--bg4);border-radius:4px"><div style="height:100%;width:${n}%;background:${c};border-radius:4px"></div></div>
          </div>`
        ).join('')}
      </div>
      <!-- Attention needed -->
      <div style="background:rgba(251,113,133,0.08);border:1px solid rgba(251,113,133,0.3);border-radius:12px;padding:1.5rem">
        <div style="font-weight:700;margin-bottom:.75rem;color:var(--red)">⚠️ Needs Attention</div>
        <div style="font-size:.875rem;color:var(--muted)">Struggling with: <strong style="color:var(--white)">Trigonometry (38%)</strong>, <strong style="color:var(--white)">Organic Chemistry (42%)</strong></div>
        <button onclick="showDash('strengths');document.getElementById('parent-dash-modal').style.display='none'" style="margin-top:1rem;background:var(--gold);color:var(--black);border:none;border-radius:8px;padding:.6rem 1.25rem;font-weight:700;cursor:pointer">View Full Analysis →</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// ═══════════════════════════════════════
// PATCH enterDashboard to wire everything up
// ═══════════════════════════════════════
const _prevEnterDash = window.enterDashboard;
window.enterDashboard = function() {
  if (_prevEnterDash) _prevEnterDash();

  // Show mobile nav
  showMobileNav(true);

  // Show pom float btn and search
  document.getElementById('pom-float').classList.add('show');
  const searchWrap = document.getElementById('dash-search-wrap');
  if (searchWrap) searchWrap.style.display = 'block';

  // Load notes from storage
  loadNotesFromStorage();

  // Load light mode preference
  try {
    if (localStorage.getItem('lumina_light') === '1') {
      document.body.classList.add('light-mode');
      const tog = document.getElementById('tog-light');
      if (tog) tog.classList.add('on');
    }
  } catch(e) {}

  // Add parent dashboard button if homeschool plan
  if (state.user && state.user.plan === 'home') {
    const sbNav = document.querySelector('.sidebar-nav');
    if (sbNav && !document.getElementById('parent-dash-btn')) {
      const btn = document.createElement('div');
      btn.id = 'parent-dash-btn';
      btn.className = 'sidebar-item';
      btn.style.borderTop = '1px solid var(--border)';
      btn.style.marginTop = '1rem';
      btn.style.color = 'var(--gold)';
      btn.innerHTML = '<i class="fas fa-users"></i>Parent View';
      btn.onclick = showParentDash;
      sbNav.appendChild(btn);
    }
  }

  // Request notification permission for ADHD users
  if (state.user && state.user.diffs && state.user.diffs.includes('adhd')) {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }

  // Show tour for first-time users
  try {
    if (!localStorage.getItem('lumina_tour_done')) {
      setTimeout(startTour, 1000);
    }
  } catch(e) {}
};

// ═══════════════════════════════════════
// PATCH showDash to wire notes sidebar
// ═══════════════════════════════════════
const _prevShowDash = window.showDash;
window.showDash = function(sub) {
  if (_prevShowDash) _prevShowDash(sub);
  // Wire notes sidebar item
  const siNotes = document.getElementById('si-notes');
  if (siNotes) siNotes.classList.toggle('active', sub === 'notes');
  // Mobile nav sync
  const mobBtns = ['home','tutor','questions','notes','progress'];
  mobBtns.forEach(b => {
    const el = document.getElementById('mn-' + b);
    if (el) el.classList.toggle('active', b === sub);
  });
  if (sub === 'notes') renderNotes();
};

// ═══════════════════════════════════════
// CHECKLIST DATA (for reference display)
// ═══════════════════════════════════════
const featureChecklist = {
  'Core Platform': [
    { name: 'AI Tutor (Lumina AI)', done: true },
    { name: 'Question Paper Generator', done: true },
    { name: 'Real Authentication (backend)', done: false, note: 'Using localStorage session' },
    { name: 'Search Bar', done: true },
    { name: 'Mobile Bottom Navigation', done: true },
    { name: 'Light / Dark Mode', done: true },
  ],
  'Study Tools': [
    { name: 'Pomodoro Focus Timer', done: true },
    { name: 'Student Notebook / Notes', done: true },
    { name: 'Spaced Repetition Flashcards', done: true },
    { name: 'Interactive Geometry Canvas', done: true },
    { name: 'Molecule Viewer', done: true },
    { name: 'Force Diagrams', done: true },
    { name: 'MathJax Equation Rendering', done: true },
  ],
  'Accessibility': [
    { name: 'ADHD Mode (step-by-step, breaks)', done: true },
    { name: 'Dyslexia Mode (Lexend font, spacing)', done: true },
    { name: 'Dyscalculia Mode (visual calculator)', done: true },
    { name: 'Audio Read-Aloud (TTS)', done: true },
    { name: 'Voice Input (Speech-to-Text)', done: true },
  ],
  'Progress & Gamification': [
    { name: 'XP & Level System', done: true },
    { name: 'Study Streak', done: true },
    { name: 'Achievements & Badges', done: true },
    { name: 'Activity Heatmap', done: true },
    { name: 'Strengths & Weaknesses AI Analysis', done: true },
  ],
  'Onboarding & UX': [
    { name: 'Interactive Onboarding Tour', done: true },
    { name: 'Login Persistence (stay logged in)', done: true },
    { name: 'Subject Colour Theming', done: true },
    { name: 'Colourful Joyful Homepage', done: true },
    { name: 'Interactive Video with Quiz Questions', done: true },
    { name: 'GDPR / Privacy Flow', done: true },
    { name: 'Cookie Banner', done: true },
  ],
  'School Features': [
    { name: 'Teacher Assignment Creation', done: true },
    { name: 'Student Assignment View + AI Hints', done: true },
    { name: 'Parent Dashboard (Homeschool Plan)', done: true },
  ],
  'Payment': [
    { name: 'Stripe Payment Integration', done: false, note: 'Excluded by request — add separately' },
    { name: 'Real Backend Auth', done: false, note: 'Needs server/database' },
  ]
};

console.log('Lumina AI v8 Feature Checklist:');
Object.entries(featureChecklist).forEach(([cat, items]) => {
  console.log('\n' + cat.toUpperCase());
  items.forEach(i => console.log((i.done ? '✅' : '⬜') + ' ' + i.name + (i.note ? ' (' + i.note + ')' : '')));
});
</script>
<script>
// ════════════════════════════════════════════════════
// LUMINA AI V9 — ALL MISSING FEATURES
// ════════════════════════════════════════════════════

// ─── ESSAY MARKER ───────────────────────────────────
let essayImageBase64 = null;

function handleEssayImage(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    essayImageBase64 = ev.target.result.split(',')[1];
    document.getElementById('essay-img-drop').innerHTML = `<i class="fas fa-check-circle" style="color:var(--green)"></i><div style="color:var(--green);font-weight:600">Image uploaded — will be included in marking</div>`;
  };
  reader.readAsDataURL(file);
}

async function markEssay() {
  const subject = document.getElementById('essay-subject').value;
  const board = document.getElementById('essay-board').value;
  const question = document.getElementById('essay-question').value;
  const text = document.getElementById('essay-text').value.trim();
  if (text.length < 50) { showToast('Please write at least 50 words to mark'); return; }

  const btn = document.getElementById('essay-submit-btn');
  btn.textContent = '✦ Marking your essay...';
  btn.disabled = true;
  document.getElementById('essay-results').style.display = 'none';

  const sys = `You are an experienced UK ${subject} examiner for ${board}. Mark the student's essay strictly. Return ONLY valid JSON with NO markdown:
{
  "grade": "A*|A|B|C|D|E",
  "marks": "e.g. 28/30",
  "criteria": [{"name":"AO1 Knowledge","score":85},{"name":"AO2 Analysis","score":72},{"name":"AO3 Context","score":68},{"name":"AO4 Expression","score":90}],
  "feedback": "Detailed paragraph feedback",
  "improve": "Specific bullet points on how to improve"
}`;

  const msgs = [{ role: 'user', content: `Question: ${question || 'General essay'}\n\nEssay:\n${text}` }];

  try {
    const data = await callClaude(msgs, sys);
    const raw = getReply(data).replace(/```json|```/g,'').trim();
    const result = JSON.parse(raw);

    // Display grade
    const gradeMap = {'A*':'a','A':'a','B':'b','C':'c','D':'d','E':'e','U':'e'};
    const gradeClass = gradeMap[result.grade] || 'c';
    document.getElementById('essay-grade-circle').textContent = result.grade;
    document.getElementById('essay-grade-circle').className = `essay-grade grade-${gradeClass}`;
    document.getElementById('essay-grade-label').textContent = `Grade ${result.grade}`;
    document.getElementById('essay-marks-label').textContent = result.marks;

    // Criteria bars
    const bars = document.getElementById('essay-criteria-bars');
    bars.innerHTML = (result.criteria || []).map(c => `
      <div class="essay-criteria-bar">
        <div class="essay-criteria-label">${c.name}</div>
        <div class="essay-criteria-track"><div class="essay-criteria-fill" style="width:${c.score}%"></div></div>
        <div class="essay-criteria-score">${c.score}%</div>
      </div>`).join('');

    document.getElementById('essay-feedback-text').innerHTML = (result.feedback || '').replace(/\n/g,'<br>');
    document.getElementById('essay-improve-text').innerHTML = (result.improve || '').replace(/\n/g,'<br>');
    document.getElementById('essay-results').style.display = 'block';
    addXP(30, '✍️ Essay marked +30 XP');
    // Save to history
    saveChatToHistory(subject, `Essay: ${question || 'Marked essay'}`, `Grade ${result.grade} — ${result.marks}`);
  } catch(e) {
    showToast('⚠️ Marking failed — please try again');
    console.error(e);
  }
  btn.textContent = '✦ Mark My Essay';
  btn.disabled = false;
}

function exportEssayFeedback() {
  const grade = document.getElementById('essay-grade-label').textContent;
  const marks = document.getElementById('essay-marks-label').textContent;
  const feedback = document.getElementById('essay-feedback-text').textContent;
  const improve = document.getElementById('essay-improve-text').textContent;
  const content = `LUMINA AI — ESSAY FEEDBACK\n${'='.repeat(40)}\n${grade} | ${marks}\n\nFEEDBACK:\n${feedback}\n\nHOW TO IMPROVE:\n${improve}`;
  const blob = new Blob([content], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'lumina-essay-feedback.txt'; a.click();
}

// ─── IMAGE UPLOAD TO TUTOR ───────────────────────────
let tutorImages = [];

function handleTutorImage(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    tutorImages.push({ data: ev.target.result.split(',')[1], type: file.type });
    showTutorImagePreview();
    showToast('📷 Image added — ask your question and I\'ll analyse it!');
  };
  reader.readAsDataURL(file);
}

function showTutorImagePreview() {
  let strip = document.getElementById('tutor-img-strip');
  if (!strip) {
    strip = document.createElement('div');
    strip.id = 'tutor-img-strip';
    strip.className = 'img-preview-strip';
    const inputArea = document.querySelector('.tutor-input-row') || document.querySelector('.chat-input-row');
    if (inputArea) inputArea.parentNode.insertBefore(strip, inputArea);
  }
  strip.innerHTML = tutorImages.map((img, i) => `
    <div class="img-preview-item">
      <img src="data:${img.type};base64,${img.data}" alt="Uploaded question">
      <button onclick="removeImage(${i})">✕</button>
    </div>`).join('');
}

function removeImage(i) {
  tutorImages.splice(i, 1);
  showTutorImagePreview();
}

// Override callTutor to include images
const _origCallTutor = window.callTutor;
window.callTutor = async function(userText) {
  if (tutorImages.length > 0) {
    // Build vision message
    const content = [{ type: 'text', text: userText }];
    tutorImages.forEach(img => {
      content.push({ type: 'image', source: { type: 'base64', media_type: img.type, data: img.data } });
    });
    addTutorMsg('user', userText + (tutorImages.length ? ` [${tutorImages.length} image(s) attached]` : ''));
    tutorImages = [];
    const strip = document.getElementById('tutor-img-strip');
    if (strip) strip.innerHTML = '';
    // Show skeleton loading
    showTutorSkeleton();
    try {
      const data = await callClaude([{ role: 'user', content }], buildTutorSystem());
      hideTutorSkeleton();
      const reply = getReply(data);
      addTutorMsg('bot', reply);
      addXP(10, '🤖 Question answered +10 XP');
      saveChatToHistory(state.subject, userText.slice(0,60), reply.slice(0,100));
    } catch(e) {
      hideTutorSkeleton();
      addTutorMsg('bot', '⚠️ Sorry, I had trouble answering that. Please try again.');
    }
    return;
  }
  if (_origCallTutor) return _origCallTutor(userText);
};

function buildTutorSystem() {
  let sys = `You are Lumina, a friendly and expert UK tutor for ${state.subject || 'all subjects'}. Explain clearly, use examples, and adapt to the student's level. Use UK English and follow UK curriculum standards. If an image is provided, analyse it thoroughly.`;
  if (state.modes?.adhd) sys += '\nADHD MODE: Use numbered steps, short sentences, clear structure.';
  if (state.modes?.dyslexia) sys += '\nDYSLEXIA MODE: Short sentences, bullet points, simple vocabulary.';
  if (state.modes?.dyscalculia) sys += '\nDYSCALCULIA MODE: Explain maths visually, step by step, words first then numbers.';
  return sys;
}

function showTutorSkeleton() {
  const msgs = document.getElementById('tutor-messages');
  if (!msgs) return;
  const sk = document.createElement('div');
  sk.id = 'tutor-skeleton'; sk.className = 'msg bot';
  sk.innerHTML = '<div class="skeleton-line long"></div><div class="skeleton-line medium"></div><div class="skeleton-line short"></div>';
  msgs.appendChild(sk); msgs.scrollTop = msgs.scrollHeight;
}
function hideTutorSkeleton() {
  const sk = document.getElementById('tutor-skeleton');
  if (sk) sk.remove();
}

// ─── EXAM COUNTDOWN ─────────────────────────────────
let exams = [];

function addExam() {
  const subject = document.getElementById('new-exam-subject').value.trim();
  const board = document.getElementById('new-exam-board').value;
  const date = document.getElementById('new-exam-date').value;
  if (!subject || !date) { showToast('Please fill in subject and date'); return; }
  exams.push({ id: Date.now(), subject, board, date });
  saveExams();
  renderExams();
  document.getElementById('new-exam-subject').value = '';
  document.getElementById('new-exam-date').value = '';
  showToast('📅 Exam added!');
}

function renderExams() {
  const container = document.getElementById('exams-list');
  if (!exams.length) {
    container.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted)"><div style="font-size:3rem;margin-bottom:1rem">📅</div><div style="font-weight:700;margin-bottom:.5rem">No exams added yet</div><div style="font-size:.875rem">Add your exam dates above to start the countdown</div></div>';
    return;
  }
  const subjectColors = { Mathematics:'#60A5FA', Physics:'#4ADE80', Chemistry:'#A78BFA', Biology:'#F472B6', English:'#FB923C', History:'#FBBF24' };
  const sorted = [...exams].sort((a,b) => new Date(a.date) - new Date(b.date));
  container.innerHTML = sorted.map(ex => {
    const now = new Date(); const examDate = new Date(ex.date);
    const diff = Math.max(0, Math.ceil((examDate - now) / (1000*60*60*24)));
    const weeks = Math.floor(diff / 7); const days = diff % 7;
    const hours = Math.floor(((examDate - now) % (1000*60*60*24)) / (1000*60*60));
    const totalDays = Math.ceil((examDate - new Date(ex.id)) / (1000*60*60*24));
    const pct = Math.max(0, Math.min(100, ((totalDays - diff) / totalDays) * 100));
    const color = subjectColors[ex.subject] || 'var(--gold)';
    const urgency = diff < 7 ? '#FB7185' : diff < 30 ? '#FBBF24' : '#4ADE80';
    return `<div class="exam-card" style="--subject-color:${color}">
      <div style="flex:1">
        <div style="font-weight:700;font-size:1rem;margin-bottom:.2rem">${ex.subject}</div>
        <div style="font-size:.8rem;color:var(--muted);margin-bottom:.75rem">${ex.board} · ${new Date(ex.date).toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
        <div class="exam-urgency-bar"><div class="exam-urgency-fill" style="width:${pct}%;background:${urgency}"></div></div>
      </div>
      <div class="exam-countdown-nums">
        ${weeks > 0 ? `<div class="exam-cd-unit"><div class="exam-cd-num">${weeks}</div><div class="exam-cd-label">wks</div></div>` : ''}
        <div class="exam-cd-unit"><div class="exam-cd-num">${days}</div><div class="exam-cd-label">days</div></div>
        <div class="exam-cd-unit"><div class="exam-cd-num">${hours}</div><div class="exam-cd-label">hrs</div></div>
      </div>
      <button onclick="exams=exams.filter(e=>e.id!==${ex.id});saveExams();renderExams()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem" title="Remove">✕</button>
    </div>`;
  }).join('');
}

function saveExams() { try { localStorage.setItem('lumina_exams', JSON.stringify(exams)); } catch(e) {} }
function loadExams() { try { const s = localStorage.getItem('lumina_exams'); if (s) { exams = JSON.parse(s); renderExams(); } } catch(e) {} }

// ─── REVISION TIMETABLE ──────────────────────────────
async function generateTimetable() {
  if (!exams.length) { showToast('Add at least one exam first!'); return; }
  const btn = document.getElementById('tt-gen-btn');
  btn.textContent = '✦ Generating timetable...'; btn.disabled = true;
  const hours = document.getElementById('tt-hours').value;
  const rest = document.getElementById('tt-rest').value;
  const examList = exams.map(e => `${e.subject} on ${new Date(e.date).toLocaleDateString('en-GB')}`).join(', ');
  const sys = `You are a revision planner. Create a 1-week timetable for a student. Return ONLY valid JSON array of 7 days:
[{"day":"Monday","slots":[{"time":"09:00","subject":"Mathematics","topic":"Algebra","duration":60},...]},...]
Each day should have ${hours} hours of study split into 45-60 min sessions. Rest day: ${rest}. Use only the student's subjects.`;
  try {
    const data = await callClaude([{role:'user',content:`My upcoming exams: ${examList}. Create my revision timetable.`}], sys);
    const raw = getReply(data).replace(/```json|```/g,'').trim();
    const days = JSON.parse(raw);
    const subjectColors = {Mathematics:'#60A5FA',Physics:'#4ADE80',Chemistry:'#A78BFA',Biology:'#F472B6',English:'#FB923C',History:'#FBBF24'};
    const output = document.getElementById('timetable-output');
    output.style.display = 'block';
    output.innerHTML = `<div style="font-weight:700;margin-bottom:1rem">Your Personalised Revision Timetable</div>
      <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:.8rem">
        <tr>${['Time','Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(d=>`<th style="padding:.5rem;background:var(--bg3);border:1px solid var(--border);white-space:nowrap">${d}</th>`).join('')}</tr>
        ${['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'].map(time => {
          const cols = days.map(day => {
            const slot = (day.slots||[]).find(s => s.time === time);
            if (!slot) return `<td style="padding:.5rem;border:1px solid var(--border);background:var(--bg3);text-align:center;color:var(--muted)">—</td>`;
            const c = subjectColors[slot.subject] || 'var(--gold)';
            return `<td style="padding:.4rem;border:1px solid var(--border);background:${c}22;text-align:center">
              <div style="font-weight:700;font-size:.75rem;color:${c}">${slot.subject.split(' ')[0]}</div>
              <div style="font-size:.65rem;color:var(--muted)">${slot.topic||''}</div>
            </td>`;
          }).join('');
          return `<tr><td style="padding:.5rem;border:1px solid var(--border);background:var(--bg3);font-family:var(--font-mono);font-size:.75rem;white-space:nowrap">${time}</td>${cols}</tr>`;
        }).join('')}
      </table></div>
      <div style="display:flex;gap:.75rem;margin-top:1rem">
        <button class="btn-gold" onclick="saveRevisionToNotes()">📓 Save to Notes</button>
        <button class="vid-ctrl-btn" onclick="window.print()">🖨️ Print</button>
      </div>`;
    addXP(20, '📆 Timetable generated +20 XP');
  } catch(e) { showToast('⚠️ Could not generate timetable'); }
  btn.textContent = '✦ Generate My Timetable'; btn.disabled = false;
}

function saveRevisionToNotes() {
  document.getElementById('note-text-input').value = 'REVISION TIMETABLE — Generated by Lumina AI\n\nSee Exam Countdown page for full timetable.';
  selectedNoteTag = 'General';
  showDash('notes');
  showToast('📓 Timetable reference saved to Notes');
}

// ─── CHAT HISTORY ────────────────────────────────────
let chatHistory = [];

function saveChatToHistory(subject, question, preview) {
  chatHistory.unshift({
    id: Date.now(), subject, question, preview,
    date: new Date().toLocaleDateString('en-GB', {day:'numeric',month:'short'}),
    time: new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'})
  });
  if (chatHistory.length > 100) chatHistory = chatHistory.slice(0, 100);
  try { localStorage.setItem('lumina_history', JSON.stringify(chatHistory)); } catch(e) {}
}

function loadChatHistory() {
  try { const s = localStorage.getItem('lumina_history'); if (s) chatHistory = JSON.parse(s); } catch(e) {}
  renderHistory();
}

function renderHistory(filter='') {
  const container = document.getElementById('history-list');
  if (!container) return;
  const subjectColors = {Mathematics:'#60A5FA',Physics:'#4ADE80',Chemistry:'#A78BFA',Biology:'#F472B6','English Literature':'#FB923C',History:'#FBBF24'};
  const filtered = filter ? chatHistory.filter(h => h.subject?.toLowerCase().includes(filter) || h.question?.toLowerCase().includes(filter)) : chatHistory;
  if (!filtered.length) {
    container.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted)"><div style="font-size:3rem;margin-bottom:1rem">💬</div><div style="font-weight:700;margin-bottom:.5rem">No conversations yet</div><div style="font-size:.875rem">Start chatting with your tutor to see your history here</div></div>';
    return;
  }
  container.innerHTML = filtered.map(h => `
    <div class="history-item" onclick="replayChat('${h.id}')">
      <div class="history-subj-dot" style="background:${subjectColors[h.subject]||'var(--gold)'}"></div>
      <div class="history-preview">
        <div class="history-title">${h.question||'Untitled conversation'}</div>
        <div class="history-snippet">${h.preview||''}</div>
      </div>
      <div>
        <div class="history-date">${h.date} ${h.time}</div>
        <div style="font-size:.7rem;color:var(--muted);text-align:right;margin-top:.2rem">${h.subject||''}</div>
      </div>
    </div>`).join('');
}

function filterHistory(q) { renderHistory(q.toLowerCase()); }
function clearHistory() { chatHistory = []; try { localStorage.removeItem('lumina_history'); } catch(e) {} renderHistory(); showToast('🗑️ Chat history cleared'); }
function replayChat(id) { showDash('tutor'); showToast('💬 Conversation loaded in Tutor'); }

// ─── GLOSSARY ────────────────────────────────────────
let glossaryTerms = {};
let glossaryFilter = 'all';

async function lookupTerm() {
  const query = document.getElementById('glossary-search').value.trim();
  const subject = document.getElementById('glossary-subject').value;
  if (!query) { showToast('Type a term to look up'); return; }
  showToast('✦ Looking up ' + query + '...');
  const sys = `You are a UK curriculum expert. Define the term for GCSE/A-Level students. Return ONLY JSON: {"term":"${query}","definition":"clear definition","example":"concrete example","mnemonic":"memory trick if helpful","relatedTerms":["term1","term2"]}`;
  try {
    const data = await callClaude([{role:'user',content:`Define "${query}" for ${subject} students`}], sys);
    const raw = getReply(data).replace(/```json|```/g,'').trim();
    const result = JSON.parse(raw);
    const letter = query[0].toUpperCase();
    if (!glossaryTerms[letter]) glossaryTerms[letter] = [];
    glossaryTerms[letter].unshift(result);
    renderGlossary();
    addXP(5, '📖 Term looked up +5 XP');
  } catch(e) { showToast('⚠️ Could not look up term'); }
}

async function searchGlossary(query) {
  if (!query || query.length < 3) { renderGlossary(); return; }
  // Filter existing
  const results = Object.values(glossaryTerms).flat().filter(t =>
    t.term?.toLowerCase().includes(query.toLowerCase()) ||
    t.definition?.toLowerCase().includes(query.toLowerCase())
  );
  const container = document.getElementById('glossary-list');
  if (results.length) {
    container.innerHTML = results.map(t => renderGlossaryTerm(t)).join('');
    return;
  }
  // Auto-lookup if not found after 600ms
  clearTimeout(window._glossaryTimeout);
  window._glossaryTimeout = setTimeout(() => {
    document.getElementById('glossary-search').value = query;
    lookupTerm();
  }, 600);
}

function renderGlossaryTerm(t) {
  return `<div class="glossary-term">
    <div class="glossary-term-word">${t.term}</div>
    <div class="glossary-term-def">${t.definition}</div>
    ${t.example ? `<div class="glossary-term-example">💡 Example: ${t.example}</div>` : ''}
    ${t.mnemonic ? `<div class="glossary-term-example" style="color:var(--purple)">🧠 Remember: ${t.mnemonic}</div>` : ''}
    ${t.relatedTerms?.length ? `<div style="margin-top:.5rem;display:flex;gap:.4rem;flex-wrap:wrap">${t.relatedTerms.map(r=>`<span onclick="document.getElementById('glossary-search').value='${r}';lookupTerm()" style="font-size:.72rem;padding:.2rem .5rem;background:var(--bg4);border-radius:6px;cursor:pointer;color:var(--blue)">${r}</span>`).join('')}</div>` : ''}
  </div>`;
}

function renderGlossary() {
  const container = document.getElementById('glossary-list');
  if (!container) return;
  const letters = Object.keys(glossaryTerms).sort();
  if (!letters.length) {
    container.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted)"><div style="font-size:3rem;margin-bottom:1rem">📖</div><div style="font-weight:700;margin-bottom:.5rem">Search for a term to get started</div><div style="font-size:.875rem">Type any word or concept above and Lumina AI will define it</div></div>';
    return;
  }
  container.innerHTML = letters.map(l =>
    `<div class="glossary-letter">${l}</div>${glossaryTerms[l].map(t => renderGlossaryTerm(t)).join('')}`
  ).join('');
}

function loadGlossary() { renderGlossary(); }
function filterGlossaryLetter(l, btn) {
  document.querySelectorAll('#glossary-alpha .note-tag-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  glossaryFilter = l;
  renderGlossary();
}

// ─── PAST PAPERS ─────────────────────────────────────
let savedPapers = [];

async function generatePastPaper() {
  const subject = document.getElementById('pp-subject').value;
  const board = document.getElementById('pp-board').value;
  const diff = document.getElementById('pp-diff').value;
  showToast('✦ Generating paper...');
  document.getElementById('papers-list').innerHTML = '<div class="skeleton-block" style="height:80px;margin-bottom:.75rem"></div><div class="skeleton-block" style="height:80px;margin-bottom:.75rem"></div><div class="skeleton-block" style="height:80px"></div>';

  const sys = `Generate 5 exam-style questions for ${diff} ${subject} (${board}). Return ONLY JSON array: [{"title":"Question 1","question":"Full question text","marks":4,"topic":"topic name","hint":"brief hint"},...]`;
  try {
    const data = await callClaude([{role:'user',content:`Generate ${diff} ${subject} ${board} exam questions`}], sys);
    const raw = getReply(data).replace(/```json|```/g,'').trim();
    const questions = JSON.parse(raw);
    const paper = { id: Date.now(), subject, board, diff, questions, date: new Date().toLocaleDateString('en-GB') };
    savedPapers.unshift(paper);
    try { localStorage.setItem('lumina_papers', JSON.stringify(savedPapers.slice(0,20))); } catch(e) {}
    renderPapers();
    addXP(20, '📄 Paper generated +20 XP');
  } catch(e) { showToast('⚠️ Could not generate paper'); document.getElementById('papers-list').innerHTML = ''; }
}

function renderPapers() {
  const c = document.getElementById('papers-list');
  if (!savedPapers.length) { c.innerHTML = ''; return; }
  const subjectColors = {Mathematics:'#60A5FA',Physics:'#4ADE80',Chemistry:'#A78BFA',Biology:'#F472B6','English Literature':'#FB923C',History:'#FBBF24'};
  const emojis = {Mathematics:'➕',Physics:'⚡',Chemistry:'🧪',Biology:'🧬','English Literature':'📖',History:'🏛️'};
  c.innerHTML = savedPapers.map(p => `
    <div class="paper-card" onclick="openPaper(${p.id})">
      <div class="paper-icon" style="background:${subjectColors[p.subject]||'var(--gold)'}22">${emojis[p.subject]||'📄'}</div>
      <div class="paper-meta">
        <div class="paper-title">${p.subject} — ${p.diff}</div>
        <div class="paper-info">${p.board} · ${p.questions.length} questions · Generated ${p.date}</div>
      </div>
      <button class="paper-action" onclick="event.stopPropagation();openPaper(${p.id})">Start →</button>
    </div>`).join('');
}

function openPaper(id) {
  const paper = savedPapers.find(p => p.id === id);
  if (!paper) return;
  // Switch to questions tab and populate
  showDash('questions');
  showToast('📄 Paper loaded — check Questions tab');
}

function loadPapers() { try { const s = localStorage.getItem('lumina_papers'); if (s) { savedPapers = JSON.parse(s); renderPapers(); } } catch(e) {} }

// ─── VIDEO GENERATOR ─────────────────────────────────
let vidScenes = []; let vidIdx = 0; let vidPlaying = false; let vidInterval = null;
let selectedVidStyle = 'step-by-step';

function selectVidStyle(btn) {
  document.querySelectorAll('[data-style]').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedVidStyle = btn.dataset.style;
}

async function generateVideo() {
  const topic = document.getElementById('vid-topic').value.trim();
  const subject = document.getElementById('vid-subject').value;
  const level = document.getElementById('vid-level').value;
  if (!topic) { showToast('Please enter a topic'); return; }

  const btn = document.getElementById('vid-gen-btn');
  btn.textContent = '✦ Generating...'; btn.disabled = true;
  document.getElementById('vid-output').style.display = 'block';
  document.getElementById('vid-prog').style.width = '20%';

  const styleGuides = {
    'step-by-step': 'Break into clear numbered steps. Each scene = one step.',
    'story': 'Tell as an engaging narrative story. Make it memorable.',
    'visual': 'Describe visual diagrams, colour-coded elements, and spatial relationships.',
    'exam': 'Focus on exam technique, mark scheme points, and common mistakes.'
  };

  const sys = `You are creating a video explainer script for a ${level} ${subject} student. ${styleGuides[selectedVidStyle]}
Return ONLY valid JSON array of 6-8 scenes: [{"title":"Scene title","content":"2-3 sentence explanation","emoji":"relevant emoji","bg":"hex color for background e.g. #1a1040"},...]
Make it engaging, clear, and educational. Use UK curriculum standards.`;

  try {
    const data = await callClaude([{role:'user',content:`Create a video explainer for: ${topic}`}], sys);
    document.getElementById('vid-prog').style.width = '70%';
    const raw = getReply(data).replace(/```json|```/g,'').trim();
    vidScenes = JSON.parse(raw);
    vidIdx = 0;
    document.getElementById('vid-prog').style.width = '100%';
    setTimeout(() => { document.getElementById('vid-prog').style.width = '0%'; }, 500);
    renderVidScene();
    startVidPlay();
    addXP(25, '🎬 Video generated +25 XP');
    saveChatToHistory(subject, `Video: ${topic}`, vidScenes[0]?.content?.slice(0,80)||'');
  } catch(e) {
    showToast('⚠️ Could not generate video');
    document.getElementById('vid-output').style.display = 'none';
  }
  btn.textContent = '🎬 Generate Video Explanation'; btn.disabled = false;
}

function renderVidScene() {
  if (!vidScenes.length) return;
  const scene = vidScenes[Math.min(vidIdx, vidScenes.length-1)];
  const preview = document.getElementById('vid-preview');
  const pct = ((vidIdx+1) / vidScenes.length) * 100;
  document.getElementById('vid-prog').style.width = pct + '%';
  document.getElementById('vid-scene-title').textContent = (scene.emoji||'') + ' ' + (scene.title||'');
  document.getElementById('vid-scene-content').innerHTML = scene.content?.replace(/\n/g,'<br>') || '';
  document.getElementById('vid-slide-counter').textContent = `Scene ${vidIdx+1} of ${vidScenes.length}`;
  if (preview && scene.bg) preview.style.background = `radial-gradient(circle at 50% 50%, ${scene.bg} 0%, #0A0C12 100%)`;
  if (window.MathJax) window.MathJax.typesetPromise([document.getElementById('vid-scene-content')]).catch(()=>{});
}

function startVidPlay() {
  vidPlaying = true;
  document.getElementById('vid-play-btn').textContent = '⏸ Pause';
  clearInterval(vidInterval);
  vidInterval = setInterval(() => {
    if (vidIdx < vidScenes.length - 1) { vidIdx++; renderVidScene(); }
    else { stopVidPlay(); }
  }, 5000);
}

function stopVidPlay() {
  vidPlaying = false;
  clearInterval(vidInterval);
  document.getElementById('vid-play-btn').textContent = '▶ Play';
}

function toggleVidPlay() { vidPlaying ? stopVidPlay() : startVidPlay(); }
function vidNext() { if (vidIdx < vidScenes.length-1) { vidIdx++; renderVidScene(); } }
function vidPrev() { if (vidIdx > 0) { vidIdx--; renderVidScene(); } }
function saveVideoToNotes() {
  const content = vidScenes.map((s,i) => `Scene ${i+1}: ${s.title}\n${s.content}`).join('\n\n');
  document.getElementById('note-text-input').value = `VIDEO EXPLAINER NOTES\n\n${content}`;
  selectedNoteTag = 'General';
  showDash('notes');
}

// ─── LEADERBOARD ─────────────────────────────────────
const lbData = {
  weekly: [
    { name:'Alex M.', emoji:'🦁', xp:1840, badge:'🔥 Hot Streak' },
    { name:'Priya S.', emoji:'🦋', xp:1720, badge:'⚡ Quick Learner' },
    { name:'Jamie L.', emoji:'🐺', xp:1650, badge:'📚 Bookworm' },
    { name:'Fatima R.', emoji:'🌟', xp:1580, badge:'🎯 Sharp Mind' },
    { name:'Oliver K.', emoji:'🦊', xp:1420, badge:'💡 Problem Solver' },
    { name:'Zara T.', emoji:'🐬', xp:1380, badge:'🏆 Achiever' },
    { name:'Marcus J.', emoji:'🦅', xp:1240, badge:'📝 Note Taker' },
    { name:'Sophie W.', emoji:'🌺', xp:1190, badge:'🧪 Lab Genius' },
  ],
  alltime: [
    { name:'Priya S.', emoji:'🦋', xp:48200, badge:'👑 Legend' },
    { name:'Alex M.', emoji:'🦁', xp:44800, badge:'🔥 On Fire' },
    { name:'Zara T.', emoji:'🐬', xp:41600, badge:'💎 Diamond' },
    { name:'Oliver K.', emoji:'🦊', xp:38900, badge:'🚀 Rocket' },
    { name:'Jamie L.', emoji:'🐺', xp:36400, badge:'📚 Scholar' },
  ]
};

let lbTab = 'weekly';
function switchLBTab(tab, btn) {
  lbTab = tab;
  document.querySelectorAll('#sp-leaderboard .note-tag-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  renderLeaderboard();
}

function renderLeaderboard() {
  const container = document.getElementById('lb-list');
  const yourRank = document.getElementById('lb-your-rank');
  if (!container) return;
  const data = lbData[lbTab] || lbData.weekly;
  const ranks = ['🥇','🥈','🥉'];
  const rankClasses = ['gold','silver','bronze'];
  container.innerHTML = data.map((p,i) => `
    <div class="lb-row">
      <div class="lb-rank ${rankClasses[i]||''}">${ranks[i]||i+1}</div>
      <div class="lb-avatar">${p.emoji}</div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-badge">${p.badge}</div>
      <div class="lb-xp">${p.xp.toLocaleString()} XP</div>
    </div>`).join('');

  // Your rank
  const userXP = (state.user?.xp || 0);
  const yourPos = data.filter(p => p.xp > userXP).length + 1;
  yourRank.innerHTML = `<div class="lb-row you">
    <div class="lb-rank">${yourPos}</div>
    <div class="lb-avatar">⭐</div>
    <div class="lb-name">You${state.user?.name ? ' ('+state.user.name.split(' ')[0]+')' : ''}</div>
    <div class="lb-badge">🌱 Growing</div>
    <div class="lb-xp">${userXP.toLocaleString()} XP</div>
  </div><p style="font-size:.8rem;color:var(--muted);margin-top:.75rem;text-align:center">Keep studying to climb the leaderboard! ${data[yourPos-2] ? `${(data[yourPos-2].xp - userXP).toLocaleString()} XP to reach #${yourPos-1}` : ''}</p>`;
}

// ─── FONT SIZE CONTROL ───────────────────────────────
let fontSize = 100;
function changeFontSize(dir) {
  fontSize = Math.max(80, Math.min(130, fontSize + dir * 5));
  document.documentElement.style.fontSize = fontSize + '%';
  document.getElementById('fs-display').textContent = fontSize + '%';
  try { localStorage.setItem('lumina_fontsize', fontSize); } catch(e) {}
}

// ─── PDF EXPORT ──────────────────────────────────────
function exportQuestionsPDF() {
  const questions = document.getElementById('generated-questions');
  if (!questions || !questions.children.length) { showToast('Generate questions first!'); return; }
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`<html><head><title>Lumina Questions</title>
  <style>body{font-family:Georgia,serif;padding:2rem;max-width:800px;margin:0 auto;color:#111}
  h1{font-size:1.5rem;margin-bottom:.5rem}hr{margin:2rem 0;border-color:#ddd}
  .q{margin-bottom:2rem;padding-bottom:2rem;border-bottom:1px solid #eee}
  .marks{float:right;font-weight:bold;color:#888}
  .answer-space{height:80px;border:1px solid #ccc;border-radius:4px;margin-top:.5rem}
  @media print{.answer-space{height:100px}}</style></head>
  <body><h1>📝 Lumina AI — Practice Questions</h1><p style="color:#888">Generated ${new Date().toLocaleDateString('en-GB')}</p><hr>
  ${Array.from(questions.children).map((q,i) => {
    const text = q.querySelector('.question-text')?.textContent || '';
    const marks = q.querySelector('.q-marks')?.textContent || '';
    return `<div class="q"><span class="marks">${marks}</span><strong>Q${i+1}.</strong> ${text}<div class="answer-space"></div></div>`;
  }).join('')}
  </body></html>`);
  printWindow.document.close();
  printWindow.print();
}

// ─── SHARE QUESTION ──────────────────────────────────
function shareQuestion() {
  const questions = document.getElementById('generated-questions');
  const first = questions?.querySelector('.question-text');
  const preview = first?.textContent?.slice(0,120) || 'Practice question';
  document.getElementById('share-question-preview').textContent = preview + '...';
  document.getElementById('share-modal').style.display = 'flex';
}
function copyShareLink() {
  navigator.clipboard.writeText(document.getElementById('share-link').value);
  showToast('🔗 Link copied!');
}
function shareViaWhatsApp() {
  const text = document.getElementById('share-question-preview').textContent;
  window.open(`https://wa.me/?text=${encodeURIComponent('Check out this practice question from Lumina AI: ' + text)}`);
}
function shareViaEmail() {
  const text = document.getElementById('share-question-preview').textContent;
  window.open(`mailto:?subject=Practice Question from Lumina AI&body=${encodeURIComponent(text)}`);
}

// ─── PASSWORD RESET ───────────────────────────────────
function sendPasswordReset() {
  const email = document.getElementById('reset-email').value.trim();
  if (!email || !email.includes('@')) { showToast('Please enter a valid email'); return; }
  document.getElementById('reset-confirm').style.display = 'block';
  // In production, this would call a backend endpoint
}

// ─── WELSH LANGUAGE ───────────────────────────────────
const welshTranslations = {
  'AI Tutor': 'Tiwtor AI',
  'Questions': 'Cwestiynau',
  'Progress': 'Cynnydd',
  'Settings': 'Gosodiadau',
  'Notebook': 'Nodiadur',
  'Leaderboard': 'Tabl Arweinwyr',
  'Glossary': 'Geirfa',
  'Chat History': 'Hanes Sgwrsio',
  'Past Papers': 'Papurau Blaenorol',
  'Essay Marker': 'Marcio Traethawd',
  'Video Explainer': 'Fideo Esboniadur',
  'Exam Countdown': 'Cyfrif i Lawr Arholiad',
};

let currentLang = 'en';
function setLanguage(lang) {
  currentLang = lang;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.id === 'lang-'+lang));
  if (lang === 'cy') {
    document.querySelectorAll('.sidebar-item').forEach(el => {
      const text = el.textContent.trim();
      const welsh = welshTranslations[text];
      if (welsh) el.innerHTML = el.innerHTML.replace(text, welsh);
    });
    showToast('🏴󠁷󠁢󠁷󠁬󠁳󠁿 Cymraeg wedi\'i osod!');
  } else {
    // Reload to restore English (simple approach)
    document.querySelectorAll('.sidebar-item').forEach(el => {
      Object.entries(welshTranslations).forEach(([en, cy]) => {
        if (el.textContent.includes(cy)) el.innerHTML = el.innerHTML.replace(cy, en);
      });
    });
    showToast('🇬🇧 Language set to English');
  }
  try { localStorage.setItem('lumina_lang', lang); } catch(e) {}
}

// ─── KEYBOARD SHORTCUTS ───────────────────────────────
document.addEventListener('keydown', (e) => {
  if (!state.user) return; // Only in dashboard
  if (e.target.matches('input,textarea,select')) return;
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 't': e.preventDefault(); showDash('tutor'); break;
      case 'k': e.preventDefault(); document.getElementById('dash-search')?.focus(); break;
      case 'q': e.preventDefault(); showDash('questions'); break;
      case 'n': e.preventDefault(); showDash('notes'); break;
      case 'p': e.preventDefault(); togglePomodoro(); break;
      case 'g': e.preventDefault(); toggleGeo(); break;
      case 'f': e.preventDefault(); openSR(); break;
    }
  }
  if (e.key === '?' && !e.ctrlKey) {
    document.getElementById('kb-modal')?.classList.toggle('show');
  }
  if (e.key === 'Escape') {
    document.getElementById('kb-modal')?.classList.remove('show');
    document.getElementById('sr-modal').style.display = 'none';
    document.getElementById('forgot-modal').style.display = 'none';
    document.getElementById('share-modal').style.display = 'none';
  }
});

// ─── PWA SERVICE WORKER ───────────────────────────────
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Register inline service worker for offline capability
    const swCode = `
const CACHE = 'lumina-v9';
const ASSETS = ['/'];
self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS))));
self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('/')))));
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).catch(() => {});
  });
}

// ─── PATCH enterDashboard ─────────────────────────────
const _v9PrevEnter = window.enterDashboard;
window.enterDashboard = function() {
  if (_v9PrevEnter) _v9PrevEnter();
  loadExams();
  loadChatHistory();
  loadPapers();
  renderLeaderboard();
  // Restore font size
  try {
    const fs = localStorage.getItem('lumina_fontsize');
    if (fs) { fontSize = parseInt(fs); document.documentElement.style.fontSize = fs + '%'; const el = document.getElementById('fs-display'); if(el) el.textContent = fs + '%'; }
  } catch(e) {}
  // Restore language
  try { const l = localStorage.getItem('lumina_lang'); if(l==='cy') setLanguage('cy'); } catch(e) {}
};

// ─── PATCH showDash ───────────────────────────────────
const _v9PrevShowDash = window.showDash;
window.showDash = function(sub) {
  if (_v9PrevShowDash) _v9PrevShowDash(sub);
  const newPages = ['essay','exams','video','papers','glossary','history','leaderboard'];
  newPages.forEach(p => {
    const sp = document.getElementById('sp-'+p);
    if (sp) sp.classList.toggle('active', p === sub);
    const si = document.getElementById('si-'+p);
    if (si) si.classList.toggle('active', p === sub);
  });
  if (sub === 'leaderboard') renderLeaderboard();
  if (sub === 'history') renderHistory();
  if (sub === 'papers') renderPapers();
  if (sub === 'exams') renderExams();
};

// ─── PATCH tutor send to auto-save history ────────────
const _v9TutorSend = window.sendTutor;
window.sendTutor = function() {
  const input = document.getElementById('tutor-input');
  if (input && input.value.trim()) {
    const msg = input.value.trim();
    setTimeout(() => saveChatToHistory(state.subject || 'General', msg.slice(0,60), 'AI response saved'), 3000);
  }
  if (_v9TutorSend) _v9TutorSend();
};

// Zero all stats on first login for new users
const _v9PrevLogin = window.handleLogin;
window.handleLogin = function() {
  if (_v9PrevLogin) _v9PrevLogin();
  // Ensure stats display as zero for new users
  const u = state.user;
  if (u && (u.questions === undefined || u.questions === 847)) {
    u.questions = 0; u.accuracy = 0; u.streak = 0; u.topics = 0; u.xp = 0; u.level = 1;
    try { localStorage.setItem('lumina_user', JSON.stringify(u)); } catch(e) {}
  }
};

console.log('✦ Lumina AI v9 loaded — all features active');
</script>
